<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>支持触摸拖动的 TouchDelegate - l0neman 的博客</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="l0neman 的博客"><meta name="msapplication-TileImage" content="/img/avatar.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="l0neman 的博客"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="需求最近有一个小需求，就是在界面上有一个预览图片的区域，这个区域用户可以双击缩放图片、双指自由缩放图片、触摸图片进行移动，对图片的局部区域进行查看，像这样：  这个功能可以使用 github 中的开源库 PhotoView 实现，地址：https:&amp;#x2F;&amp;#x2F;github.com&amp;#x2F;Baseflow&amp;#x2F;PhotoView 同时另一个条件是当前这个图像预览区域较小，不像上图这样预览区域比较大，大概是 4 分之"><meta property="og:type" content="blog"><meta property="og:title" content="支持触摸拖动的 TouchDelegate"><meta property="og:url" content="https://l0neman.github.io/2021/06/30/%E6%94%AF%E6%8C%81%E8%A7%A6%E6%91%B8%E6%8B%96%E5%8A%A8%E7%9A%84-touchdelegate/"><meta property="og:site_name" content="l0neman 的博客"><meta property="og:description" content="需求最近有一个小需求，就是在界面上有一个预览图片的区域，这个区域用户可以双击缩放图片、双指自由缩放图片、触摸图片进行移动，对图片的局部区域进行查看，像这样：  这个功能可以使用 github 中的开源库 PhotoView 实现，地址：https:&amp;#x2F;&amp;#x2F;github.com&amp;#x2F;Baseflow&amp;#x2F;PhotoView 同时另一个条件是当前这个图像预览区域较小，不像上图这样预览区域比较大，大概是 4 分之"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://l0neman.github.io/2021/06/30/%E6%94%AF%E6%8C%81%E8%A7%A6%E6%91%B8%E6%8B%96%E5%8A%A8%E7%9A%84-touchdelegate/1.gif"><meta property="og:image" content="https://l0neman.github.io/2021/06/30/%E6%94%AF%E6%8C%81%E8%A7%A6%E6%91%B8%E6%8B%96%E5%8A%A8%E7%9A%84-touchdelegate/0.gif"><meta property="og:image" content="https://l0neman.github.io/2021/06/30/%E6%94%AF%E6%8C%81%E8%A7%A6%E6%91%B8%E6%8B%96%E5%8A%A8%E7%9A%84-touchdelegate/2.gif"><meta property="article:published_time" content="2021-06-29T16:45:50.000Z"><meta property="article:modified_time" content="2021-06-29T16:45:50.000Z"><meta property="article:author" content="l0neman"><meta property="article:tag" content="Android"><meta property="article:tag" content="Touch"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="1.gif"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://l0neman.github.io/2021/06/30/%E6%94%AF%E6%8C%81%E8%A7%A6%E6%91%B8%E6%8B%96%E5%8A%A8%E7%9A%84-touchdelegate/"},"headline":"支持触摸拖动的 TouchDelegate","image":["https://l0neman.github.io/2021/06/30/%E6%94%AF%E6%8C%81%E8%A7%A6%E6%91%B8%E6%8B%96%E5%8A%A8%E7%9A%84-touchdelegate/1.gif","https://l0neman.github.io/2021/06/30/%E6%94%AF%E6%8C%81%E8%A7%A6%E6%91%B8%E6%8B%96%E5%8A%A8%E7%9A%84-touchdelegate/0.gif","https://l0neman.github.io/2021/06/30/%E6%94%AF%E6%8C%81%E8%A7%A6%E6%91%B8%E6%8B%96%E5%8A%A8%E7%9A%84-touchdelegate/2.gif"],"datePublished":"2021-06-29T16:45:50.000Z","dateModified":"2021-06-29T16:45:50.000Z","author":{"@type":"Person","name":"l0neman"},"publisher":{"@type":"Organization","name":"l0neman 的博客","logo":{"@type":"ImageObject","url":"https://l0neman.github.io/img/logo.png"}},"description":"需求最近有一个小需求，就是在界面上有一个预览图片的区域，这个区域用户可以双击缩放图片、双指自由缩放图片、触摸图片进行移动，对图片的局部区域进行查看，像这样：  这个功能可以使用 github 中的开源库 PhotoView 实现，地址：https:&#x2F;&#x2F;github.com&#x2F;Baseflow&#x2F;PhotoView 同时另一个条件是当前这个图像预览区域较小，不像上图这样预览区域比较大，大概是 4 分之"}</script><link rel="canonical" href="https://l0neman.github.io/2021/06/30/%E6%94%AF%E6%8C%81%E8%A7%A6%E6%91%B8%E6%8B%96%E5%8A%A8%E7%9A%84-touchdelegate/"><link rel="icon" href="/img/avatar.png"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.15.2/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?1727d76e0a823184efc8776f32a916a9";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="l0neman 的博客" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/l0neman"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-three-quarters"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-29T16:45:50.000Z" title="2021/6/30 上午12:45:50">2021-06-30</time>发表</span><span class="level-item"><time dateTime="2021-06-29T16:45:50.000Z" title="2021/6/30 上午12:45:50">2021-06-30</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/android-%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/">Android 应用开发</a></span><span class="level-item">28 分钟读完 (大约4217个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">支持触摸拖动的 TouchDelegate</h1><div class="content"><h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>最近有一个小需求，就是在界面上有一个预览图片的区域，这个区域用户可以双击缩放图片、双指自由缩放图片、触摸图片进行移动，对图片的局部区域进行查看，像这样：</p>
<p><img src="1.gif"></p>
<p>这个功能可以使用 github 中的开源库 PhotoView 实现，地址：<a target="_blank" rel="noopener" href="https://github.com/Baseflow/PhotoView">https://github.com/Baseflow/PhotoView</a></p>
<p>同时另一个条件是当前这个图像预览区域较小，不像上图这样预览区域比较大，大概是 4 分之 1 左右，如果直接使用 PhotoView 设置图片，那么用户体验可能较差，因为图像展示区域较小，难以进行自由的图像移动预览操作，所以这个需求就是：扩大触摸区域，让用户在图像显示区域的外侧也可以自由的对图像进行移动预览操作。如下，白色区域是 PhotoView 的父控件的区域，用户触摸和双击这里时，可对图像进行预览操作：</p>
<span id="more"></span>
<p><img src="0.gif"></p>
<p>先把 PhotoView 放置在布局中，然后设置一张图片，PhotoView 本身会支持图片的双击和双指缩放与移动预览，如果要实现上述的需求，当时想到了两种解决方案：</p>
<ol>
<li>将 PhotoView（图像预览控件）的父控件的触摸事件传递给 PhotoView，那么用户触摸在父控件上时，PhotoView 将会接收到触摸事件，从而控制内部图像的缩放和移动；</li>
<li>先将 PhotoView 本身尺寸变大，填满白色区域，再想办法将图片显示区域限制到需要的大小，需要手动使用代码调整图片显示到限制区域</li>
</ol>
<p>显然第二种方法是需要对 PhotoView 控件进行额外处理和调整，与 PhotoView 紧密相连，第一种方法只需要将触摸事件传递给 PhotoView 即可，那么第一种方法更灵活和通用，所以优先选择第一种方案进行处理</p>
<p>采取第一种方案，通常可以自定义一个 ViewGroup，将它作为 PhotoView 的父控件，并重写它的 <code>dispatchTouchEvent</code> 方法，将事件全部传递给 PhotoView 处理。但这种方法不够灵活，因为需要创建一个特定的 ViewGroup 类型。那么还有没有其他的方法？发现 Android 提供了一个 <code>TouchDelegate</code> 的类，使用它可以扩大一个 View 的触摸区域，听起来挺符合当前需求的场景，那么计划使用 TouchDelegate 来实现这个需求。</p>
<p>首先看一下 TouchDelegae 的基本用法</p>
<h1 id="TouchDelegate-用法"><a href="#TouchDelegate-用法" class="headerlink" title="TouchDelegate 用法"></a>TouchDelegate 用法</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">expandViewTouchBounds</span><span class="params">(<span class="keyword">final</span> View view, <span class="keyword">final</span> View parent)</span> </span>&#123;</span><br><span class="line">    Rect bounds = <span class="keyword">new</span> Rect();</span><br><span class="line">    bounds.left = <span class="number">0</span>;</span><br><span class="line">    bounds.top = <span class="number">0</span>;</span><br><span class="line">    bounds.right = parent.getWidth();</span><br><span class="line">    bounds.bottom = parent.getHeight();</span><br><span class="line"></span><br><span class="line">    TouchDelegate touchDelegate = <span class="keyword">new</span> TouchDelegate(bounds, view);</span><br><span class="line">    parent.setTouchDelegate(touchDelegate);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 扩展 photoView 的触摸区域到 parent 上</span></span><br><span class="line">expandViewTouchBounds(photoView, parent);</span><br></pre></td></tr></table></figure>

<p>使用方法很简单，首先创建一个 <code>TouchDelegate</code> 对象，然后设置给父控件，其中 <code>bounds</code> 为在父控件中扩展的触摸区域，坐标相对于父控件，示例中设置为整个父控件的区域。</p>
<h1 id="Bug"><a href="#Bug" class="headerlink" title="Bug"></a>Bug</h1><p>本以为这样就可以了，通过测试发现在 PhotoView 外部的区域用单个手指触摸移动，图像预览区域根本无法跟着移动，但是却可以响应双击和双指的缩放事件。难道是用法的不对。</p>
<p>通过查看 TouchDelegate 的源代码发现，其实 TouchDelegate 是无法支持移动的触摸事件的响应的，只能支持 click 事件。关键代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Forward touch events to the delegate view if the event is within the bounds</span></span><br><span class="line"><span class="comment"> * specified in the constructor.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> event The touch event to forward</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> True if the event was consumed by the delegate, false otherwise.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(<span class="meta">@NonNull</span> MotionEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x = (<span class="keyword">int</span>)event.getX();</span><br><span class="line">    <span class="keyword">int</span> y = (<span class="keyword">int</span>)event.getY();</span><br><span class="line">    <span class="keyword">boolean</span> sendToDelegate = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> hit = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">boolean</span> handled = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (event.getActionMasked()) &#123;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">            mDelegateTargeted = mBounds.contains(x, y);</span><br><span class="line">            sendToDelegate = mDelegateTargeted;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_POINTER_DOWN:</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_POINTER_UP:</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">            sendToDelegate = mDelegateTargeted;</span><br><span class="line">            <span class="keyword">if</span> (sendToDelegate) &#123;</span><br><span class="line">                Rect slopBounds = mSlopBounds;</span><br><span class="line">                <span class="keyword">if</span> (!slopBounds.contains(x, y)) &#123;</span><br><span class="line">                    hit = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</span><br><span class="line">            sendToDelegate = mDelegateTargeted;</span><br><span class="line">            mDelegateTargeted = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (sendToDelegate) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hit) &#123;</span><br><span class="line">            <span class="comment">// Offset event coordinates to be inside the target view</span></span><br><span class="line">            event.setLocation(mDelegateView.getWidth() / <span class="number">2</span>, mDelegateView.getHeight() / <span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Offset event coordinates to be outside the target view (in case it does</span></span><br><span class="line">            <span class="comment">// something like tracking pressed state)</span></span><br><span class="line">            <span class="keyword">int</span> slop = mSlop;</span><br><span class="line">            event.setLocation(-(slop * <span class="number">2</span>), -(slop * <span class="number">2</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        handled = mDelegateView.dispatchTouchEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> handled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>核心逻辑并不复杂，其中 <code>mDelegateView</code> 为被代理处理事件的 View，也就是 PhotoView。 </p>
<p>主要关注下面 <code>if (sendToDelegate) &#123; . . . &#125;</code> 代码块中的逻辑，当触摸事件发生点的坐标落在 <code>bounds</code> 内，那么 <code>hit</code> 为 <code>true</code>，执行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">event.setLocation(mDelegateView.getWidth() / <span class="number">2</span>, mDelegateView.getHeight() / <span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p><code>setLocation</code> 的含义是重新设置 <code>MotionEvent</code> 的 x，y 坐标，也就是 <code>getX()</code> 和 <code>getY()</code> 的返回值。</p>
<p>那么从这里看出来，无论触摸事件的 <code>action</code> 是什么，都会将触摸坐标设置为被代理 View 的中心点，自然用手指触摸 View 外部区域移动时图像并不会跟着移动了。不过双击事件还是没有问题的，可正常检测到。</p>
<p>按照需求，肯定需要支持触摸拖动预览图片，结合目前情况，只能自己修复 TouchDelegate 中的事件传递逻辑了。父控件比 PhotoView 的区域大，当用户触摸到父控件区域内时，应该怎样处理？通常一个简单的规则就是按比例映射，按照触摸点 x、y 坐标在父控件内所占父控件尺寸的比例，设置在相对于子 View 区域相同的宽高比例的坐标上。</p>
<h1 id="改进-TouchDelegate"><a href="#改进-TouchDelegate" class="headerlink" title="改进 TouchDelegate"></a>改进 TouchDelegate</h1><p>根据分析，那么需要改进 <code>TouchDelegate</code> 原始处理逻辑中将坐标固定的问题，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(<span class="meta">@NonNull</span> MotionEvent event)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> x = (<span class="keyword">int</span>)event.getX();</span><br><span class="line">  <span class="keyword">int</span> y = (<span class="keyword">int</span>)event.getY();</span><br><span class="line">  <span class="keyword">boolean</span> sendToDelegate = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">boolean</span> hit = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">boolean</span> handled = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (event.getActionMasked()) &#123;</span><br><span class="line">    <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">      mDelegateTargeted = mBounds.contains(x, y);</span><br><span class="line">      sendToDelegate = mDelegateTargeted;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> MotionEvent.ACTION_POINTER_DOWN:</span><br><span class="line">    <span class="keyword">case</span> MotionEvent.ACTION_POINTER_UP:</span><br><span class="line">    <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">    <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">      sendToDelegate = mDelegateTargeted;</span><br><span class="line">      <span class="keyword">if</span> (sendToDelegate) &#123;</span><br><span class="line">        Rect slopBounds = mSlopBounds;</span><br><span class="line">        <span class="keyword">if</span> (!slopBounds.contains(x, y)) &#123;</span><br><span class="line">            hit = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</span><br><span class="line">      sendToDelegate = mDelegateTargeted;</span><br><span class="line">      mDelegateTargeted = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (sendToDelegate) &#123;</span><br><span class="line">    <span class="keyword">if</span> (hit) &#123;</span><br><span class="line">222<span class="comment">// 按照父控件比例修正触摸点坐标</span></span><br><span class="line">      <span class="keyword">float</span> newX = x * <span class="number">1F</span> / mBounds.width() * mDelegateView.getWidth();</span><br><span class="line">      <span class="keyword">float</span> newY = y * <span class="number">1F</span> / mBounds.height() * mDelegateView.getHeight();</span><br><span class="line">      event.setLocation(newX, newY);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">int</span> slop = mSlop;</span><br><span class="line">      event.setLocation(-(slop * <span class="number">2</span>), -(slop * <span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    handled = mDelegateView.dispatchTouchEvent(event);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> handled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="新的-Bug"><a href="#新的-Bug" class="headerlink" title="新的 Bug"></a>新的 Bug</h1><p>本以为没问题了，然而再次测试，发现单个手指触摸在 PhotoView 区域外，也就是父控件区域内时，图像也可以正常移动预览了。但是经过多次测试，发现存在有一个瑕疵，可以说就是一个 Bug。</p>
<p>问题描述：</p>
<p>首先在父控件区域按下一个手指，然后再按下第二个手指，此时在第二个手指不放开的情况下，抬起第一个手指时，图像会出现跳跃现象，而在 PhotoView 区域内进行这样的操作就不会出现跳跃的问题，那么说明上面的触摸区域扩大的逻辑处理还是存在问题的。</p>
<p>如下图，在第二个手指不放开的情况下，第一个手指抬起、放下、抬起、放下会触发图像的跳跃：</p>
<p><img src="2.gif"></p>
<p>通过现象进行猜测，显然是两次触摸坐标之间的差值过大，导致 PhotoView 认为用户瞬间拖动了很长一段距离，图像跟着瞬间移动，就会出现跳跃现象</p>
<p>通过调试以及日志打印经过父控件的触摸事件的坐标，包括上面修复坐标的代码 <code>event.setLocation(newX, newY);</code> 发现坐标转换并没有问题，那么问题处在哪里？由于当时对于多点触控事件处理并不熟悉，而上面出现的 Bug 显然和多指触摸相关，结合上面观察到的现象：使用同样的流程在 PhotoView 内部就不会出现这种问题，而在父控件的区域操作就会出现，那么开始对 PhotoView 内部的接收到触摸事件的逻辑进行调试，通过对比在父控件和在 PhotoView 中的事件处理，最终发现了问题。</p>
<p>首先说一下像这种手指触摸控制图片移动时的场景在多指触摸时的典型处理方法。</p>
<h1 id="图片移动预览典型处理方法"><a href="#图片移动预览典型处理方法" class="headerlink" title="图片移动预览典型处理方法"></a>图片移动预览典型处理方法</h1><p>对于多点触摸的情况，<code>onTouchEvent</code> 方法接收到的触摸事件按照操作顺序是这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 第一个手指按下，触发 `ACTION_DOWN` 事件</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 第一个手指移动，触发 `ACTION_MOVE` 事件</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 第二个手指按下，触发 `ACTION_POINTER_DOWN` 事件，此时处于两个手指都按下的状态，可用 `event.getActionIndex()` 方法获得抬起手指触摸点的索引</span><br><span class="line">（继续按下手指，都将触发 `ACTION_POINTER_DOWN` 事件）</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> 任意一个手指移动，触发 `ACTION_MOVE` 事件</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span> 任意一个手指抬起，触发 `ACTION_POINTER_UP` 事件，此时可用 `event.getActionIndex()` 方法获得抬起手指触摸点的索引</span><br><span class="line">（只要屏幕上抬起的不是最后一个手指，那么就会触发 `ACTION_POINTER_UP` 事件）</span><br><span class="line"></span><br><span class="line"><span class="number">6.</span> 此时屏幕上只剩下一个手指，抬起触发将 `ACTION_UP` 事件</span><br></pre></td></tr></table></figure>

<p>在处理手指触摸图片内容控制移动时，首先认为活动的手指（也就是负责移动图像内容的手指）只有一个，当第一个手指按下时那么第一个手指就是活动手指，可以使用一个变量进行记录它的 id：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (event.getActionMasked()) &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">case</span> MotionEvent.ACTION_DOWN: &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> pointerIndex = event.getActionIndex();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">float</span> x = event.getX(pointerIndex);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">float</span> y = event.getY(pointerIndex);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录最后触摸坐标，用来计算图片移动偏移</span></span><br><span class="line">    mLastTouchX = x;</span><br><span class="line">    mLastTouchY = y;</span><br><span class="line"></span><br><span class="line">22<span class="comment">// 记录活动手指 id</span></span><br><span class="line">    mActivePointerId = event.getPointerId(pointerIndex);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">super</span>.onTouchEvent(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当手指移动时，根据活动手指的坐标和最后触摸点的差计算出移动的偏移，然后对图片进行移动：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">switch</span> (event.getActionMasked()) &#123;</span><br><span class="line">  <span class="keyword">case</span> MotionEvent.ACTION_MOVE: &#123;</span><br><span class="line">22<span class="comment">// 根据活动手指 id 获取触摸点索引</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> pointerIndex = event.findPointerIndex(mActivePointerId);</span><br><span class="line">22</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">float</span> x = event.getX(pointerIndex);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">float</span> y = event.getY(pointerIndex);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算图片拖动偏移</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">float</span> dx = x - mLastTouchX;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">float</span> dy = y - mLastTouchY;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// todo: 使用 dx 和 dy 对图片进行移动</span></span><br><span class="line"></span><br><span class="line">    mLastTouchX = x;</span><br><span class="line">    mLastTouchY = y;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">2...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">super</span>.onTouchEvent(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时虽然活动手指只有一个，但是触摸的手指可能是多个，不过我们只关心活动手指，需要关心一种特殊情况，就是当活动手指离开屏幕的时候，此时屏幕上还有多个手指，这种情况怎么处理？一种简单的情况就是把下一根手指作为活动手指，当屏幕上抬起的不是最后一个手指，那么就会触发 <code>ACTION_POINTER_UP</code> 事件，可以在这里进行判断处理，如果活动手指抬起，那么将活动手指的重任交给还在屏幕上的另一个手指：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">switch</span> (event.getActionMasked()) &#123;</span><br><span class="line">  <span class="keyword">case</span> MotionEvent.ACTION_POINTER_UP: &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> pointerIndex = event.getActionIndex();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> pointerId = event.getPointerId(pointerIndex);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果抬起的手指是活动手指</span></span><br><span class="line">    <span class="keyword">if</span> (pointerId == mActivePointerId) &#123;</span><br><span class="line">        <span class="comment">// 交接给下一个手指</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> newPointerIndex = pointerIndex == <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 更新活动手指 id 和坐标</span></span><br><span class="line">        mLastTouchX = event.getX(newPointerIndex);</span><br><span class="line">        mLastTouchY = event.getY(newPointerIndex);</span><br><span class="line">        mActivePointerId = event.getPointerId(newPointerIndex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">super</span>.onTouchEvent(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="分析-Bug-原因"><a href="#分析-Bug-原因" class="headerlink" title="分析 Bug 原因"></a>分析 Bug 原因</h1><p>了解了图片处理规则之后，可以对上面的 Bug 进行分析了。</p>
<p>其实 PhotoView 也是这样处理图片移动的，如果按照正常逻辑，当第一个手指按下时，它是活动手指，正常记录坐标，第二个手指按下时，忽略它的坐标，当第一个手指抬起时，这时触发 <code>ACTION_POINTER_UP</code> 事件，需要转换活动手指，将最后一次触摸的坐标设置为第二个还未抬起的手指最后坐标，活动手指也设置为第二个手指的 id，此时当第二个手指开始移动时，那么当前手指坐标与最后坐标做差获得图片移动的值，对图片进行移动。正常流程不会出现跳跃的问题，始终跟随手指移动。</p>
<p>而对于触摸在父控件出现 Bug 的情况，通过调试和日志发现在最后处理活动手指的转换时出现了坐标的转换失误，就在处理 <code>ACTION_POINTER_UP</code> 事件的逻辑中。当多个手指同时触摸在屏幕上时，<code>MotionEvent</code> 这个对象中包含所有手指的坐标信息，两个手指时，它包含 <code>x0</code>、<code>y0</code>、<code>x1</code>、<code>y1</code>，然而 <code>event.setLocation</code> 这个方法只能改变 <code>x0</code>、<code>x1</code> 的坐标，<code>x1</code> 和 <code>y1</code> 即第二个即将变为活动状态的手指坐标则没有经过处理，它还是原始父控件的坐标，那么 <code>mLastTouchX</code> 和 <code>mLastToachX</code> 被赋予了错误的坐标值。此时活动手指的工作交接已完成，屏幕上只剩下一个手指，就是之前的第二个手指，当它开始移动时，它的坐标将被存储在 <code>x0</code> 和 <code>y0</code> 中，此时能够获取正确的值，再与还未转换的 <code>mLastTouchX</code> 和 <code>mLastToachX</code> 做差值，计算出一个较大的错误的偏移，导致图片发生跳跃，这就是这个 Bug 的原因。</p>
<p>总结就是 <code>event.setLocation</code> 方法只能改变屏幕上第一个手指的坐标，而其它手指坐标无法改变。</p>
<h1 id="完善-TouchDelegate"><a href="#完善-TouchDelegate" class="headerlink" title="完善 TouchDelegate"></a>完善 TouchDelegate</h1><p>分析完了问题，那么就可以开始修复了，既然 <code>setLocation</code> 无法改变所有手指坐标，那么需要找到其他方法，在 <code>MotionEvent</code> 的 API 中浏览了一遍，貌似没有直接修改其他手指的 API，但是 <code>MotionEvent</code> 提供了 <code>obtain</code> 方法，它可以获得一个新的 <code>MotionEvent</code> 对象，从参数上看，可以生成多个手指的坐标信息，经过测试，完美解决了问题，关键代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">event = MotionEvent.obtain(</span><br><span class="line">    System.currentTimeMillis(),</span><br><span class="line">    System.currentTimeMillis(),</span><br><span class="line">    event.getAction(),</span><br><span class="line">    event.getPointerCount(),</span><br><span class="line">    getPointerProperties(event),</span><br><span class="line">    fixPointerCoords(event),</span><br><span class="line">    event.getMetaState(),</span><br><span class="line">    event.getButtonState(),</span><br><span class="line">    event.getXPrecision(),</span><br><span class="line">    event.getYPrecision(),</span><br><span class="line">    event.getDeviceId(),</span><br><span class="line">    event.getEdgeFlags(),</span><br><span class="line">    event.getSource(),</span><br><span class="line">    event.getFlags()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> MotionEvent.PointerProperties[] getPointerProperties(MotionEvent event) &#123;</span><br><span class="line">  <span class="keyword">int</span> pointerCount = event.getPointerCount();</span><br><span class="line">  MotionEvent.PointerProperties[] properties = <span class="keyword">new</span> MotionEvent.PointerProperties[pointerCount];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pointerCount; i++) &#123;</span><br><span class="line">    MotionEvent.PointerProperties pointerProperties = <span class="keyword">new</span> MotionEvent.PointerProperties();</span><br><span class="line">    event.getPointerProperties(i, pointerProperties);</span><br><span class="line">    properties[i] = pointerProperties;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> properties;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> MotionEvent.PointerCoords[] fixPointerCoords(MotionEvent event) &#123;</span><br><span class="line">  <span class="keyword">int</span> pointerCount = event.getPointerCount();</span><br><span class="line">  MotionEvent.PointerCoords[] pointerCoords = <span class="keyword">new</span> MotionEvent.PointerCoords[pointerCount];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pointerCount; i++) &#123;</span><br><span class="line">    MotionEvent.PointerCoords coords = <span class="keyword">new</span> MotionEvent.PointerCoords();</span><br><span class="line">    event.getPointerCoords(i, coords);</span><br><span class="line">    coords.x = coords.x * <span class="number">1F</span> / mBounds.width() * mDelegateView.getWidth();</span><br><span class="line">    coords.y = coords.y * <span class="number">1F</span> / mBounds.width() * mDelegateView.getWidth();</span><br><span class="line">    pointerCoords[i] = coords;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> pointerCoords;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="完整源码"><a href="#完整源码" class="headerlink" title="完整源码"></a>完整源码</h1><p>下面是修复过的 TouchDelegate 完整源码，可直接拿来用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FixTouchDelegate</span> <span class="keyword">extends</span> <span class="title">TouchDelegate</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> View mDelegateView;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Rect mBounds;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Rect mSlopBounds;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> mDelegateTargeted;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mSlop;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">FixTouchDelegate</span><span class="params">(Rect bounds, View delegateView)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(bounds, delegateView);</span><br><span class="line">    mBounds = bounds;</span><br><span class="line"></span><br><span class="line">    mSlop = ViewConfiguration.get(delegateView.getContext()).getScaledTouchSlop();</span><br><span class="line">    mSlopBounds = <span class="keyword">new</span> Rect(bounds);</span><br><span class="line">    mSlopBounds.inset(-mSlop, -mSlop);</span><br><span class="line">    mDelegateView = delegateView;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x = (<span class="keyword">int</span>) event.getX();</span><br><span class="line">    <span class="keyword">int</span> y = (<span class="keyword">int</span>) event.getY();</span><br><span class="line">    <span class="keyword">boolean</span> sendToDelegate = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> hit = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">boolean</span> handled = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (event.getActionMasked()) &#123;</span><br><span class="line">      <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">        mDelegateTargeted = mBounds.contains(x, y);</span><br><span class="line">        sendToDelegate = mDelegateTargeted;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> MotionEvent.ACTION_POINTER_DOWN:</span><br><span class="line">      <span class="keyword">case</span> MotionEvent.ACTION_POINTER_UP:</span><br><span class="line">      <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">      <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">        sendToDelegate = mDelegateTargeted;</span><br><span class="line">        <span class="keyword">if</span> (sendToDelegate) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mSlopBounds.contains(x, y)) &#123;</span><br><span class="line">                hit = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</span><br><span class="line">        sendToDelegate = mDelegateTargeted;</span><br><span class="line">        mDelegateTargeted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (sendToDelegate) &#123;</span><br><span class="line">        MotionEvent obtain = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (hit) &#123;</span><br><span class="line">          <span class="comment">// Offset event coordinates to be inside the target view</span></span><br><span class="line">          <span class="comment">// event.setLocation(mDelegateView.getWidth() / 2, mDelegateView.getHeight() / 2);</span></span><br><span class="line">          obtain = MotionEvent.obtain(</span><br><span class="line">              System.currentTimeMillis(),</span><br><span class="line">              System.currentTimeMillis(),</span><br><span class="line">              event.getAction(),</span><br><span class="line">              event.getPointerCount(),</span><br><span class="line">              getPointerProperties(event),</span><br><span class="line">              fixPointerCoords(event),</span><br><span class="line">              event.getMetaState(),</span><br><span class="line">              event.getButtonState(),</span><br><span class="line">              event.getXPrecision(),</span><br><span class="line">              event.getYPrecision(),</span><br><span class="line">              event.getDeviceId(),</span><br><span class="line">              event.getEdgeFlags(),</span><br><span class="line">              event.getSource(),</span><br><span class="line">              event.getFlags()</span><br><span class="line">          );</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// Offset event coordinates to be outside the target view (in case it does</span></span><br><span class="line">          <span class="comment">// something like tracking pressed state)</span></span><br><span class="line">          <span class="keyword">int</span> slop = mSlop;</span><br><span class="line">          event.setLocation(-(slop * <span class="number">2</span>), -(slop * <span class="number">2</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (obtain != <span class="keyword">null</span>) &#123;</span><br><span class="line">          handled = mDelegateView.dispatchTouchEvent(obtain);</span><br><span class="line">          obtain.recycle();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          handled = mDelegateView.dispatchTouchEvent(event);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> handled;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> MotionEvent.PointerProperties[] getPointerProperties(MotionEvent event) &#123;</span><br><span class="line">    <span class="keyword">int</span> pointerCount = event.getPointerCount();</span><br><span class="line">    MotionEvent.PointerProperties[] properties = <span class="keyword">new</span> MotionEvent.PointerProperties[pointerCount];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pointerCount; i++) &#123;</span><br><span class="line">      MotionEvent.PointerProperties pointerProperties = <span class="keyword">new</span> MotionEvent.PointerProperties();</span><br><span class="line">      event.getPointerProperties(i, pointerProperties);</span><br><span class="line">      properties[i] = pointerProperties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> properties;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> MotionEvent.PointerCoords[] fixPointerCoords(MotionEvent event) &#123;</span><br><span class="line">    <span class="keyword">int</span> pointerCount = event.getPointerCount();</span><br><span class="line">    MotionEvent.PointerCoords[] pointerCoords = <span class="keyword">new</span> MotionEvent.PointerCoords[pointerCount];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pointerCount; i++) &#123;</span><br><span class="line">      MotionEvent.PointerCoords coords = <span class="keyword">new</span> MotionEvent.PointerCoords();</span><br><span class="line">      event.getPointerCoords(i, coords);</span><br><span class="line">      coords.x = coords.x * <span class="number">1F</span> / mBounds.width() * mDelegateView.getWidth();</span><br><span class="line">      coords.y = coords.y * <span class="number">1F</span> / mBounds.width() * mDelegateView.getWidth();</span><br><span class="line">      pointerCoords[i] = coords;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pointerCoords;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">expandViewTouchDelegate</span><span class="params">(<span class="keyword">final</span> View view, <span class="keyword">final</span> View parent)</span> </span>&#123;</span><br><span class="line">  view.post(() -&gt; &#123;</span><br><span class="line">    Rect bounds = <span class="keyword">new</span> Rect();</span><br><span class="line">    view.setEnabled(<span class="keyword">true</span>);</span><br><span class="line">    ((ViewGroup) view.getParent()).getHitRect(bounds);</span><br><span class="line"></span><br><span class="line">    bounds.left = <span class="number">0</span>;</span><br><span class="line">    bounds.top = <span class="number">0</span>;</span><br><span class="line">    bounds.right = parent.getWidth();</span><br><span class="line">    bounds.bottom = parent.getHeight();</span><br><span class="line"></span><br><span class="line">    TouchDelegate touchDelegate = <span class="keyword">new</span> FixTouchDelegate(bounds, view);</span><br><span class="line"></span><br><span class="line">    parent.setTouchDelegate(touchDelegate);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Example-地址"><a href="#Example-地址" class="headerlink" title="Example 地址"></a>Example 地址</h1><p><a target="_blank" rel="noopener" href="https://github.com/l0neman/FixTouchDelegate">https://github.com/l0neman/FixTouchDelegate</a></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/gestures/scale?hl=zh-cn">https://developer.android.google.cn/training/gestures/scale?hl=zh-cn</a></li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>支持触摸拖动的 TouchDelegate</p><p><a href="https://l0neman.github.io/2021/06/30/支持触摸拖动的-touchdelegate/">https://l0neman.github.io/2021/06/30/支持触摸拖动的-touchdelegate/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>l0neman</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-06-30</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-06-30</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/android/">Android</a><a class="link-muted mr-2" rel="tag" href="/tags/touch/">Touch</a></div><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5f0f12c19a2af379" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/qrcode/alipay.jpg" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/qrcode/wxpay.jpg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/04/21/gdb-arm-%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"><span class="level-item">GDB ARM 交叉编译环境搭建</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><script src="https://utteranc.es/client.js" repo="l0neman/l0neman.github.io" issue-term="pathname" label="comment" theme="github-light" crossorigin="anonymous" async></script></div></div></div><!--!--><div class="column column-right  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#需求"><span class="level-left"><span class="level-item">1</span><span class="level-item">需求</span></span></a></li><li><a class="level is-mobile" href="#TouchDelegate-用法"><span class="level-left"><span class="level-item">2</span><span class="level-item">TouchDelegate 用法</span></span></a></li><li><a class="level is-mobile" href="#Bug"><span class="level-left"><span class="level-item">3</span><span class="level-item">Bug</span></span></a></li><li><a class="level is-mobile" href="#改进-TouchDelegate"><span class="level-left"><span class="level-item">4</span><span class="level-item">改进 TouchDelegate</span></span></a></li><li><a class="level is-mobile" href="#新的-Bug"><span class="level-left"><span class="level-item">5</span><span class="level-item">新的 Bug</span></span></a></li><li><a class="level is-mobile" href="#图片移动预览典型处理方法"><span class="level-left"><span class="level-item">6</span><span class="level-item">图片移动预览典型处理方法</span></span></a></li><li><a class="level is-mobile" href="#分析-Bug-原因"><span class="level-left"><span class="level-item">7</span><span class="level-item">分析 Bug 原因</span></span></a></li><li><a class="level is-mobile" href="#完善-TouchDelegate"><span class="level-left"><span class="level-item">8</span><span class="level-item">完善 TouchDelegate</span></span></a></li><li><a class="level is-mobile" href="#完整源码"><span class="level-left"><span class="level-item">9</span><span class="level-item">完整源码</span></span></a></li><li><a class="level is-mobile" href="#Example-地址"><span class="level-left"><span class="level-item">10</span><span class="level-item">Example 地址</span></span></a></li><li><a class="level is-mobile" href="#参考"><span class="level-left"><span class="level-item">11</span><span class="level-item">参考</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/android-%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">Android 实用工具</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/android-%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/"><span class="level-start"><span class="level-item">Android 应用开发</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/android-%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/"><span class="level-start"><span class="level-item">Android 系统原理</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/android-%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/"><span class="level-start"><span class="level-item">Android 逆向工程</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3/"><span class="level-start"><span class="level-item">参考文档</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">实用工具</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/"><span class="level-start"><span class="level-item">编程基础</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-06-29T16:45:50.000Z">2021-06-30</time></p><p class="title"><a href="/2021/06/30/%E6%94%AF%E6%8C%81%E8%A7%A6%E6%91%B8%E6%8B%96%E5%8A%A8%E7%9A%84-touchdelegate/">支持触摸拖动的 TouchDelegate</a></p><p class="categories"><a href="/categories/android-%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/">Android 应用开发</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-21T15:08:15.000Z">2021-04-21</time></p><p class="title"><a href="/2021/04/21/gdb-arm-%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">GDB ARM 交叉编译环境搭建</a></p><p class="categories"><a href="/categories/android-%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/">Android 实用工具</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-21T15:04:39.000Z">2021-04-21</time></p><p class="title"><a href="/2021/04/21/dropbear-android-%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4/">Dropbear Android 安装步骤</a></p><p class="categories"><a href="/categories/android-%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/">Android 实用工具</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-21T14:49:48.000Z">2021-04-21</time></p><p class="title"><a href="/2021/04/21/material-design-%E5%8F%82%E8%80%83/">Material Design 参考</a></p><p class="categories"><a href="/categories/%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3/">参考文档</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-21T10:20:58.000Z">2021-04-21</time></p><p class="title"><a href="/2021/04/21/android-avd-%E4%BD%8D%E7%BD%AE%E4%BF%AE%E6%94%B9/">Android AVD 位置修改</a></p><p class="categories"><a href="/categories/android-%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/">Android 实用工具</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">四月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/02/"><span class="level-start"><span class="level-item">二月 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/arm/"><span class="tag">ARM</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/avd/"><span class="tag">AVD</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/activity/"><span class="tag">Activity</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/android/"><span class="tag">Android</span><span class="tag">23</span></a></div><div class="control"><a class="tags has-addons" href="/tags/assembly/"><span class="tag">Assembly</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/binder/"><span class="tag">Binder</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/classloader/"><span class="tag">ClassLoader</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/computer/"><span class="tag">Computer</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dex/"><span class="tag">Dex</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/elf/"><span class="tag">ELF</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/emulator/"><span class="tag">Emulator</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">Git</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/jni/"><span class="tag">JNI</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/java/"><span class="tag">Java</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/log/"><span class="tag">Log</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/make/"><span class="tag">Make</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/makefile/"><span class="tag">Makefile</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/markdown/"><span class="tag">MarkDown</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/metrial/"><span class="tag">Metrial</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ndk/"><span class="tag">NDK</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/regex/"><span class="tag">Regex</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssh/"><span class="tag">SSH</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/theme/"><span class="tag">Theme</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/touch/"><span class="tag">Touch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/view/"><span class="tag">View</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xposed/"><span class="tag">Xposed</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zygote/"><span class="tag">Zygote</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/aapt/"><span class="tag">aapt</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%83%AD%E4%BF%AE%E5%A4%8D/"><span class="tag">热修复</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%83%AD%E6%9B%B4%E6%96%B0/"><span class="tag">热更新</span><span class="tag">1</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="l0neman 的博客" height="28"></a><p class="is-size-7"><span>&copy; 2021 l0neman</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/l0neman"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>