<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Android zygote 进程启动分析 - l0neman 的博客</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="l0neman 的博客"><meta name="msapplication-TileImage" content="/img/avatar.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="l0neman 的博客"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="前言zygote 进程是 Android 系统中第一个拥有 Java 运行环境的进程，它由用户空间 1 号进程 init 进程通过解析 init.rc 文件创建，从 init 进程 fork 而来。从 zygote（受精卵）这个富含生物意义的名字可以知道，它是一个孵化器。Android 系统中所有运行在 Java 虚拟机中的系统服务以及应用均由 zygote 进程孵化而来。 理解 zygote 进"><meta property="og:type" content="blog"><meta property="og:title" content="Android zygote 进程启动分析"><meta property="og:url" content="https://l0neman.github.io/2020/08/24/android-zygote-%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E5%88%86%E6%9E%90/"><meta property="og:site_name" content="l0neman 的博客"><meta property="og:description" content="前言zygote 进程是 Android 系统中第一个拥有 Java 运行环境的进程，它由用户空间 1 号进程 init 进程通过解析 init.rc 文件创建，从 init 进程 fork 而来。从 zygote（受精卵）这个富含生物意义的名字可以知道，它是一个孵化器。Android 系统中所有运行在 Java 虚拟机中的系统服务以及应用均由 zygote 进程孵化而来。 理解 zygote 进"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://l0neman.github.io/2020/08/24/android-zygote-%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E5%88%86%E6%9E%90/zygote.png"><meta property="article:published_time" content="2020-08-24T12:53:40.000Z"><meta property="article:modified_time" content="2020-08-24T12:53:40.000Z"><meta property="article:author" content="l0neman"><meta property="article:tag" content="Android"><meta property="article:tag" content="Zygote"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="./zygote.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://l0neman.github.io/2020/08/24/android-zygote-%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E5%88%86%E6%9E%90/"},"headline":"Android zygote 进程启动分析","image":["https://l0neman.github.io/2020/08/24/android-zygote-%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E5%88%86%E6%9E%90/zygote.png"],"datePublished":"2020-08-24T12:53:40.000Z","dateModified":"2020-08-24T12:53:40.000Z","author":{"@type":"Person","name":"l0neman"},"publisher":{"@type":"Organization","name":"l0neman 的博客","logo":{"@type":"ImageObject","url":"https://l0neman.github.io/img/logo.png"}},"description":"前言zygote 进程是 Android 系统中第一个拥有 Java 运行环境的进程，它由用户空间 1 号进程 init 进程通过解析 init.rc 文件创建，从 init 进程 fork 而来。从 zygote（受精卵）这个富含生物意义的名字可以知道，它是一个孵化器。Android 系统中所有运行在 Java 虚拟机中的系统服务以及应用均由 zygote 进程孵化而来。 理解 zygote 进"}</script><link rel="canonical" href="https://l0neman.github.io/2020/08/24/android-zygote-%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E5%88%86%E6%9E%90/"><link rel="icon" href="/img/avatar.png"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.15.2/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?1727d76e0a823184efc8776f32a916a9";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="l0neman 的博客" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/l0neman"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-three-quarters"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-08-24T12:53:40.000Z" title="2020/8/24 下午8:53:40">2020-08-24</time>发表</span><span class="level-item"><time dateTime="2020-08-24T12:53:40.000Z" title="2020/8/24 下午8:53:40">2020-08-24</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/android-%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/">Android 系统原理</a></span><span class="level-item">28 分钟读完 (大约4254个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Android zygote 进程启动分析</h1><div class="content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>zygote 进程是 Android 系统中第一个拥有 Java 运行环境的进程，它由用户空间 1 号进程 init 进程通过解析 init.rc 文件创建，从 init 进程 fork 而来。从 zygote（受精卵）这个富含生物意义的名字可以知道，它是一个孵化器。Android 系统中所有运行在 Java 虚拟机中的系统服务以及应用均由 zygote 进程孵化而来。</p>
<p>理解 zygote 进程的启动过程以及所做的工作，将为理解 Java 层系统服务以及所有应用的进程启动流程打下基础。</p>
<span id="more"></span>


<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>zygote 通过克隆（fork）的方式创建子进程，fork 出来的子进程将继承父进程的所有资源，基于这个特性，zygote 进程在启动过程将创建 Java ART 虚拟机，预加载一个 Java 进程需要的所有系统资源，之后子进程被创建后，就可以直接使用这些资源运行了。</p>
<p>自 Android 5.0 系统开始，zygote 不再是一个进程，而是两个进程，一个是 32 位 zygote，负责孵化 32 位进程（为了兼容使用了 armeabi 和 armeabi-v7a 等 32 位架构的本地动态库的应用），另一个是 64 位 zygote 进程，负责孵化 64 位应用进程（可加载 arm64-v8a 等 64 位架构本地库）。</p>
<p>zygote 进程主要做了如下工作：</p>
<ol>
<li>创建虚拟机，加载系统 Java 类以及注册系统类所依赖的 JNI 方法；</li>
<li>预加载应用程序进程所需的 drawable 和 color 资源，准备 WebView 和 OpenGL；</li>
<li>创建 socket 服务端，以便接收和处理创建应用进程的请求；</li>
<li>启动 system_server 服务进程，用于承载整个 framework 层运行的系统服务；</li>
<li>待命以随即处理到来的任务请求。</li>
</ol>
<p>参考相关资料，对 Android 6.0.1 系统中 zygote 进程启动关键流程进行分析。</p>
<h1 id="zygote-进程启动"><a href="#zygote-进程启动" class="headerlink" title="zygote 进程启动"></a>zygote 进程启动</h1><p>zygote 进程由 init 解析 init.rc 文件启动，首先看一下启动 zygote 的 rc 文件内容：</p>
<p>32 位 zygote 启动内容在 init.zygote32.rc 文件中，64 位 zygote 启动内容在 init.zygote64.rc 中：</p>
<p>提示：自 Android 9.0 系统开始，两个 zygote 启动配置放在一个文件中：init.zygote64_32.rc。 </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># init.zygote32.rc</span></span><br><span class="line"></span><br><span class="line">service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server</span><br><span class="line">    class main</span><br><span class="line">    socket zygote stream 660 root system</span><br><span class="line">    onrestart write /sys/android_power/request_state wake</span><br><span class="line">    onrestart write /sys/power/state on</span><br><span class="line">    onrestart restart media</span><br><span class="line">    onrestart restart netd</span><br><span class="line">    writepid /dev/cpuset/foreground/tasks</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># init.zygote64.rc</span></span><br><span class="line"></span><br><span class="line">service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server</span><br><span class="line">    class main</span><br><span class="line">    socket zygote stream 660 root system</span><br><span class="line">    onrestart write /sys/android_power/request_state wake</span><br><span class="line">    onrestart write /sys/power/state on</span><br><span class="line">    onrestart restart media</span><br><span class="line">    onrestart restart netd</span><br><span class="line">    writepid /dev/cpuset/foreground/tasks</span><br></pre></td></tr></table></figure>

<p>两者的唯一区别只在于可执行文件的不同，<code>/system/bin/app_process</code> 和 <code>/system/bin/app_process64</code>。</p>
<p>zygote 将在如下情况下重启：</p>
<ol>
<li>servicemanager 进程死亡（启动配置中包含 <code>onrestart restart zygote</code>）；</li>
<li>surfaceflinger 进程死亡（启动配置中包含 <code>onrestart restart zygote</code>）；</li>
<li>Zygote 死亡（启动配置中为非 oneshot）；</li>
<li>system_server 进程死亡；</li>
</ol>
<h1 id="zygote-进程入口"><a href="#zygote-进程入口" class="headerlink" title="zygote 进程入口"></a>zygote 进程入口</h1><p>zygote 可执行文件 <code>app_process</code> 的实现代码在 <code>frameworks/base/cmds/app_process/app_main.cpp</code> 中，入口为 <code>main</code> 函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app_main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__LP64__)</span></span><br><span class="line"><span class="comment">// 如果为 64 位进程，则进程名为 &quot;zygote64&quot;，否则为 &quot;zygote&quot;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> ABI_LIST_PROPERTY[] = <span class="string">&quot;ro.product.cpu.abilist64&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> ZYGOTE_NICE_NAME[] = <span class="string">&quot;zygote64&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> ABI_LIST_PROPERTY[] = <span class="string">&quot;ro.product.cpu.abilist32&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> ZYGOTE_NICE_NAME[] = <span class="string">&quot;zygote&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* <span class="keyword">const</span> argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">prctl</span>(PR_SET_NO_NEW_PRIVS, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 旧版内核不识别 PR_SET_NO_NEW_PRIVS，将返回 EINVAL，避免在旧版内核上死掉</span></span><br><span class="line">    <span class="keyword">if</span> (errno != EINVAL) &#123;</span><br><span class="line">      <span class="built_in">LOG_ALWAYS_FATAL</span>(<span class="string">&quot;PR_SET_NO_NEW_PRIVS failed: %s&quot;</span>, <span class="built_in">strerror</span>(errno));</span><br><span class="line">      <span class="keyword">return</span> <span class="number">12</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// argv[0] = &quot;/system/bin/app_process&quot;</span></span><br><span class="line">  <span class="function">AppRuntime <span class="title">runtime</span><span class="params">(argv[<span class="number">0</span>], computeArgBlockSize(argc, argv))</span></span>;</span><br><span class="line">  <span class="comment">// 跳过 argv[0] 参数</span></span><br><span class="line">  argc--;</span><br><span class="line">  argv++;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 直到遇到 &#x27;-&#x27; 或第一个非 &#x27;-&#x27; 的参数为止的所有内容都将提供给虚拟机作为 options。</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// --zygote：             启动到 zygote 模式</span></span><br><span class="line">  <span class="comment">// --start-system-server：启动 system server</span></span><br><span class="line">  <span class="comment">// --application：	    以应用程序模式启动 (独立启动, 非 zygote)</span></span><br><span class="line">  <span class="comment">// --nice-name：	    给进程起一个好名字</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// 对于非 zygote 启动，这些参数后面将是主类名，所有其余的参数都传递给此类的 main 方法；</span></span><br><span class="line">  <span class="comment">// 对于 zygote 启动，所有剩余的参数都传递给 zygote 的 main 方法。</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; argc; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (argv[i][<span class="number">0</span>] != <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (argv[i][<span class="number">1</span>] == <span class="string">&#x27;-&#x27;</span> &amp;&amp; argv[i][<span class="number">2</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">      ++i;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    runtime.<span class="built_in">addOption</span>(<span class="built_in">strdup</span>(argv[i]));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">bool</span> zygote = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">bool</span> startSystemServer = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">bool</span> application = <span class="literal">false</span>;</span><br><span class="line">  String8 niceName;</span><br><span class="line">  String8 className;</span><br><span class="line"></span><br><span class="line">  ++i;</span><br><span class="line">  <span class="keyword">while</span> (i &lt; argc) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* arg = argv[i++];</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">&quot;--zygote&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">      zygote = <span class="literal">true</span>;</span><br><span class="line">      niceName = ZYGOTE_NICE_NAME;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">&quot;--start-system-server&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">      startSystemServer = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">&quot;--application&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">      application = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">&quot;--nice-name=&quot;</span>, <span class="number">12</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">      niceName.<span class="built_in">setTo</span>(arg + <span class="number">12</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">&quot;--&quot;</span>, <span class="number">2</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">      className.<span class="built_in">setTo</span>(arg);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      --i;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Vector&lt;String8&gt; args;</span><br><span class="line">  <span class="keyword">if</span> (!className.<span class="built_in">isEmpty</span>()) &#123;</span><br><span class="line">    <span class="comment">// 没有处于 zygote 模式</span></span><br><span class="line">    args.<span class="built_in">add</span>(application ? <span class="built_in">String8</span>(<span class="string">&quot;application&quot;</span>) : <span class="built_in">String8</span>(<span class="string">&quot;tool&quot;</span>));</span><br><span class="line">    runtime.<span class="built_in">setClassNameAndArgs</span>(className, argc - i, argv + i);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// className 为空，处于 zygote 模式</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 /data/dalvik-cache/ 目录</span></span><br><span class="line">    <span class="built_in">maybeCreateDalvikCache</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">      args.<span class="built_in">add</span>(<span class="built_in">String8</span>(<span class="string">&quot;start-system-server&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> prop[PROP_VALUE_MAX];</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">property_get</span>(ABI_LIST_PROPERTY, prop, <span class="literal">NULL</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">LOG_ALWAYS_FATAL</span>(<span class="string">&quot;app_process: Unable to determine ABI list from property %s.&quot;</span>,</span><br><span class="line">        ABI_LIST_PROPERTY);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">11</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">String8 <span class="title">abiFlag</span><span class="params">(<span class="string">&quot;--abi-list=&quot;</span>)</span></span>;</span><br><span class="line">    abiFlag.<span class="built_in">append</span>(prop);</span><br><span class="line">    <span class="comment">// 获取支持的 abi 列表</span></span><br><span class="line">    args.<span class="built_in">add</span>(abiFlag);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在 zygote 模式下，将所有剩余参数传递给 zygote 的 main() 方法。</span></span><br><span class="line">    <span class="keyword">for</span> (; i &lt; argc; ++i) &#123;</span><br><span class="line">      args.<span class="built_in">add</span>(<span class="built_in">String8</span>(argv[i]));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!niceName.<span class="built_in">isEmpty</span>()) &#123;</span><br><span class="line">    <span class="comment">// 设置进程名字</span></span><br><span class="line">    runtime.<span class="built_in">setArgv0</span>(niceName.<span class="built_in">string</span>());</span><br><span class="line">    <span class="built_in">set_process_name</span>(niceName.<span class="built_in">string</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (zygote) &#123;</span><br><span class="line">    runtime.<span class="built_in">start</span>(<span class="string">&quot;com.android.internal.os.ZygoteInit&quot;</span>, args, zygote);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className) &#123;</span><br><span class="line">    runtime.<span class="built_in">start</span>(<span class="string">&quot;com.android.internal.os.RuntimeInit&quot;</span>, args, zygote);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Error: no class name or --zygote supplied.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">app_usage</span>();</span><br><span class="line">    <span class="built_in">LOG_ALWAYS_FATAL</span>(<span class="string">&quot;app_process: no class name or --zygote supplied.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AppRuntime.main</code> 函数做了如下工作：</p>
<ol>
<li>创建了 <code>AppRuntime</code> 对象，传入虚拟机所需的选项；</li>
<li>解析 init.rc 文件的 <code>zygote</code> 启动参数；</li>
<li>调用 <code>AppRuntime.start</code> 函数，根据启动 zygote 还是命令行（<code>className</code>），进入 <code>ZygoteInit</code> 或者 <code>RuntimeInit</code> 参数分支。</li>
</ol>
<p>提示：<code>app_process</code> 可使用命令行调用，启动一个 Java 类，并调用 <code>main</code> 方法，此时有 <code>className</code> 参数，处于非 zygote 模式。</p>
<p>格式：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app_process [可选参数] 命令所在路径 启动的类名 [可选参数]</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app_process -Djava.class.path=Hello.dex /data/<span class="built_in">local</span>/ com.example.Hello</span><br></pre></td></tr></table></figure>



<h2 id="AppRuntim-start"><a href="#AppRuntim-start" class="headerlink" title="AppRuntim.start"></a>AppRuntim.start</h2><p>下面进入 <code>AppRuntime</code> 的 <code>start</code> 函数中，以 <code>ZygoteInit</code> 参数分支为路径进行分析：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AndroidRuntime.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AndroidRuntime::start</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* className, <span class="keyword">const</span> Vector&lt;String8&gt;&amp; options, <span class="keyword">bool</span> zygote)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">ALOGD</span>(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt; START %s uid %d &lt;&lt;&lt;&lt;&lt;&lt;\n&quot;</span>,</span><br><span class="line">          className != <span class="literal">NULL</span> ? className : <span class="string">&quot;(unknown)&quot;</span>, <span class="built_in">getuid</span>());</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">const</span> String8 <span class="title">startSystemServer</span><span class="params">(<span class="string">&quot;start-system-server&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; options.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (options[i] == startSystemServer) &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="keyword">int</span> LOG_BOOT_PROGRESS_START = <span class="number">3000</span>;</span><br><span class="line">      <span class="built_in">LOG_EVENT_LONG</span>(LOG_BOOT_PROGRESS_START,  <span class="built_in">ns2ms</span>(<span class="built_in">systemTime</span>(SYSTEM_TIME_MONOTONIC)));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span>* rootDir = <span class="built_in">getenv</span>(<span class="string">&quot;ANDROID_ROOT&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (rootDir == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    rootDir = <span class="string">&quot;/system&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">hasDir</span>(<span class="string">&quot;/system&quot;</span>)) &#123;</span><br><span class="line">      <span class="built_in">LOG_FATAL</span>(<span class="string">&quot;No root directory specified, and /android does not exist.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="built_in">setenv</span>(<span class="string">&quot;ANDROID_ROOT&quot;</span>, rootDir, <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  JniInvocation jni_invocation;</span><br><span class="line">  jni_invocation.<span class="built_in">Init</span>(<span class="literal">NULL</span>);</span><br><span class="line">  JNIEnv* env;</span><br><span class="line">  <span class="comment">// 创建虚拟机</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">startVm</span>(&amp;mJavaVM, &amp;env, zygote) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">onVmCreated</span>(env);</span><br><span class="line">  <span class="comment">// 注册系统类 JNI 方法</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">startReg</span>(env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">ALOGE</span>(<span class="string">&quot;Unable to register all android natives\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  jclass stringClass;</span><br><span class="line">  jobjectArray strArray;</span><br><span class="line">  jstring classNameStr;</span><br><span class="line">  </span><br><span class="line">  stringClass = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;java/lang/String&quot;</span>);</span><br><span class="line">  <span class="built_in">assert</span>(stringClass != <span class="literal">NULL</span>);</span><br><span class="line">  <span class="comment">// Java: strArray = new String[options.size() + 1];</span></span><br><span class="line">  strArray = env-&gt;<span class="built_in">NewObjectArray</span>(options.<span class="built_in">size</span>() + <span class="number">1</span>, stringClass, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="built_in">assert</span>(strArray != <span class="literal">NULL</span>);</span><br><span class="line">  classNameStr = env-&gt;<span class="built_in">NewStringUTF</span>(className);</span><br><span class="line">  <span class="built_in">assert</span>(classNameStr != <span class="literal">NULL</span>);</span><br><span class="line">  <span class="comment">// Java: strArray[0] = &quot;com.android.internal.os.ZygoteInit&quot;;</span></span><br><span class="line">  env-&gt;<span class="built_in">SetObjectArrayElement</span>(strArray, <span class="number">0</span>, classNameStr);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 将相关参数收集至 options 中，下面会传递给 ZygoteInit</span></span><br><span class="line">  <span class="comment">// --start-system-server, --abi-list=arm64-v8a ...</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; options.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">    jstring optionsStr = env-&gt;<span class="built_in">NewStringUTF</span>(options.<span class="built_in">itemAt</span>(i).<span class="built_in">string</span>());</span><br><span class="line">    <span class="built_in">assert</span>(optionsStr != <span class="literal">NULL</span>);</span><br><span class="line">    env-&gt;<span class="built_in">SetObjectArrayElement</span>(strArray, i + <span class="number">1</span>, optionsStr);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 转换为 JNI 格式类名：com/android/internal/os/ZygoteInit</span></span><br><span class="line">  <span class="keyword">char</span>* slashClassName = <span class="built_in">toSlashClassName</span>(className);</span><br><span class="line">  jclass startClass = env-&gt;<span class="built_in">FindClass</span>(slashClassName);</span><br><span class="line">  <span class="keyword">if</span> (startClass == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">ALOGE</span>(<span class="string">&quot;JavaVM unable to locate class &#x27;%s&#x27;\n&quot;</span>, slashClassName);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    jmethodID startMeth = env-&gt;<span class="built_in">GetStaticMethodID</span>(startClass, <span class="string">&quot;main&quot;</span>,</span><br><span class="line">       <span class="string">&quot;([Ljava/lang/String;)V&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (startMeth == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="built_in">ALOGE</span>(<span class="string">&quot;JavaVM unable to find main() in &#x27;%s&#x27;\n&quot;</span>, className);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 调用 ZygoteInit.main();</span></span><br><span class="line">      env-&gt;<span class="built_in">CallStaticVoidMethod</span>(startClass, startMeth, strArray);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(slashClassName);</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">ALOGD</span>(<span class="string">&quot;Shutting down VM\n&quot;</span>);</span><br><span class="line">  <span class="comment">// 关闭 Java 虚拟机</span></span><br><span class="line">  <span class="keyword">if</span> (mJavaVM-&gt;<span class="built_in">DetachCurrentThread</span>() != JNI_OK)</span><br><span class="line">    <span class="built_in">ALOGW</span>(<span class="string">&quot;Warning: unable to detach main thread\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (mJavaVM-&gt;<span class="built_in">DestroyJavaVM</span>() != <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">ALOGW</span>(<span class="string">&quot;Warning: VM did not shut down cleanly\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>上面的代码也比较清晰，工作如下：</p>
<ol>
<li><code>startVm</code> 函数创建 ART 虚拟机；</li>
<li><code>startReg</code> 函数注册系统 JNI 方法；</li>
<li>收集 <code>options</code> 参数，调用并传递给 <code>ZygoteInit.main()</code>。</li>
</ol>
<p>下面针对每个方法具体分析。</p>
<h2 id="AppRuntime-startVm"><a href="#AppRuntime-startVm" class="headerlink" title="AppRuntime.startVm"></a>AppRuntime.startVm</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AndroidRuntime.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">AndroidRuntime::startVm</span><span class="params">(JavaVM** pJavaVM, JNIEnv** pEnv, <span class="keyword">bool</span> zygote)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  JavaVMInitArgs initArgs;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">bool</span> checkJni = <span class="literal">false</span>;</span><br><span class="line">  <span class="built_in">property_get</span>(<span class="string">&quot;dalvik.vm.checkjni&quot;</span>, propBuf, <span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">&quot;true&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    checkJni = <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">&quot;false&quot;</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">property_get</span>(<span class="string">&quot;ro.kernel.android.checkjni&quot;</span>, propBuf, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (propBuf[<span class="number">0</span>] == <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">      checkJni = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">ALOGD</span>(<span class="string">&quot;CheckJNI is %s\n&quot;</span>, checkJni ? <span class="string">&quot;ON&quot;</span> : <span class="string">&quot;OFF&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (checkJni) &#123;</span><br><span class="line">    <span class="comment">/* 扩展的 JNI 检查 */</span></span><br><span class="line">    <span class="built_in">addOption</span>(<span class="string">&quot;-Xcheck:jni&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 启用 -Xcheck:jni，它提供了 JNI 函数调用跟踪 */</span></span><br><span class="line">    <span class="comment">//addOption(&quot;-verbose:jni&quot;);</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">parseRuntimeOption</span>(<span class="string">&quot;dalvik.vm.zygote.max-boot-retry&quot;</span>, cachePruneBuf,</span><br><span class="line">                     <span class="string">&quot;-Xzygote-max-boot-retry=&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"> </span><br><span class="line">  <span class="built_in">property_get</span>(<span class="string">&quot;dalvik.vm.execution-mode&quot;</span>, propBuf, <span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">&quot;int:portable&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    executionMode = kEMIntPortable;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">&quot;int:fast&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    executionMode = kEMIntFast;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">&quot;int:jit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    executionMode = kEMJitCompiler;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 默认的起始和最大堆大小，通常根据具体厂商硬件进行合适的配置</span></span><br><span class="line">  <span class="built_in">parseRuntimeOption</span>(<span class="string">&quot;dalvik.vm.heapstartsize&quot;</span>, heapstartsizeOptsBuf, <span class="string">&quot;-Xms&quot;</span>, <span class="string">&quot;4m&quot;</span>);</span><br><span class="line">  <span class="built_in">parseRuntimeOption</span>(<span class="string">&quot;dalvik.vm.heapsize&quot;</span>, heapsizeOptsBuf, <span class="string">&quot;-Xmx&quot;</span>, <span class="string">&quot;16m&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">parseRuntimeOption</span>(<span class="string">&quot;dalvik.vm.heapgrowthlimit&quot;</span>, heapgrowthlimitOptsBuf, <span class="string">&quot;-XX:HeapGrowthLimit=&quot;</span>);</span><br><span class="line">  <span class="built_in">parseRuntimeOption</span>(<span class="string">&quot;dalvik.vm.heapminfree&quot;</span>, heapminfreeOptsBuf, <span class="string">&quot;-XX:HeapMinFree=&quot;</span>);</span><br><span class="line">  <span class="built_in">parseRuntimeOption</span>(<span class="string">&quot;dalvik.vm.heapmaxfree&quot;</span>, heapmaxfreeOptsBuf, <span class="string">&quot;-XX:HeapMaxFree=&quot;</span>);</span><br><span class="line">  <span class="built_in">parseRuntimeOption</span>(<span class="string">&quot;dalvik.vm.heaptargetutilization&quot;</span>, heaptargetutilizationOptsBuf, <span class="string">&quot;-XX:HeapTargetUtilization=&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 确保有可预加载的类文件，preloaded-classes 中存放了所有需要被预加载的系统 Java 类</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">hasFile</span>(<span class="string">&quot;/system/etc/preloaded-classes&quot;</span>)) &#123;</span><br><span class="line">    <span class="built_in">ALOGE</span>(<span class="string">&quot;Missing preloaded-classes file, /system/etc/preloaded-classes not found: %s\n&quot;</span>, <span class="built_in">strerror</span>(errno));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ... 省略数百行 addOption 相关语句 </span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 解析 fingerprint 信息并提供给运行时，ANR dump 信息将包含 fingerprint 信息且能够解析</span></span><br><span class="line">  <span class="built_in">parseRuntimeOption</span>(<span class="string">&quot;ro.build.fingerprint&quot;</span>, fingerprintBuf, <span class="string">&quot;-Xfingerprint:&quot;</span>);</span><br><span class="line"></span><br><span class="line">  initArgs.version = JNI_VERSION_1_4;</span><br><span class="line">  initArgs.options = mOptions.<span class="built_in">editArray</span>();</span><br><span class="line">  initArgs.nOptions = mOptions.<span class="built_in">size</span>();</span><br><span class="line">  initArgs.ignoreUnrecognized = JNI_FALSE;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化虚拟机。JavaVM* 是基于进程的，而 JNIEnv* 是基于线程的，</span></span><br><span class="line">  <span class="comment">// 如果调用成功，表示虚拟机已就绪，可以开始 JNI 调用了。</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">JNI_CreateJavaVM</span>(pJavaVM, pEnv, &amp;initArgs) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">ALOGE</span>(<span class="string">&quot;JNI_CreateJavaVM failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码主要是为虚拟机初始化添加运行选项，最后调用 <code>JNI_CreateJavaVM</code> 创建虚拟机，下面就进入了虚拟机流程了，需要理解虚拟机时再探究其源码。</p>
<p>下面回到上面 <code>AppRuntime.start</code> 函数，看 <code>startReg</code> 的实现。 </p>
<h2 id="AppRuntime-startReg"><a href="#AppRuntime-startReg" class="headerlink" title="AppRuntime.startReg"></a>AppRuntime.startReg</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AndroidRuntime.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NELEM(x) (sizeof(x)/sizeof(*(x))) </span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*static*/</span> <span class="function"><span class="keyword">int</span> <span class="title">AndroidRuntime::startReg</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// 设置 Thread 创建函数，用于支持 Android Native 层线程封装</span></span><br><span class="line">  <span class="built_in">androidSetCreateThreadFunc</span>((android_create_thread_fn) javaCreateThreadEtc);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ALOGV</span>(<span class="string">&quot;--- registering native functions ---\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  env-&gt;<span class="built_in">PushLocalFrame</span>(<span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 注册 JNI 方法</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">register_jni_procs</span>(gRegJNI, <span class="built_in">NELEM</span>(gRegJNI), env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    env-&gt;<span class="built_in">PopLocalFrame</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  env-&gt;<span class="built_in">PopLocalFrame</span>(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//createJavaThread(&quot;fubar&quot;, quickTest, (void*) &quot;hello&quot;);</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AndroidRuntim.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REG_JNI(name)      &#123; name, #name &#125;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RegJNIRec</span> &#123;</span></span><br><span class="line">    <span class="built_in"><span class="keyword">int</span></span> (*mProc)(JNIEnv*);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* mName;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> RegJNIRec gRegJNI[] = &#123;</span><br><span class="line">  <span class="built_in">REG_JNI</span>(register_com_android_internal_os_RuntimeInit),</span><br><span class="line">  <span class="built_in">REG_JNI</span>(register_android_os_SystemClock),</span><br><span class="line">  <span class="built_in">REG_JNI</span>(register_android_util_EventLog),</span><br><span class="line">  <span class="built_in">REG_JNI</span>(register_android_util_Log),</span><br><span class="line">  <span class="built_in">REG_JNI</span>(register_android_content_AssetManager),</span><br><span class="line">  <span class="built_in">REG_JNI</span>(register_android_content_StringBlock),</span><br><span class="line">  <span class="comment">// ... 省略数百行</span></span><br><span class="line">  <span class="built_in">REG_JNI</span>(register_android_animation_PropertyValuesHolder),</span><br><span class="line">  <span class="built_in">REG_JNI</span>(register_com_android_internal_content_NativeLibraryHelper),</span><br><span class="line">  <span class="built_in">REG_JNI</span>(register_com_android_internal_net_NetworkStatsFactory),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">register_jni_procs</span><span class="params">(<span class="keyword">const</span> RegJNIRec array[], <span class="keyword">size_t</span> count, JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (array[i].<span class="built_in">mProc</span>(env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> NDEBUG</span></span><br><span class="line">      <span class="built_in">ALOGD</span>(<span class="string">&quot;----------!!! %s failed to load\n&quot;</span>, array[i].mName);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>



<p><code>startReg</code> 函数主要是注册系统类的 JNI 方法，使用 <code>register_jni_procs</code> 进行循环调用注册方法，每个 <code>mProc</code> 都指向 <code>gRegJNI</code> 数组里存放的结构体中的 <code>mProc</code> 函数指针，例如 <code>register_com_android_internal_os_RuntimeInit</code>，查看一下实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> JNINativeMethod gMethods[] = &#123;</span><br><span class="line">  &#123; <span class="string">&quot;nativeFinishInit&quot;</span>, <span class="string">&quot;()V&quot;</span>,</span><br><span class="line">    (<span class="keyword">void</span>*) com_android_internal_os_RuntimeInit_nativeFinishInit &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;nativeZygoteInit&quot;</span>, <span class="string">&quot;()V&quot;</span>,</span><br><span class="line">    (<span class="keyword">void</span>*) com_android_internal_os_RuntimeInit_nativeZygoteInit &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;nativeSetExitWithoutCleanup&quot;</span>, <span class="string">&quot;(Z)V&quot;</span>,</span><br><span class="line">    (<span class="keyword">void</span>*) com_android_internal_os_RuntimeInit_nativeSetExitWithoutCleanup &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_com_android_internal_os_RuntimeInit</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">jniRegisterNativeMethods</span>(env, <span class="string">&quot;com/android/internal/os/RuntimeInit&quot;</span>,</span><br><span class="line">      gMethods, <span class="built_in">NELEM</span>(gMethods));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>startReg</code> 之后下面就是通过 <code>env-&gt;CallStaticVoidMethod</code> 启动 <code>Zygoteinit.main</code> 进入 Java 层了。</p>
<h1 id="ZygoteInit-main"><a href="#ZygoteInit-main" class="headerlink" title="ZygoteInit.main"></a>ZygoteInit.main</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZygoteInit.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    RuntimeInit.enableDdms();</span><br><span class="line">    SamplingProfilerIntegration.start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> startSystemServer = <span class="keyword">false</span>;</span><br><span class="line">    String socketName = <span class="string">&quot;zygote&quot;</span>;</span><br><span class="line">    String abiList = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; argv.length; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="string">&quot;start-system-server&quot;</span>.equals(argv[i])) &#123;</span><br><span class="line">        startSystemServer = <span class="keyword">true</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(ABI_LIST_ARG)) &#123;</span><br><span class="line">        abiList = argv[i].substring(ABI_LIST_ARG.length());</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(SOCKET_NAME_ARG)) &#123;</span><br><span class="line">        socketName = argv[i].substring(SOCKET_NAME_ARG.length());</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Unknown command line argument: &quot;</span> + argv[i]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (abiList == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;No ABI list supplied.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册 socket 服务端</span></span><br><span class="line">    registerZygoteSocket(socketName);</span><br><span class="line">    EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START,</span><br><span class="line">        SystemClock.uptimeMillis());</span><br><span class="line">    <span class="comment">// 预加载资源</span></span><br><span class="line">    preload();</span><br><span class="line">    EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_END,</span><br><span class="line">        SystemClock.uptimeMillis());</span><br><span class="line"></span><br><span class="line">    SamplingProfilerIntegration.writeZygoteSnapshot();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在启动后执行初始 gc</span></span><br><span class="line">    gcAndFinalize();</span><br><span class="line"></span><br><span class="line">    Trace.setTracingEnabled(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">      <span class="comment">// 启动 system_server</span></span><br><span class="line">      startSystemServer(abiList, socketName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Log.i(TAG, <span class="string">&quot;Accepting command socket connections&quot;</span>);</span><br><span class="line">    <span class="comment">// 启动 socket 循环</span></span><br><span class="line">    runSelectLoop(abiList);</span><br><span class="line">    closeServerSocket();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (MethodAndArgsCaller caller) &#123;</span><br><span class="line">    caller.run();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">    Log.e(TAG, <span class="string">&quot;Zygote died with exception&quot;</span>, ex);</span><br><span class="line">    closeServerSocket();</span><br><span class="line">    <span class="keyword">throw</span> ex;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码做了如下工作：</p>
<ol>
<li>使用 <code>registerZygoteSocket</code> 注册 socket 服务端，为能够接收创建子进程的请求提供支持；</li>
<li>使用 <code>preload()</code> 预加载应用进程所需资源；</li>
<li>启动 <code>system_server</code> 服务进程；</li>
<li>启动 socket 循环，等待外部请求，随时响应处理。</li>
</ol>
<p>下面进入函数具体分析。</p>
<h2 id="ZygoteInit-registerZygoteSocket"><a href="#ZygoteInit-registerZygoteSocket" class="headerlink" title="ZygoteInit.registerZygoteSocket"></a>ZygoteInit.registerZygoteSocket</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZygoteInit.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ANDROID_SOCKET_PREFIX = <span class="string">&quot;ANDROID_SOCKET_&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerZygoteSocket</span><span class="params">(String socketName)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (sServerSocket == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> fileDesc;</span><br><span class="line">    <span class="keyword">final</span> String fullSocketName = ANDROID_SOCKET_PREFIX + socketName;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      String env = System.getenv(fullSocketName);</span><br><span class="line">      fileDesc = Integer.parseInt(env);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(fullSocketName + <span class="string">&quot; unset or invalid&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      FileDescriptor fd = <span class="keyword">new</span> FileDescriptor();</span><br><span class="line">      fd.setInt$(fileDesc);</span><br><span class="line">      <span class="comment">// 创建了本地 socket 服务端</span></span><br><span class="line">      sServerSocket = <span class="keyword">new</span> LocalServerSocket(fd);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">            <span class="string">&quot;Error binding to local socket &#x27;&quot;</span> + fileDesc + <span class="string">&quot;&#x27;&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要是要创建了本地服务端 socket 对象，命名为 <code>ANDROID_SOCKET_zygote</code>。</p>
<h2 id="ZygoteInit-preload"><a href="#ZygoteInit-preload" class="headerlink" title="ZygoteInit.preload"></a>ZygoteInit.preload</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZygoteInit.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">preload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Log.d(TAG, <span class="string">&quot;begin preload&quot;</span>);</span><br><span class="line">  <span class="comment">// 预加载 /system/etc/preloaded-classes 文件中的系统类</span></span><br><span class="line">  preloadClasses();</span><br><span class="line">  <span class="comment">// 预加载 drawable 和 color 资源</span></span><br><span class="line">  preloadResources();</span><br><span class="line">  <span class="comment">// 预加载 OpenGL</span></span><br><span class="line">  preloadOpenGL();</span><br><span class="line">  <span class="comment">// 预加载共享库</span></span><br><span class="line">  preloadSharedLibraries();</span><br><span class="line">  <span class="comment">// 预加载文本资源</span></span><br><span class="line">  preloadTextResources();</span><br><span class="line">  <span class="comment">// WebView 相关初始化</span></span><br><span class="line">  WebViewFactory.prepareWebViewInZygote();</span><br><span class="line">  Log.d(TAG, <span class="string">&quot;end preload&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">preloadSharedLibraries</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Log.i(TAG, <span class="string">&quot;Preloading shared libraries...&quot;</span>);</span><br><span class="line">  System.loadLibrary(<span class="string">&quot;android&quot;</span>);</span><br><span class="line">  System.loadLibrary(<span class="string">&quot;compiler_rt&quot;</span>);</span><br><span class="line">  System.loadLibrary(<span class="string">&quot;jnigraphics&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">preloadOpenGL</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!SystemProperties.getBoolean(PROPERTY_DISABLE_OPENGL_PRELOADING, <span class="keyword">false</span>)) &#123;</span><br><span class="line">    EGL14.eglGetDisplay(EGL14.EGL_DEFAULT_DISPLAY);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">preloadTextResources</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Hyphenator.init();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">preloadClasses</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> VMRuntime runtime = VMRuntime.getRuntime();</span><br><span class="line">  InputStream is;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    is = <span class="keyword">new</span> FileInputStream(PRELOADED_CLASSES);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">    Log.e(TAG, <span class="string">&quot;Couldn&#x27;t find &quot;</span> + PRELOADED_CLASSES + <span class="string">&quot;.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">   </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(is), <span class="number">256</span>);</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    String line;</span><br><span class="line">    <span class="keyword">while</span> ((line = br.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">      line = line.trim();</span><br><span class="line">      <span class="keyword">if</span> (line.startsWith(<span class="string">&quot;#&quot;</span>) || line.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">2<span class="comment">// 预加载类</span></span><br><span class="line">        Class.forName(line, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">        count++;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">&quot;Class not found for preloading: &quot;</span> + line);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (UnsatisfiedLinkError e) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">&quot;Problem preloading &quot;</span> + line + <span class="string">&quot;: &quot;</span> + e);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(t);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Log.i(TAG, <span class="string">&quot;...preloaded &quot;</span> + count + <span class="string">&quot; classes in &quot;</span></span><br><span class="line">          + (SystemClock.uptimeMillis()-startTime) + <span class="string">&quot;ms.&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    Log.e(TAG, <span class="string">&quot;Error reading &quot;</span> + PRELOADED_CLASSES + <span class="string">&quot;.&quot;</span>, e);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    IoUtils.closeQuietly(is);</span><br><span class="line">    runtime.setTargetHeapUtilization(defaultUtilization);</span><br><span class="line">    <span class="comment">// 使用已加载类填充 DexCaches</span></span><br><span class="line">    runtime.preloadDexCaches();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">preloadResources</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> VMRuntime runtime = VMRuntime.getRuntime();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    mResources = Resources.getSystem();</span><br><span class="line">    mResources.startPreloading();</span><br><span class="line">    <span class="keyword">if</span> (PRELOAD_RESOURCES) &#123;</span><br><span class="line">      Log.i(TAG, <span class="string">&quot;Preloading resources...&quot;</span>);</span><br><span class="line">      <span class="keyword">long</span> startTime = SystemClock.uptimeMillis();</span><br><span class="line">      TypedArray ar = mResources.obtainTypedArray(</span><br><span class="line">              com.android.internal.R.array.preloaded_drawables);</span><br><span class="line">      <span class="keyword">int</span> N = preloadDrawables(runtime, ar);</span><br><span class="line">      ar.recycle();</span><br><span class="line">      Log.i(TAG, <span class="string">&quot;...preloaded &quot;</span> + N + <span class="string">&quot; resources in &quot;</span></span><br><span class="line">              + (SystemClock.uptimeMillis()-startTime) + <span class="string">&quot;ms.&quot;</span>);</span><br><span class="line">      startTime = SystemClock.uptimeMillis();</span><br><span class="line">      ar = mResources.obtainTypedArray(</span><br><span class="line">              com.android.internal.R.array.preloaded_color_state_lists);</span><br><span class="line">      N = preloadColorStateLists(runtime, ar);</span><br><span class="line">      ar.recycle();</span><br><span class="line">      Log.i(TAG, <span class="string">&quot;...preloaded &quot;</span> + N + <span class="string">&quot; resources in &quot;</span></span><br><span class="line">              + (SystemClock.uptimeMillis()-startTime) + <span class="string">&quot;ms.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mResources.finishPreloading();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">    Log.w(TAG, <span class="string">&quot;Failure preloading resources&quot;</span>, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">preloadColorStateLists</span><span class="params">(VMRuntime runtime, TypedArray ar)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> N = ar.length();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">    <span class="keyword">int</span> id = ar.getResourceId(i, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (id != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (mResources.getColorStateList(id, <span class="keyword">null</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                <span class="string">&quot;Unable to find preloaded color resource #0x&quot;</span></span><br><span class="line">                + Integer.toHexString(id)</span><br><span class="line">                + <span class="string">&quot; (&quot;</span> + ar.getString(i) + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> N;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">preloadDrawables</span><span class="params">(VMRuntime runtime, TypedArray ar)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> N = ar.length();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">    <span class="keyword">int</span> id = ar.getResourceId(i, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (id != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (mResources.getDrawable(id, <span class="keyword">null</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                <span class="string">&quot;Unable to find preloaded drawable resource #0x&quot;</span></span><br><span class="line">                + Integer.toHexString(id)</span><br><span class="line">                + <span class="string">&quot; (&quot;</span> + ar.getString(i) + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> N;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面几乎把加载资源的所有代码都列了出来。</p>
<p>预加载这些资源的目的是为了将资源提前放置在内存中，当创建子进程的时候，可以直接使用这些资源，而不必每次都重新加载一遍。</p>
<h2 id="ZygoteInit-startSystemServer"><a href="#ZygoteInit-startSystemServer" class="headerlink" title="ZygoteInit.startSystemServer"></a>ZygoteInit.startSystemServer</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZygoteInit.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">startSystemServer</span><span class="params">(String abiList, String socketName)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> MethodAndArgsCaller, RuntimeException </span>&#123;</span><br><span class="line">  <span class="keyword">long</span> capabilities = posixCapabilitiesAsBits(</span><br><span class="line">    OsConstants.CAP_BLOCK_SUSPEND,</span><br><span class="line">    OsConstants.CAP_KILL,</span><br><span class="line">    OsConstants.CAP_NET_ADMIN,</span><br><span class="line">    OsConstants.CAP_NET_BIND_SERVICE,</span><br><span class="line">    OsConstants.CAP_NET_BROADCAST,</span><br><span class="line">    OsConstants.CAP_NET_RAW,</span><br><span class="line">    OsConstants.CAP_SYS_MODULE,</span><br><span class="line">    OsConstants.CAP_SYS_NICE,</span><br><span class="line">    OsConstants.CAP_SYS_RESOURCE,</span><br><span class="line">    OsConstants.CAP_SYS_TIME,</span><br><span class="line">    OsConstants.CAP_SYS_TTY_CONFIG</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  String args[] = &#123;</span><br><span class="line">    <span class="string">&quot;--setuid=1000&quot;</span>,</span><br><span class="line">    <span class="string">&quot;--setgid=1000&quot;</span>,</span><br><span class="line">    <span class="string">&quot;--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,3001,3002,3003,3006,3007&quot;</span>,</span><br><span class="line">    <span class="string">&quot;--capabilities=&quot;</span> + capabilities + <span class="string">&quot;,&quot;</span> + capabilities,</span><br><span class="line">    <span class="string">&quot;--nice-name=system_server&quot;</span>,</span><br><span class="line">    <span class="string">&quot;--runtime-args&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.server.SystemServer&quot;</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  ZygoteConnection.Arguments parsedArgs = <span class="keyword">null</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">int</span> pid;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    parsedArgs = <span class="keyword">new</span> ZygoteConnection.Arguments(args);</span><br><span class="line">    ZygoteConnection.applyDebuggerSystemProperty(parsedArgs);</span><br><span class="line">    ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// fork 出 system_server 进程并使用相关参数设置进程信息</span></span><br><span class="line">    pid = Zygote.forkSystemServer(</span><br><span class="line">        parsedArgs.uid, parsedArgs.gid,</span><br><span class="line">        parsedArgs.gids,</span><br><span class="line">        parsedArgs.debugFlags,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        parsedArgs.permittedCapabilities,</span><br><span class="line">        parsedArgs.effectiveCapabilities);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 进入子进程</span></span><br><span class="line">    <span class="keyword">if</span> (hasSecondZygote(abiList)) &#123;</span><br><span class="line">      <span class="comment">// 等待另一个架构的 zygote 进程启动</span></span><br><span class="line">      waitForSecondaryZygote(socketName);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 处理 system_server 剩余工作</span></span><br><span class="line">    handleSystemServerProcess(parsedArgs);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码使用 <code>Zygote.forkSystemServer</code> fork 出了子进程，然后将相关参数设置给子进程，例如其中的 <code>uid=1000</code> 和 <code>gid=1000</code>，下面就进入 <code>handleSystemServerProcess</code> 方法，开始 <code>system_server</code> 的工作。</p>
<h2 id="ZygoteInit-runSelectLoop"><a href="#ZygoteInit-runSelectLoop" class="headerlink" title="ZygoteInit.runSelectLoop"></a>ZygoteInit.runSelectLoop</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runSelectLoop</span><span class="params">(String abiList)</span> <span class="keyword">throws</span> MethodAndArgsCaller </span>&#123;</span><br><span class="line">  ArrayList&lt;FileDescriptor&gt; fds = <span class="keyword">new</span> ArrayList&lt;FileDescriptor&gt;();</span><br><span class="line">  ArrayList&lt;ZygoteConnection&gt; peers = <span class="keyword">new</span> ArrayList&lt;ZygoteConnection&gt;();</span><br><span class="line"></span><br><span class="line">  fds.add(sServerSocket.getFileDescriptor());</span><br><span class="line">  peers.add(<span class="keyword">null</span>);</span><br><span class="line">  <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    StructPollfd[] pollFds = <span class="keyword">new</span> StructPollfd[fds.size()];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pollFds.length; ++i) &#123;</span><br><span class="line">      pollFds[i] = <span class="keyword">new</span> StructPollfd();</span><br><span class="line">      pollFds[i].fd = fds.get(i);</span><br><span class="line">      pollFds[i].events = (<span class="keyword">short</span>) POLLIN;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 监听 socket 连接，阻塞并等待描述符上的可读事件发生</span></span><br><span class="line">      Os.poll(pollFds, -<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;poll failed&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = pollFds.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((pollFds[i].revents &amp; POLLIN) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// i = 0 表明还未添加收到的 socket 请求对象（sServerSocket.accept()）</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建连接对象：new ZygoteConnection(sServerSocket.accept(), abiList);</span></span><br><span class="line">        ZygoteConnection newPeer = acceptCommandPeer(abiList);</span><br><span class="line">        peers.add(newPeer);</span><br><span class="line">        <span class="comment">// 添加到 fds 列表中待处理（下次循环将进行 Os.poll 等待描述符可读）</span></span><br><span class="line">        fds.add(newPeer.getFileDesciptor());</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// i &gt; 0 表示 socket 请求经过 Os.poll 表示已经可读，那么对请求进行处理</span></span><br><span class="line">        <span class="keyword">boolean</span> done = peers.get(i).runOnce();</span><br><span class="line">        <span class="keyword">if</span> (done) &#123;</span><br><span class="line">          <span class="comment">// 处理完则移除</span></span><br><span class="line">          peers.remove(i);</span><br><span class="line">          fds.remove(i);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>runSelectLoop</code> 进入了无限循环，等待并对服务端 socket 接收到的请求进行处理，使用 <code>runOnce</code> 进行请求处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">runOnce</span><span class="params">()</span> <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line"></span><br><span class="line">  String args[];</span><br><span class="line">  Arguments parsedArgs = <span class="keyword">null</span>;</span><br><span class="line">  FileDescriptor[] descriptors;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 解析 socket 客户端发送的命令列表</span></span><br><span class="line">    args = readArgumentList();</span><br><span class="line">    descriptors = mSocket.getAncillaryFileDescriptors();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">    Log.w(TAG, <span class="string">&quot;IOException on command socket &quot;</span> + ex.getMessage());</span><br><span class="line">    closeSocket();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (args == <span class="keyword">null</span>) &#123;</span><br><span class="line">    closeSocket();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> pid = -<span class="number">1</span>;</span><br><span class="line">  FileDescriptor childPipeFd = <span class="keyword">null</span>;</span><br><span class="line">  FileDescriptor serverPipeFd = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 创建参数封装对象</span></span><br><span class="line">    parsedArgs = <span class="keyword">new</span> Arguments(args);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parsedArgs.abiListQuery) &#123;</span><br><span class="line">      <span class="keyword">return</span> handleAbiListQuery();</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> [] fdsToClose = &#123; -<span class="number">1</span>, -<span class="number">1</span> &#125;;</span><br><span class="line"></span><br><span class="line">    FileDescriptor fd = mSocket.getFileDescriptor();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fd != <span class="keyword">null</span>) &#123;</span><br><span class="line">      fdsToClose[<span class="number">0</span>] = fd.getInt$();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd = ZygoteInit.getServerSocketFileDescriptor();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fd != <span class="keyword">null</span>) &#123;</span><br><span class="line">      fdsToClose[<span class="number">1</span>] = fd.getInt$();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建子进程</span></span><br><span class="line">    pid = Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids,</span><br><span class="line">            parsedArgs.debugFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo,</span><br><span class="line">            parsedArgs.niceName, fdsToClose, parsedArgs.instructionSet,</span><br><span class="line">            parsedArgs.appDataDir);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">    logAndPrintError(newStderr, <span class="string">&quot;Exception creating pipe&quot;</span>, ex);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">    logAndPrintError(newStderr, <span class="string">&quot;Invalid zygote arguments&quot;</span>, ex);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ZygoteSecurityException ex) &#123;</span><br><span class="line">    logAndPrintError(newStderr,</span><br><span class="line">            <span class="string">&quot;Zygote security policy prevents request: &quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 进入子进程</span></span><br><span class="line">      IoUtils.closeQuietly(serverPipeFd);</span><br><span class="line">      serverPipeFd = <span class="keyword">null</span>;</span><br><span class="line">      <span class="comment">// 处理子进程逻辑</span></span><br><span class="line">      handleChildProc(parsedArgs, descriptors, childPipeFd, newStderr);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      IoUtils.closeQuietly(childPipeFd);</span><br><span class="line">      childPipeFd = <span class="keyword">null</span>;</span><br><span class="line">      <span class="comment">// 父进程剩余工作</span></span><br><span class="line">      <span class="keyword">return</span> handleParentProc(pid, descriptors, serverPipeFd, parsedArgs);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    IoUtils.closeQuietly(childPipeFd);</span><br><span class="line">    IoUtils.closeQuietly(serverPipeFd);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>handleChildProc</code> 处理子进程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleChildProc</span><span class="params">(Arguments parsedArgs,</span></span></span><br><span class="line"><span class="params"><span class="function">        FileDescriptor[] descriptors, FileDescriptor pipeFd, PrintStream newStderr)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line">  closeSocket();</span><br><span class="line">  <span class="comment">// 关闭复制出来的服务端 socket</span></span><br><span class="line">  ZygoteInit.closeServerSocket();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (descriptors != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Os.dup2(descriptors[<span class="number">0</span>], STDIN_FILENO);</span><br><span class="line">      Os.dup2(descriptors[<span class="number">1</span>], STDOUT_FILENO);</span><br><span class="line">      Os.dup2(descriptors[<span class="number">2</span>], STDERR_FILENO);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (FileDescriptor fd: descriptors) &#123;</span><br><span class="line">          IoUtils.closeQuietly(fd);</span><br><span class="line">      &#125;</span><br><span class="line">      newStderr = System.err;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">      Log.e(TAG, <span class="string">&quot;Error reopening stdio&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (parsedArgs.niceName != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 设置进程名字</span></span><br><span class="line">    Process.setArgV0(parsedArgs.niceName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">  <span class="keyword">if</span> (parsedArgs.invokeWith != <span class="keyword">null</span>) &#123;</span><br><span class="line">    WrapperInit.execApplication(parsedArgs.invokeWith,</span><br><span class="line">            parsedArgs.niceName, parsedArgs.targetSdkVersion,</span><br><span class="line">            VMRuntime.getCurrentInstructionSet(),</span><br><span class="line">            pipeFd, parsedArgs.remainingArgs);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 会辗转调用到 ActivityThread.main 进入应用程序主流程</span></span><br><span class="line">    <span class="comment">// 内部会抛出一个 ZygoteInit.MethodAndArgsCaller 异常（为了清空调用栈），</span></span><br><span class="line">    <span class="comment">// 从而返回到上面 ZygoteInit 的 main 方法的 catch 语句块中执行</span></span><br><span class="line">    RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion,</span><br><span class="line">            parsedArgs.remainingArgs, <span class="keyword">null</span> <span class="comment">/* classLoader */</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当子进程 fork 出来后，处理子进程，关闭 socket 资源，之后进入应用程序进程主流程。</p>
<h1 id="整体流程图"><a href="#整体流程图" class="headerlink" title="整体流程图"></a>整体流程图</h1><p>使用流程图表示 zygote 整个工作过程：</p>
<p><img src="./zygote.png" alt="zygote.png"></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="http://gityuan.com/2016/02/13/android-zygote/">http://gityuan.com/2016/02/13/android-zygote/</a></li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>Android zygote 进程启动分析</p><p><a href="https://l0neman.github.io/2020/08/24/android-zygote-进程启动分析/">https://l0neman.github.io/2020/08/24/android-zygote-进程启动分析/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>l0neman</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2020-08-24</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2020-08-24</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/android/">Android</a><a class="link-muted mr-2" rel="tag" href="/tags/zygote/">Zygote</a></div><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5f0f12c19a2af379" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/qrcode/alipay.jpg" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/qrcode/wxpay.jpg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/09/09/android-dex-%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Android Dex 文件解析</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/08/17/android-init-%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E5%88%86%E6%9E%90/"><span class="level-item">Android init 进程启动分析</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><script src="https://utteranc.es/client.js" repo="l0neman/l0neman.github.io" issue-term="pathname" label="comment" theme="github-light" crossorigin="anonymous" async></script></div></div></div><!--!--><div class="column column-right  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#前言"><span class="level-left"><span class="level-item">1</span><span class="level-item">前言</span></span></a></li><li><a class="level is-mobile" href="#概述"><span class="level-left"><span class="level-item">2</span><span class="level-item">概述</span></span></a></li><li><a class="level is-mobile" href="#zygote-进程启动"><span class="level-left"><span class="level-item">3</span><span class="level-item">zygote 进程启动</span></span></a></li><li><a class="level is-mobile" href="#zygote-进程入口"><span class="level-left"><span class="level-item">4</span><span class="level-item">zygote 进程入口</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#AppRuntim-start"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">AppRuntim.start</span></span></a></li><li><a class="level is-mobile" href="#AppRuntime-startVm"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">AppRuntime.startVm</span></span></a></li><li><a class="level is-mobile" href="#AppRuntime-startReg"><span class="level-left"><span class="level-item">4.3</span><span class="level-item">AppRuntime.startReg</span></span></a></li></ul></li><li><a class="level is-mobile" href="#ZygoteInit-main"><span class="level-left"><span class="level-item">5</span><span class="level-item">ZygoteInit.main</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#ZygoteInit-registerZygoteSocket"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">ZygoteInit.registerZygoteSocket</span></span></a></li><li><a class="level is-mobile" href="#ZygoteInit-preload"><span class="level-left"><span class="level-item">5.2</span><span class="level-item">ZygoteInit.preload</span></span></a></li><li><a class="level is-mobile" href="#ZygoteInit-startSystemServer"><span class="level-left"><span class="level-item">5.3</span><span class="level-item">ZygoteInit.startSystemServer</span></span></a></li><li><a class="level is-mobile" href="#ZygoteInit-runSelectLoop"><span class="level-left"><span class="level-item">5.4</span><span class="level-item">ZygoteInit.runSelectLoop</span></span></a></li></ul></li><li><a class="level is-mobile" href="#整体流程图"><span class="level-left"><span class="level-item">6</span><span class="level-item">整体流程图</span></span></a></li><li><a class="level is-mobile" href="#参考"><span class="level-left"><span class="level-item">7</span><span class="level-item">参考</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/android-%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">Android 实用工具</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/android-%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/"><span class="level-start"><span class="level-item">Android 应用开发</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/android-%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/"><span class="level-start"><span class="level-item">Android 系统原理</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/android-%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/"><span class="level-start"><span class="level-item">Android 逆向工程</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3/"><span class="level-start"><span class="level-item">参考文档</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">实用工具</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/"><span class="level-start"><span class="level-item">编程基础</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-06-29T16:45:50.000Z">2021-06-30</time></p><p class="title"><a href="/2021/06/30/%E6%94%AF%E6%8C%81%E8%A7%A6%E6%91%B8%E6%8B%96%E5%8A%A8%E7%9A%84-touchdelegate/">支持触摸拖动的 TouchDelegate</a></p><p class="categories"><a href="/categories/android-%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/">Android 应用开发</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-21T15:08:15.000Z">2021-04-21</time></p><p class="title"><a href="/2021/04/21/gdb-arm-%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">GDB ARM 交叉编译环境搭建</a></p><p class="categories"><a href="/categories/android-%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/">Android 实用工具</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-21T15:04:39.000Z">2021-04-21</time></p><p class="title"><a href="/2021/04/21/dropbear-android-%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4/">Dropbear Android 安装步骤</a></p><p class="categories"><a href="/categories/android-%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/">Android 实用工具</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-21T14:49:48.000Z">2021-04-21</time></p><p class="title"><a href="/2021/04/21/material-design-%E5%8F%82%E8%80%83/">Material Design 参考</a></p><p class="categories"><a href="/categories/%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3/">参考文档</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-21T10:20:58.000Z">2021-04-21</time></p><p class="title"><a href="/2021/04/21/android-avd-%E4%BD%8D%E7%BD%AE%E4%BF%AE%E6%94%B9/">Android AVD 位置修改</a></p><p class="categories"><a href="/categories/android-%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/">Android 实用工具</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">四月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/02/"><span class="level-start"><span class="level-item">二月 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/arm/"><span class="tag">ARM</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/avd/"><span class="tag">AVD</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/activity/"><span class="tag">Activity</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/android/"><span class="tag">Android</span><span class="tag">23</span></a></div><div class="control"><a class="tags has-addons" href="/tags/assembly/"><span class="tag">Assembly</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/binder/"><span class="tag">Binder</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/classloader/"><span class="tag">ClassLoader</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/computer/"><span class="tag">Computer</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dex/"><span class="tag">Dex</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/elf/"><span class="tag">ELF</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/emulator/"><span class="tag">Emulator</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">Git</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/jni/"><span class="tag">JNI</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/java/"><span class="tag">Java</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/log/"><span class="tag">Log</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/make/"><span class="tag">Make</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/makefile/"><span class="tag">Makefile</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/markdown/"><span class="tag">MarkDown</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/metrial/"><span class="tag">Metrial</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ndk/"><span class="tag">NDK</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/regex/"><span class="tag">Regex</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssh/"><span class="tag">SSH</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/theme/"><span class="tag">Theme</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/touch/"><span class="tag">Touch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/view/"><span class="tag">View</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xposed/"><span class="tag">Xposed</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zygote/"><span class="tag">Zygote</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/aapt/"><span class="tag">aapt</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%83%AD%E4%BF%AE%E5%A4%8D/"><span class="tag">热修复</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%83%AD%E6%9B%B4%E6%96%B0/"><span class="tag">热更新</span><span class="tag">1</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="l0neman 的博客" height="28"></a><p class="is-size-7"><span>&copy; 2021 l0neman</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/l0neman"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>