<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Android init 进程启动分析 - l0neman 的博客</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="l0neman 的博客"><meta name="msapplication-TileImage" content="/img/avatar.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="l0neman 的博客"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="前言Android 系统启动后，内核会创建 0 号内核进程 idle 进程，然后 idle 进程通过调用 kernel_thread 函数，以 kernel_init 函数作为参数，通过回调 kernel_init 函数执行可执行文件 &amp;#x2F;init 创建 Android 系统中的第一个用户级别的进程 init 进程，init 进程的 pid &amp;#x3D; 1，它是所有用户空间进程的始祖，init 进程会通过"><meta property="og:type" content="blog"><meta property="og:title" content="Android init 进程启动分析"><meta property="og:url" content="https://l0neman.github.io/2020/08/17/android-init-%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E5%88%86%E6%9E%90/"><meta property="og:site_name" content="l0neman 的博客"><meta property="og:description" content="前言Android 系统启动后，内核会创建 0 号内核进程 idle 进程，然后 idle 进程通过调用 kernel_thread 函数，以 kernel_init 函数作为参数，通过回调 kernel_init 函数执行可执行文件 &amp;#x2F;init 创建 Android 系统中的第一个用户级别的进程 init 进程，init 进程的 pid &amp;#x3D; 1，它是所有用户空间进程的始祖，init 进程会通过"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://l0neman.github.io/2020/08/17/android-init-%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E5%88%86%E6%9E%90/signal_handler.png"><meta property="article:published_time" content="2020-08-17T13:47:07.000Z"><meta property="article:modified_time" content="2020-08-17T13:47:07.000Z"><meta property="article:author" content="l0neman"><meta property="article:tag" content="Android"><meta property="article:tag" content="Zygote"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="./signal_handler.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://l0neman.github.io/2020/08/17/android-init-%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E5%88%86%E6%9E%90/"},"headline":"Android init 进程启动分析","image":["https://l0neman.github.io/2020/08/17/android-init-%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E5%88%86%E6%9E%90/signal_handler.png"],"datePublished":"2020-08-17T13:47:07.000Z","dateModified":"2020-08-17T13:47:07.000Z","author":{"@type":"Person","name":"l0neman"},"publisher":{"@type":"Organization","name":"l0neman 的博客","logo":{"@type":"ImageObject","url":"https://l0neman.github.io/img/logo.png"}},"description":"前言Android 系统启动后，内核会创建 0 号内核进程 idle 进程，然后 idle 进程通过调用 kernel_thread 函数，以 kernel_init 函数作为参数，通过回调 kernel_init 函数执行可执行文件 &#x2F;init 创建 Android 系统中的第一个用户级别的进程 init 进程，init 进程的 pid &#x3D; 1，它是所有用户空间进程的始祖，init 进程会通过"}</script><link rel="canonical" href="https://l0neman.github.io/2020/08/17/android-init-%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E5%88%86%E6%9E%90/"><link rel="icon" href="/img/avatar.png"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.15.2/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?1727d76e0a823184efc8776f32a916a9";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="l0neman 的博客" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/l0neman"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-three-quarters"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-08-17T13:47:07.000Z" title="2020/8/17 下午9:47:07">2020-08-17</time>发表</span><span class="level-item"><time dateTime="2020-08-17T13:47:07.000Z" title="2020/8/17 下午9:47:07">2020-08-17</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/android-%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/">Android 系统原理</a></span><span class="level-item">1 小时读完 (大约7510个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Android init 进程启动分析</h1><div class="content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Android 系统启动后，内核会创建 0 号内核进程 idle 进程，然后 idle 进程通过调用 <code>kernel_thread</code> 函数，以 <code>kernel_init</code> 函数作为参数，通过回调 <code>kernel_init</code> 函数执行可执行文件 <code>/init</code> 创建 Android 系统中的第一个用户级别的进程 init 进程，init 进程的 pid = 1，它是所有用户空间进程的始祖，init 进程会通过 <code>fork</code> 分裂出 servicemanager（Binder 服务管理服务）、zygote（Android 系统中第一个 Java 进程）以及 surfaceflinger（图形服务）等系统核心服务进程，理解 init 进程的启动过程以及所做的工作将为理解整个 Android 系统运行机制打下基础。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel 3.18 - init/main.c</span></span><br><span class="line"></span><br><span class="line">kernel_thread(kernel_init, <span class="literal">NULL</span>, CLONE_FS);</span><br></pre></td></tr></table></figure>
<span id="more"></span>


<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>init 进程主要做了如下工作：</p>
<ol>
<li>挂载 / 节点上的重要目录；</li>
<li>初始化内核 log（<code>/dev/kmsg</code>）；</li>
<li>加载系统属性，提供属性设置服务，根据属性值变化做出响应（触发 .rc 文件中命令或启停止服务）；</li>
<li>解析并执行 init.rc 文件，根据其内容描述启动相应服务，初始化相应设备节点；</li>
<li>负责子进程的善后工作，清理子进程，防止其成为僵尸进程，或者根据配置重启进程。</li>
</ol>
<p>参考相关资料，对 Android 6.0.1 系统中 init 进程启动关键流程进行分析。</p>
<h1 id="init-进程入口"><a href="#init-进程入口" class="headerlink" title="init 进程入口"></a>init 进程入口</h1><p>/init 可执行文件的对应代码在 /system/core/init/init.cpp 中，入口为 <code>main</code> 函数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// init.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>**argv)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 用于执行其他守护进程，这里不用分析</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(<span class="built_in">basename</span>(argv[<span class="number">0</span>]), <span class="string">&quot;ueventd&quot;</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ueventd_main</span>(argc, argv);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(<span class="built_in">basename</span>(argv[<span class="number">0</span>]), <span class="string">&quot;watchdogd&quot;</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">watchdogd_main</span>(argc, argv);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置默认的文件创建权限为 777</span></span><br><span class="line">  <span class="built_in">umask</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="comment">// 设置 PATH 环境变量为 /sbin:/vendor/bin:/system/sbin:/system/bin:/system/xbin</span></span><br><span class="line">  <span class="built_in">add_environment</span>(<span class="string">&quot;PATH&quot;</span>, _PATH_DEFPATH);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 第一阶段还处于内核空间，第二阶段处于 init 空间</span></span><br><span class="line">  <span class="keyword">bool</span> is_first_stage = (argc == <span class="number">1</span>) || (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">&quot;--second-stage&quot;</span>) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置存在于 initramdisk 中的 / 目录中的相关文件，其他内容则由 rc 文件进行设置</span></span><br><span class="line">  <span class="keyword">if</span> (is_first_stage) &#123;</span><br><span class="line">    <span class="built_in">mount</span>(<span class="string">&quot;tmpfs&quot;</span>, <span class="string">&quot;/dev&quot;</span>, <span class="string">&quot;tmpfs&quot;</span>, MS_NOSUID, <span class="string">&quot;mode=0755&quot;</span>);</span><br><span class="line">    <span class="built_in">mkdir</span>(<span class="string">&quot;/dev/pts&quot;</span>, <span class="number">0755</span>);</span><br><span class="line">    <span class="built_in">mkdir</span>(<span class="string">&quot;/dev/socket&quot;</span>, <span class="number">0755</span>);</span><br><span class="line">    <span class="built_in">mount</span>(<span class="string">&quot;devpts&quot;</span>, <span class="string">&quot;/dev/pts&quot;</span>, <span class="string">&quot;devpts&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">mount</span>(<span class="string">&quot;proc&quot;</span>, <span class="string">&quot;/proc&quot;</span>, <span class="string">&quot;proc&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">mount</span>(<span class="string">&quot;sysfs&quot;</span>, <span class="string">&quot;/sys&quot;</span>, <span class="string">&quot;sysfs&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 必须在 / 以外的地方为 kmsg 和 null 创建设备节点，否则之后无法重新挂载 / 为只读，</span></span><br><span class="line">  <span class="comment">// 现在 tmpfs 已挂载在 /dev 上，可以跟外部世界沟通了</span></span><br><span class="line">  <span class="built_in">open_devnull_stdio</span>();</span><br><span class="line">  <span class="comment">// 初始化内核 log</span></span><br><span class="line">  <span class="built_in">klog_init</span>();</span><br><span class="line">  <span class="built_in">klog_set_level</span>(KLOG_NOTICE_LEVEL);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">NOTICE</span>(<span class="string">&quot;init%s started!\n&quot;</span>, is_first_stage ? <span class="string">&quot;&quot;</span> : <span class="string">&quot; second stage&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!is_first_stage) &#123;</span><br><span class="line">    <span class="comment">// 指示后台固件加载程序的 booting 流程</span></span><br><span class="line">    <span class="built_in">close</span>(<span class="built_in">open</span>(<span class="string">&quot;/dev/.booting&quot;</span>, O_WRONLY | O_CREAT | O_CLOEXEC, <span class="number">0000</span>));</span><br><span class="line">    <span class="comment">// 为属性服务创建内存空间</span></span><br><span class="line">    <span class="built_in">property_init</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">process_kernel_dt</span>();</span><br><span class="line">    <span class="built_in">process_kernel_cmdline</span>();</span><br><span class="line">    <span class="comment">// 从内核空间导出属性到内部，由 init 和其它属性使用</span></span><br><span class="line">    <span class="built_in">export_kernel_boot_props</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化 SELinux，如果处于内核空间，则加载 SELinux 策略</span></span><br><span class="line">  <span class="built_in">selinux_initialize</span>(is_first_stage);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 现在 SELinux 策略已经加载，如果此时处于内核空间，重新执行 init 以切换到 init 空间</span></span><br><span class="line">  <span class="keyword">if</span> (is_first_stage) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">restorecon</span>(<span class="string">&quot;/init&quot;</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="built_in">ERROR</span>(<span class="string">&quot;restorecon failed: %s\n&quot;</span>, <span class="built_in">strerror</span>(errno));</span><br><span class="line">      <span class="built_in">security_failure</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span>*path = argv[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">char</span>*args[] =&#123; path, <span class="keyword">const_cast</span> &lt; <span class="keyword">char</span>*&gt;(<span class="string">&quot;--second-stage&quot;</span>), <span class="literal">nullptr</span> &#125; ;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">execv</span>(path, args) == <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="built_in">ERROR</span>(<span class="string">&quot;execv(\&quot;%s\&quot;) failed: %s\n&quot;</span>, path, <span class="built_in">strerror</span>(errno));</span><br><span class="line">      <span class="built_in">security_failure</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这些目录必须在初始策略加载之前创建，因此需要将其安全上下文恢复到适当的值</span></span><br><span class="line">  <span class="built_in">INFO</span>(<span class="string">&quot;Running restorecon...\n&quot;</span>);</span><br><span class="line">  <span class="built_in">restorecon</span>(<span class="string">&quot;/dev&quot;</span>);</span><br><span class="line">  <span class="built_in">restorecon</span>(<span class="string">&quot;/dev/socket&quot;</span>);</span><br><span class="line">  <span class="built_in">restorecon</span>(<span class="string">&quot;/dev/__properties__&quot;</span>);</span><br><span class="line">  <span class="built_in">restorecon_recursive</span>(<span class="string">&quot;/sys&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建用于 epoll IO 多路复用机制的文件描述符</span></span><br><span class="line">  epoll_fd = <span class="built_in">epoll_create1</span>(EPOLL_CLOEXEC);</span><br><span class="line">  <span class="keyword">if</span> (epoll_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">ERROR</span>(<span class="string">&quot;epoll_create1 failed: %s\n&quot;</span>, <span class="built_in">strerror</span>(errno));</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化子进程退出的信号处理函数，并调用 epoll_ctl 注册信号可读时触发的回调函数</span></span><br><span class="line">  <span class="built_in">signal_handler_init</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 加载默认属性文件 /default.prop</span></span><br><span class="line">  <span class="built_in">property_load_boot_defaults</span>();</span><br><span class="line">  <span class="comment">// 启动属性监听服务，调用 epoll_ctl 注册属性可读时触发的回调函数</span></span><br><span class="line">  <span class="built_in">start_property_service</span>();</span><br><span class="line">  <span class="comment">// 解析 /init.rc 文件</span></span><br><span class="line">  <span class="built_in">init_parse_config_file</span>(<span class="string">&quot;/init.rc&quot;</span>);</span><br><span class="line">  <span class="comment">// 执行从 /init.rc 文件中解析出的 early-init 流程</span></span><br><span class="line">  <span class="built_in">action_for_each_trigger</span>(<span class="string">&quot;early-init&quot;</span>, action_add_queue_tail);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 等待冷启动操作的队列完成</span></span><br><span class="line">  <span class="built_in">queue_builtin_action</span>(wait_for_coldboot_done_action, <span class="string">&quot;wait_for_coldboot_done&quot;</span>);</span><br><span class="line">  <span class="built_in">queue_builtin_action</span>(mix_hwrng_into_linux_rng_action, <span class="string">&quot;mix_hwrng_into_linux_rng&quot;</span>);</span><br><span class="line">  <span class="comment">// 初始化实体组合键 </span></span><br><span class="line">  <span class="built_in">queue_builtin_action</span>(keychord_init_action, <span class="string">&quot;keychord_init&quot;</span>);</span><br><span class="line">  <span class="comment">// 初始化控制台，在屏幕底部显示“Android”</span></span><br><span class="line">  <span class="built_in">queue_builtin_action</span>(console_init_action, <span class="string">&quot;console_init&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 触发 init.rc 文件中的 init 流程</span></span><br><span class="line">  <span class="built_in">action_for_each_trigger</span>(<span class="string">&quot;init&quot;</span>, action_add_queue_tail);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">queue_builtin_action</span>(mix_hwrng_into_linux_rng_action, <span class="string">&quot;mix_hwrng_into_linux_rng&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 充电模式下不挂载文件系统和启动核心服务</span></span><br><span class="line">  <span class="keyword">char</span> bootmode[ PROP_VALUE_MAX];</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">property_get</span>(<span class="string">&quot;ro.bootmode&quot;</span>, bootmode) &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">strcmp</span>(bootmode, <span class="string">&quot;charger&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 执行 init.rc 文件中触发器为 on charger 触发器流程</span></span><br><span class="line">    <span class="built_in">action_for_each_trigger</span>(<span class="string">&quot;charger&quot;</span>, action_add_queue_tail);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">action_for_each_trigger</span>(<span class="string">&quot;late-init&quot;</span>, action_add_queue_tail);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 针对所有属性的触发器</span></span><br><span class="line">  <span class="built_in">queue_builtin_action</span>(queue_property_triggers_action, <span class="string">&quot;queue_property_triggers&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!waiting_for_exec) &#123;</span><br><span class="line">      <span class="built_in">execute_one_command</span>();</span><br><span class="line">      <span class="comment">// 重启进程</span></span><br><span class="line">      <span class="built_in">restart_processes</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> timeout = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (process_needs_restart) &#123;</span><br><span class="line">      timeout = (process_needs_restart - <span class="built_in">gettime</span>()) * <span class="number">1000</span>;</span><br><span class="line">      <span class="keyword">if</span> (timeout &lt; <span class="number">0</span>)</span><br><span class="line">        timeout = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">action_queue_empty</span>() || cur_action) &#123;</span><br><span class="line">      timeout = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">bootchart_sample</span>( &amp; timeout);</span><br><span class="line"></span><br><span class="line">    epoll_event ev;</span><br><span class="line">    <span class="comment">// 等待 epoll_fd 上的事件发生</span></span><br><span class="line">    <span class="keyword">int</span> nr = <span class="built_in">TEMP_FAILURE_RETRY</span>(<span class="built_in">epoll_wait</span>(epoll_fd, &amp; ev, <span class="number">1</span>, timeout));</span><br><span class="line">    <span class="keyword">if</span> (nr == <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="built_in">ERROR</span>(<span class="string">&quot;epoll_wait failed: %s\n&quot;</span>, <span class="built_in">strerror</span>(errno));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nr == <span class="number">1</span>) &#123;</span><br><span class="line">      ((<span class="built_in"><span class="keyword">void</span></span>( *)())ev.data.ptr)();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>init 首先处于内核空间，即 <code>is_first_stage = true</code>，在挂载几个关键设备节点和初始化 SELinux 之后，使用 <code>exec</code> 重新执行 init 进入 <code>second stage</code>，从而降低进程权限级别，从内核空间降低至 init 级别。</p>
<p>整个 init 流程所做的工作基本已经列举出来了，下面针对各个函数细节进行解析。</p>
<h1 id="内核日志"><a href="#内核日志" class="headerlink" title="内核日志"></a>内核日志</h1><p>在 Android 系统提供的 log 系统未初始化前，使用内核的 log 系统进行日志输出。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// init.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="built_in">klog_init</span>();</span><br><span class="line">  <span class="comment">// KLOG_NOTICE_LEVEL = 5</span></span><br><span class="line">  <span class="built_in">klog_set_level</span>(KLOG_NOTICE_LEVEL);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// klog.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KLOG_ERROR_LEVEL   3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KLOG_WARNING_LEVEL 4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KLOG_NOTICE_LEVEL  5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KLOG_INFO_LEVEL    6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KLOG_DEBUG_LEVEL   7</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// klog.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置日志级别</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">klog_set_level</span><span class="params">(<span class="keyword">int</span> level)</span> </span>&#123;</span><br><span class="line">  klog_level = level;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">klog_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (klog_fd &gt;= <span class="number">0</span>) <span class="keyword">return</span>; <span class="comment">/* Already initialized */</span></span><br><span class="line">  <span class="comment">// 打开 /dev/kmsg 设备节点</span></span><br><span class="line">  <span class="comment">// 内核日志可通过 cat /dev/kmsg 获取</span></span><br><span class="line">  klog_fd = open(<span class="string">&quot;/dev/kmsg&quot;</span>, O_WRONLY | O_CLOEXEC);</span><br><span class="line">  <span class="keyword">if</span> (klog_fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* name = <span class="string">&quot;/dev/__kmsg__&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> (mknod(name, S_IFCHR | <span class="number">0600</span>, (<span class="number">1</span> &lt;&lt; <span class="number">8</span>) | <span class="number">11</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    klog_fd = open(name, O_WRONLY | O_CLOEXEC);</span><br><span class="line">    unlink(name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">klog_writev</span><span class="params">(<span class="keyword">int</span> level, <span class="keyword">const</span> struct iovec* iov, <span class="keyword">int</span> iov_count)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 日志级别小于 klog_level 则输入内核日志中</span></span><br><span class="line">  <span class="keyword">if</span> (level &gt; klog_level) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (klog_fd &lt; <span class="number">0</span>) klog_init();</span><br><span class="line">  <span class="keyword">if</span> (klog_fd &lt; <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">  TEMP_FAILURE_RETRY(writev(klog_fd, iov, iov_count));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>


<h1 id="TEMP-FAILURE-RETRY-宏"><a href="#TEMP-FAILURE-RETRY-宏" class="headerlink" title="TEMP_FAILURE_RETRY 宏"></a>TEMP_FAILURE_RETRY 宏</h1><p><code>TEMP_FAILURE_RETRY</code> 是系统代码中常用的宏，用于在调用函数失败时进行不断重新调用，然后获得返回值：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> TEMP_FAILURE_RETRY</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TEMP_FAILURE_RETRY(exp) (&#123;       \</span></span><br><span class="line"><span class="meta">  typeof (exp) _rc;                      \</span></span><br><span class="line"><span class="meta">  do &#123;                                   \</span></span><br><span class="line"><span class="meta">    _rc = (exp);                         \</span></span><br><span class="line"><span class="meta">  &#125; while (_rc == -1 &amp;&amp; errno == EINTR); \</span></span><br><span class="line"><span class="meta">  _rc;                                   \</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>



<h1 id="信号处理"><a href="#信号处理" class="headerlink" title="信号处理"></a>信号处理</h1><p><code>single_handler_init</code> 用于处理子进程退出后的工作，通过捕捉 <code>SIGCHLD</code> 信号，根据 .rc 文件中的配置对子进程进行清理或者重启操作。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// init.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="built_in">signal_handler_init</span>();</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// signal_handler.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> signal_write_fd = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> signal_read_fd = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">wait_for_one_process</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> status;</span><br><span class="line">  <span class="comment">// 挂起当前进程，等待子进程退出，返回 0 表示子进程未结束</span></span><br><span class="line">  <span class="keyword">pid_t</span> pid = <span class="built_in">TEMP_FAILURE_RETRY</span>(<span class="built_in">waitpid</span>(<span class="number">-1</span>, &amp;status, WNOHANG));</span><br><span class="line">  <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">ERROR</span>(<span class="string">&quot;waitpid failed: %s\n&quot;</span>, <span class="built_in">strerror</span>(errno));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 查询相应系统服务</span></span><br><span class="line">  service* svc = <span class="built_in">service_find_by_pid</span>(pid);</span><br><span class="line"></span><br><span class="line">  std::string name;</span><br><span class="line">  <span class="keyword">if</span> (svc) &#123;</span><br><span class="line">    name = android::base::<span class="built_in">StringPrintf</span>(<span class="string">&quot;Service &#x27;%s&#x27; (pid %d)&quot;</span>, svc-&gt;name, pid);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    name = android::base::<span class="built_in">StringPrintf</span>(<span class="string">&quot;Untracked pid %d&quot;</span>, pid);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">NOTICE</span>(<span class="string">&quot;%s %s\n&quot;</span>, name.<span class="built_in">c_str</span>(), <span class="built_in">DescribeStatus</span>(status).<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!svc) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果标志为 SVC_ONESHOT（启动后不管）或 SVC_RESTART（重启），那么杀死进程</span></span><br><span class="line">  <span class="keyword">if</span> (!(svc-&gt;flags &amp; SVC_ONESHOT) || (svc-&gt;flags &amp; SVC_RESTART)) &#123;</span><br><span class="line">    <span class="built_in">NOTICE</span>(<span class="string">&quot;Service &#x27;%s&#x27; (pid %d) killing any children in process group\n&quot;</span>, svc-&gt;name, pid);</span><br><span class="line">    <span class="built_in">kill</span>(-pid, SIGKILL);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 移除 src 服务中所有创建过的 socket</span></span><br><span class="line">  <span class="keyword">for</span> (socketinfo* si = svc-&gt;sockets; si; si = si-&gt;next) &#123;</span><br><span class="line">    <span class="keyword">char</span> tmp[<span class="number">128</span>];</span><br><span class="line">    <span class="built_in">snprintf</span>(tmp, <span class="built_in"><span class="keyword">sizeof</span></span>(tmp), ANDROID_SOCKET_DIR<span class="string">&quot;/%s&quot;</span>, si-&gt;name);</span><br><span class="line">    <span class="built_in">unlink</span>(tmp);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 从服务列表移除 svc  </span></span><br><span class="line">  <span class="keyword">if</span> (svc-&gt;flags &amp; SVC_EXEC) &#123;</span><br><span class="line">    <span class="built_in">INFO</span>(<span class="string">&quot;SVC_EXEC pid %d finished...\n&quot;</span>, svc-&gt;pid);</span><br><span class="line">    waiting_for_exec = <span class="literal">false</span>;</span><br><span class="line">    <span class="built_in">list_remove</span>(&amp;svc-&gt;slist);</span><br><span class="line">    <span class="built_in">free</span>(svc-&gt;name);</span><br><span class="line">    <span class="built_in">free</span>(svc);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  svc-&gt;pid = <span class="number">0</span>;</span><br><span class="line">  svc-&gt;flags &amp;= (~SVC_RUNNING);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// oneshot 类型的服务将被标记为 disabled 状态，然后退出</span></span><br><span class="line">  <span class="comment">// except when manually restarted.</span></span><br><span class="line">  <span class="keyword">if</span> ((svc-&gt;flags &amp; SVC_ONESHOT) &amp;&amp; !(svc-&gt;flags &amp; SVC_RESTART)) &#123;</span><br><span class="line">    svc-&gt;flags |= SVC_DISABLED;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// disabled 和 reset 状态的进程不再自动重启</span></span><br><span class="line">  <span class="keyword">if</span> (svc-&gt;flags &amp; (SVC_DISABLED | SVC_RESET))  &#123;</span><br><span class="line">    svc-&gt;<span class="built_in">NotifyStateChange</span>(<span class="string">&quot;stopped&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">time_t</span> now = <span class="built_in">gettime</span>();</span><br><span class="line">  <span class="keyword">if</span> ((svc-&gt;flags &amp; SVC_CRITICAL) &amp;&amp; !(svc-&gt;flags &amp; SVC_RESTART)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (svc-&gt;time_crashed + CRITICAL_CRASH_WINDOW &gt;= now) &#123;</span><br><span class="line">      <span class="keyword">if</span> (++svc-&gt;nr_crashed &gt; CRITICAL_CRASH_THRESHOLD) &#123;</span><br><span class="line">        <span class="built_in">ERROR</span>(<span class="string">&quot;critical process &#x27;%s&#x27; exited %d times in %d minutes; &quot;</span></span><br><span class="line">              <span class="string">&quot;rebooting into recovery mode\n&quot;</span>, svc-&gt;name,</span><br><span class="line">              CRITICAL_CRASH_THRESHOLD, CRITICAL_CRASH_WINDOW / <span class="number">60</span>);</span><br><span class="line">        <span class="comment">// 服务在 4 分钟内重启超过 4 次，则重启设备至 recovery 模式</span></span><br><span class="line">        <span class="built_in">android_reboot</span>(ANDROID_RB_RESTART2, <span class="number">0</span>, <span class="string">&quot;recovery&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      svc-&gt;time_crashed = now;</span><br><span class="line">      svc-&gt;nr_crashed = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  svc-&gt;flags &amp;= (~SVC_RESTART);</span><br><span class="line">  svc-&gt;flags |= SVC_RESTARTING;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行 srv 服务中的 onrestart 命令 </span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">listnode</span>* <span class="title">node</span>;</span></span><br><span class="line">  <span class="built_in">list_for_each</span>(node, &amp;svc-&gt;onrestart.commands) &#123;</span><br><span class="line">    command* cmd = <span class="built_in">node_to_item</span>(node, struct command, clist);</span><br><span class="line">    cmd-&gt;<span class="built_in">func</span>(cmd-&gt;nargs, cmd-&gt;args);</span><br><span class="line">  &#125;</span><br><span class="line">  svc-&gt;<span class="built_in">NotifyStateChange</span>(<span class="string">&quot;restarting&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reap_any_outstanding_children</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="built_in">wait_for_one_process</span>()) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_epoll_handler</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> (*fn)())</span> </span>&#123;</span><br><span class="line">  epoll_event ev;</span><br><span class="line">  <span class="comment">// EPOLLIN 表示 fd 可读时触发</span></span><br><span class="line">  ev.events = EPOLLIN;</span><br><span class="line">  <span class="comment">// fn 为处理 fd 的调函数</span></span><br><span class="line">  ev.data.ptr = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span>*&gt;(fn);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">epoll_ctl</span>(epoll_fd, EPOLL_CTL_ADD, fd, &amp;ev) == <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="built_in">ERROR</span>(<span class="string">&quot;epoll_ctl failed: %s\n&quot;</span>, <span class="built_in">strerror</span>(errno));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handle_signal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">32</span>];</span><br><span class="line">  <span class="built_in">read</span>(signal_read_fd, buf, <span class="built_in"><span class="keyword">sizeof</span></span>(buf));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">reap_any_outstanding_children</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SIGCHLD_handler</span><span class="params">(<span class="keyword">int</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">TEMP_FAILURE_RETRY</span>(<span class="built_in">write</span>(signal_write_fd, <span class="string">&quot;1&quot;</span>, <span class="number">1</span>)) == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">ERROR</span>(<span class="string">&quot;write(signal_write_fd) failed: %s\n&quot;</span>, <span class="built_in">strerror</span>(errno));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">signal_handler_init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 创建用于 SIGCHLD 信号的匿名 socket 读写通道</span></span><br><span class="line">  <span class="keyword">int</span> s[<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">socketpair</span>(AF_UNIX, SOCK_STREAM | SOCK_NONBLOCK | SOCK_CLOEXEC, <span class="number">0</span>, s) == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">ERROR</span>(<span class="string">&quot;socketpair failed: %s\n&quot;</span>, <span class="built_in">strerror</span>(errno));</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  signal_write_fd = s[<span class="number">0</span>];</span><br><span class="line">  signal_read_fd = s[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 捕捉到 SIGCHLD 信号将写入 signal_write_fd 中</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act</span>;</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;act, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(act));</span><br><span class="line">  <span class="comment">// 信号处理函数</span></span><br><span class="line">  act.sa_handler = SIGCHLD_handler;</span><br><span class="line">  <span class="comment">// SA_NOCLDSTOP 使父进程在子进程暂停或继续运行时不会收到 SIGCHLD 信号,</span></span><br><span class="line">  <span class="comment">// 那么在子进程退出时收到</span></span><br><span class="line">  act.sa_flags = SA_NOCLDSTOP;</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGCHLD, &amp;act, <span class="number">0</span>);</span><br><span class="line">  <span class="comment">// 处理所有的子进程退出</span></span><br><span class="line">  <span class="built_in">reap_any_outstanding_children</span>();</span><br><span class="line">  <span class="comment">// 注册 signal_read_fd 可读时的回调为 handle_signal</span></span><br><span class="line">  <span class="built_in">register_epoll_handler</span>(signal_read_fd, handle_signal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>当子进程退出时，内核将发出 <code>SIGCHLD</code> 信号，对于子进程的处理函数 <code>singal_handler_init</code> 流程概括如下：</p>
<ol>
<li>首先建立一对 socket 匿名读写通道，从而持有一对读写文件描述符；</li>
<li>将子进程退出时的 <code>SIGCHLD</code> 信号回调函数（<code>SIGCHLD_handler</code>）绑定到 socket 写端，当有信号到来时，向写端写入“1”；</li>
<li>调用一次 <code>reap_any_outstanding_children</code> 处理目前子进程的退出情况；</li>
<li>使用 <code>epoll_ctl</code> IO 监听设置函数将 socket 读端的可读时机绑定到回调函数，当读端可被读取时（说明 socket 写端写入了数据），表明有子进程退出，此时调用回调函数（<code>handle_signal</code>）；</li>
<li><code>handle_signal</code> 处理子进程退出，使用 <code>wait_for_one_process</code> 等待子进程退出后，通过进程 pid 查询其所承载的服务，根据服务对应的标记，针对性的对进程进行清理或者重启处理。</li>
</ol>
<h2 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h2><p>使用时序图描述上述流程：</p>
<p><img src="./signal_handler.png" alt="signal_handler.png"></p>
<h1 id="属性服务"><a href="#属性服务" class="headerlink" title="属性服务"></a>属性服务</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// init.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> **args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> (!is_first_stage) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="built_in">property_init</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="built_in">property_load_boot_defaults</span>();</span><br><span class="line">  <span class="built_in">start_property_service</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// property_service.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> workspace pa_workspace;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">property_init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 防止重复初始化</span></span><br><span class="line">  <span class="keyword">if</span> (property_area_initialized) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  property_area_initialized = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用 mmap 创建一块共享内存区域，用于写入属性</span></span><br><span class="line">  <span class="comment">// 共享内存首地址保存至变量 __system_property_area__ 中</span></span><br><span class="line">  <span class="keyword">if</span> (__system_property_area_init()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  pa_workspace.size = <span class="number">0</span>;</span><br><span class="line">  pa_workspace.fd = <span class="built_in">open</span>(PROP_FILENAME, O_RDONLY | O_NOFOLLOW | O_CLOEXEC);</span><br><span class="line">  <span class="keyword">if</span> (pa_workspace.fd == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">ERROR</span>(<span class="string">&quot;Failed to open %s: %s\n&quot;</span>, PROP_FILENAME, <span class="built_in">strerror</span>(errno));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载默认属性文件</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">property_load_boot_defaults</span><span class="params">()</span> </span>&#123;</span><br><span class="line">2<span class="comment">// PROP_PATH_RAMDISK_DEFAULT = &quot;/default.prop&quot;</span></span><br><span class="line">  <span class="built_in">load_properties_from_file</span>(PROP_PATH_RAMDISK_DEFAULT, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">load_properties_from_file</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* filename, <span class="keyword">const</span> <span class="keyword">char</span>* filter)</span> </span>&#123;</span><br><span class="line">  Timer t;</span><br><span class="line">  std::string data;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">read_file</span>(filename, &amp;data)) &#123;</span><br><span class="line">    data.<span class="built_in">push_back</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    <span class="built_in">load_properties</span>(&amp;data[<span class="number">0</span>], filter);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">NOTICE</span>(<span class="string">&quot;(Loading properties from %s took %.2fs.)\n&quot;</span>, filename, t.<span class="built_in">duration</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">start_property_service</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// PROP_SERVICE_NAME = &quot;property_service&quot;</span></span><br><span class="line">  property_set_fd = <span class="built_in">create_socket</span>(PROP_SERVICE_NAME, SOCK_STREAM | SOCK_CLOEXEC | SOCK_NONBLOCK,</span><br><span class="line">                                  <span class="number">0666</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">if</span> (property_set_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">ERROR</span>(<span class="string">&quot;start_property_service socket creation failed: %s\n&quot;</span>, <span class="built_in">strerror</span>(errno));</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">listen</span>(property_set_fd, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">register_epoll_handler</span>(property_set_fd, handle_property_set_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handle_property_set_fd</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  prop_msg msg;</span><br><span class="line">  <span class="keyword">int</span> s;</span><br><span class="line">  <span class="keyword">int</span> r;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ucred</span> <span class="title">cr</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">addr</span>;</span></span><br><span class="line">  <span class="keyword">socklen_t</span> addr_size = <span class="built_in"><span class="keyword">sizeof</span></span>(addr);</span><br><span class="line">  <span class="keyword">socklen_t</span> cr_size = <span class="built_in"><span class="keyword">sizeof</span></span>(cr);</span><br><span class="line">  <span class="keyword">char</span> * source_ctx = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">ufds</span>[1];</span></span><br><span class="line">  <span class="comment">// 阻塞超时时间</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">int</span> timeout_ms = <span class="number">2</span> * <span class="number">1000</span>;</span><br><span class="line">  <span class="keyword">int</span> nr;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 监听属性服务 socket 描述符</span></span><br><span class="line">  <span class="keyword">if</span> ((s = <span class="built_in">accept</span>(property_set_fd, (struct sockaddr *) &amp;addr, &amp;addr_size)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getsockopt</span>(s, SOL_SOCKET, SO_PEERCRED, &amp;cr, &amp;cr_size) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">close</span>(s);</span><br><span class="line">    <span class="built_in">ERROR</span>(<span class="string">&quot;Unable to receive socket options\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ufds[<span class="number">0</span>].fd = s;</span><br><span class="line">  ufds[<span class="number">0</span>].events = POLLIN;</span><br><span class="line">  ufds[<span class="number">0</span>].revents = <span class="number">0</span>;</span><br><span class="line">  nr = <span class="built_in">TEMP_FAILURE_RETRY</span>(<span class="built_in">poll</span>(ufds, <span class="number">1</span>, timeout_ms));</span><br><span class="line">  <span class="keyword">if</span> (nr == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">ERROR</span>(<span class="string">&quot;sys_prop: timeout waiting for uid=%d to send property message.\n&quot;</span>, cr.uid);</span><br><span class="line">    <span class="built_in">close</span>(s);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nr &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">ERROR</span>(<span class="string">&quot;sys_prop: error waiting for uid=%d to send property message: %s\n&quot;</span>, cr.uid, <span class="built_in">strerror</span>(errno));</span><br><span class="line">    <span class="built_in">close</span>(s);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 收到属性设置命令</span></span><br><span class="line">  r = <span class="built_in">TEMP_FAILURE_RETRY</span>(<span class="built_in">recv</span>(s, &amp;msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), MSG_DONTWAIT));</span><br><span class="line">  <span class="keyword">if</span>(r != <span class="built_in"><span class="keyword">sizeof</span></span>(prop_msg)) &#123;</span><br><span class="line">    <span class="built_in">ERROR</span>(<span class="string">&quot;sys_prop: mis-match msg size received: %d expected: %zu: %s\n&quot;</span>,</span><br><span class="line">          r, <span class="built_in"><span class="keyword">sizeof</span></span>(prop_msg), <span class="built_in">strerror</span>(errno));</span><br><span class="line">    <span class="built_in">close</span>(s);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in"><span class="keyword">switch</span></span>(msg.cmd) &#123;</span><br><span class="line">  <span class="comment">// setprop 命令</span></span><br><span class="line">  <span class="keyword">case</span> PROP_MSG_SETPROP:</span><br><span class="line">    msg.name[PROP_NAME_MAX<span class="number">-1</span>] = <span class="number">0</span>;</span><br><span class="line">    msg.value[PROP_VALUE_MAX<span class="number">-1</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断属性名是否合法，只允许数字 + &#x27;.&#x27;, &#x27;-&#x27;, &#x27;@&#x27;, &#x27;:&#x27;  或 &#x27;_&#x27; 符号</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">is_legal_property_name</span>(msg.name, <span class="built_in">strlen</span>(msg.name))) &#123;</span><br><span class="line">      <span class="built_in">ERROR</span>(<span class="string">&quot;sys_prop: illegal property name. Got: \&quot;%s\&quot;\n&quot;</span>, msg.name);</span><br><span class="line">      <span class="built_in">close</span>(s);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">getpeercon</span>(s, &amp;source_ctx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">memcmp</span>(msg.name,<span class="string">&quot;ctl.&quot;</span>,<span class="number">4</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 对 ctl.xxx 类似的控制属性进行响应，例如使用 shell 执行 setprop ctl.stop zygote 将停止 zygote 进程</span></span><br><span class="line">      <span class="built_in">close</span>(s);</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">check_control_mac_perms</span>(msg.value, source_ctx)) &#123;</span><br><span class="line">        <span class="built_in">handle_control_message</span>((<span class="keyword">char</span>*) msg.name + <span class="number">4</span>, (<span class="keyword">char</span>*) msg.value);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">ERROR</span>(<span class="string">&quot;sys_prop: Unable to %s service ctl [%s] uid:%d gid:%d pid:%d\n&quot;</span>,</span><br><span class="line">                msg.name + <span class="number">4</span>, msg.value, cr.uid, cr.gid, cr.pid);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 检查是否有权限设置属性</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">check_perms</span>(msg.name, source_ctx)) &#123;</span><br><span class="line">      	<span class="comment">// 设置属性</span></span><br><span class="line">        <span class="built_in">property_set</span>((<span class="keyword">char</span>*) msg.name, (<span class="keyword">char</span>*) msg.value);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">ERROR</span>(<span class="string">&quot;sys_prop: permission denied uid:%d  name:%s\n&quot;</span>,</span><br><span class="line">              cr.uid, msg.name);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">close</span>(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">freecon</span>(source_ctx);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="built_in">close</span>(s);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">property_set_impl</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* name, <span class="keyword">const</span> <span class="keyword">char</span>* value)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> namelen = <span class="built_in">strlen</span>(name);</span><br><span class="line">  <span class="keyword">size_t</span> valuelen = <span class="built_in">strlen</span>(value);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">is_legal_property_name</span>(name, namelen)) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> (valuelen &gt;= PROP_VALUE_MAX) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(<span class="string">&quot;selinux.reload_policy&quot;</span>, name) == <span class="number">0</span> &amp;&amp; <span class="built_in">strcmp</span>(<span class="string">&quot;1&quot;</span>, value) == <span class="number">0</span>) &#123;</span><br><span class="line">2  <span class="keyword">if</span> (<span class="built_in">selinux_reload_policy</span>() != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">ERROR</span>(<span class="string">&quot;Failed to reload policy\n&quot;</span>);</span><br><span class="line">2  &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(<span class="string">&quot;selinux.restorecon_recursive&quot;</span>, name) == <span class="number">0</span> &amp;&amp; valuelen &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">restorecon_recursive</span>(value) != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">ERROR</span>(<span class="string">&quot;Failed to restorecon_recursive %s\n&quot;</span>, value);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  prop_info* pi = (prop_info*) __system_property_find(name);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(pi != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// ro.x 属性一旦设定就无法更改</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strncmp</span>(name, <span class="string">&quot;ro.&quot;</span>, <span class="number">3</span>)) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">// 更新属性，写入为属性创建的共享内存区域</span></span><br><span class="line">    __system_property_update(pi, value, valuelen);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">int</span> rc = __system_property_add(name, namelen, value, valuelen);</span><br><span class="line">    <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> rc;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果名字前缀为 &quot;net.&quot; 则视为 DNS 属性</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strncmp</span>(<span class="string">&quot;net.&quot;</span>, name, <span class="built_in">strlen</span>(<span class="string">&quot;net.&quot;</span>)) == <span class="number">0</span>)  &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(<span class="string">&quot;net.change&quot;</span>, name) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// &quot;net.change&quot; 是一个特殊的属性，用于跟踪 &quot;net.x&quot; 属性的更新，</span></span><br><span class="line">    <span class="comment">// 它的值包含最后一次设置的 &quot;net.*&quot; 属性</span></span><br><span class="line">    <span class="built_in">property_set</span>(<span class="string">&quot;net.change&quot;</span>, name);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (persistent_properties_loaded &amp;&amp;</span><br><span class="line">        <span class="built_in">strncmp</span>(<span class="string">&quot;persist.&quot;</span>, name, <span class="built_in">strlen</span>(<span class="string">&quot;persist.&quot;</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 不要将属性写入磁盘，直到读取了所有的默认属性，防止被默认属性覆盖</span></span><br><span class="line">    <span class="built_in">write_persistent_property</span>(name, value);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 通知属性被更改，将可能触发 init.rc 中的 property 触发器</span></span><br><span class="line">  <span class="built_in">property_changed</span>(name, value);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">property_set</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* name, <span class="keyword">const</span> <span class="keyword">char</span>* value)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> rc = <span class="built_in">property_set_impl</span>(name, value);</span><br><span class="line">  <span class="keyword">if</span> (rc == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">ERROR</span>(<span class="string">&quot;property_set(\&quot;%s\&quot;, \&quot;%s\&quot;) failed\n&quot;</span>, name, value);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>概括属性服务初始化流程如下：</p>
<ol>
<li><code>property_init</code> 为属性的设置和获取创建共享内存区域；</li>
<li><code>property_load_boot_defaults</code> 加载默认属性文件 <code>/default.prop</code>；</li>
<li><code>start_property_service</code> 启动属性设置服务，创建名为 <code>property_service</code> 的 socket 服务端，当接收到属性设置请求时，检查权限设置属性，阻止设置 <code>ro.*</code> 的属性，当设置 <code>ctl.*</code> 属性时作出相应处理，通知属性变更，触发 init.rc 中依赖的 property 触发器。</li>
</ol>
<p><code>setprop</code> 命令（实现代码在 external/toybox/toys/android/setprop.c），将会通过 socket 发送设置属性的请求。</p>
<p>除了上述属性初始化过程中加载的 <code>/default.prop</code> 属性文件，init 通过解析 init.rc 文件执行其中的 <code>load_all_props</code> 步骤（高系统版本为 <code>load_system_props</code>）还会从以下位置依次加载属性文件：</p>
<table>
<thead>
<tr>
<th>文件</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>/default.prop</td>
<td>初始设置，此文件属于 initramfs，所以不存在于设备的闪存分区上</td>
</tr>
<tr>
<td>/system/build.prop</td>
<td>编译 Android 系统时产生的设置</td>
</tr>
<tr>
<td>/system/default.prop</td>
<td>通常为厂商添加的设置</td>
</tr>
<tr>
<td>/data/local.prop</td>
<td>编译时使用了 <code>ALLOW_LOCAL_PROP_OVERRIDE</code> 选项，且 <code>ro.debuggable</code> 属性被设置为 1 时，就会加载这个文件。那么开发者可以通过在 /data 分区 push 一个文件的方式，修改之前的设置</td>
</tr>
<tr>
<td>/data/proper/persist.</td>
<td>重启后不会丢失的属性，这些属性的前缀为 <code>persist</code></td>
</tr>
<tr>
<td>/factory/factory.prop</td>
<td>较新版本的 Android 不再支持了</td>
</tr>
</tbody></table>
<h1 id="init-rc-文件"><a href="#init-rc-文件" class="headerlink" title="init.rc 文件"></a>init.rc 文件</h1><p>解析并根据 init.rc 文件内容启动相应的守护进程是 init 进程的核心工作，servicemanager 和 zygote 等服务均是 init 进程通过解析 init.rc 文件的创建的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// init.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="built_in">init_parse_config_file</span>(<span class="string">&quot;/init.rc&quot;</span>);</span><br><span class="line">  <span class="built_in">action_for_each_trigger</span>(<span class="string">&quot;early-init&quot;</span>, action_add_queue_tail);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="built_in">action_for_each_trigger</span>(<span class="string">&quot;init&quot;</span>, action_add_queue_tail);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>init_parse_config_file</code> 首先解析 init.rc 文件，.rc 文件是用 .rc 文件的特定语法编写的，从 .rc 文件中可以解析出多个阶段的执行流程，例如 <code>early-init</code>，<code>init</code> 等，每个阶段有不同的意义。</p>
<p>init.rc 文件中还导入了许多子 .rc 文件，均是按照 .rc 文件语法编写。</p>
<h2 id="rc-文件语法"><a href="#rc-文件语法" class="headerlink" title=".rc 文件语法"></a>.rc 文件语法</h2><p>.rc 文件的语法由 trigger 语句块和 service 语句块构成：</p>
<p>trigger 语句块中的命令，会在满足触发条件时被触发执行；service 语句描述需要启动的守护进程。</p>
<p>trigger 语句块的格式是，使用 <code>on</code> 开头，后面跟一个参数，这个参数可以是各个启动阶段的名称（例如 <code>early-init</code>）或者一个 <code>property</code> 关键字，<code>property</code> 后面是冒号 +“属性名=属性值”的格式，这种情况下，触发条件为相应属性的属性值变更为指定的值；</p>
<p>service 语句块的后面跟着服务名称和命令行。</p>
<p>语句块中执行指定动作（action）或命令（command），执行时，init 会分别把属性 init.action 或 init.command 的值设为当前正在执行的动作的名称或当前正在执行命令的名称。</p>
<p>service 语句块下面可以赋予多种选项（option），用来指示服务进程的运行规则，以及进程死亡后的重启规则。</p>
<h2 id="init-启动阶段"><a href="#init-启动阶段" class="headerlink" title="init 启动阶段"></a>init 启动阶段</h2><p>下面是 .rc 文件中的典型阶段（按启动顺序排列），根据设备不同，不同厂商可能对其进行定制：</p>
<table>
<thead>
<tr>
<th>启动阶段</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td>early-init</td>
<td>初始化的第一个阶段，用于设置 SELinux 和 OOM</td>
</tr>
<tr>
<td>init</td>
<td>创建文件系统，mount 点以及写内核变量</td>
</tr>
<tr>
<td>late-init</td>
<td>初始化晚期，挂载文件系统，启动核心系统服务</td>
</tr>
<tr>
<td>early-fs</td>
<td>文件系统半准备被 mount 前需要完成的工作</td>
</tr>
<tr>
<td>fs</td>
<td>专门用于加载各个分区</td>
</tr>
<tr>
<td>post-fs</td>
<td>在各个文件系统（/data 分区除外）mount 完毕之后需要执行的命令</td>
</tr>
<tr>
<td>post-fs-data</td>
<td>解密 /data 分区（如果需要），并 mount 之</td>
</tr>
<tr>
<td>early-boot</td>
<td>在属性服务（property service）初始化之后，启动剩余内容之前的作业</td>
</tr>
<tr>
<td>boot</td>
<td>正常启动命令</td>
</tr>
<tr>
<td>charger</td>
<td>当手机处于充电模式时，需要执行的命令</td>
</tr>
</tbody></table>
<h2 id="init-支持的-command"><a href="#init-支持的-command" class="headerlink" title="init 支持的 command"></a>init 支持的 command</h2><p>列举 .rc 文件中支持的大部分命令，一部分和 shell 命令具有相同作用：</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>bootchart_init</td>
<td>启用启动时的信任链验证</td>
</tr>
<tr>
<td>chdir directory</td>
<td>等价于 <code>cd</code> 命令（调用 <code>chdir</code>）</td>
</tr>
<tr>
<td>chmod octal_perms file</td>
<td>修改文件的指定权限（以 8 进制表示）</td>
</tr>
<tr>
<td>chown user group file</td>
<td>等价于 <code>chown user:group file</code> 命令</td>
</tr>
<tr>
<td>croot directory</td>
<td>等价于 Linux 的 chroot 命令（调用 chroot(2)）</td>
</tr>
<tr>
<td>class_reset service_class</td>
<td>停止与 <code>service_class</code> 相关的所有服务</td>
</tr>
<tr>
<td>class_[start|stop] class</td>
<td>启动或者停止 <code>class</code> 参数指定的 <code>service_class</code> 的所有服务</td>
</tr>
<tr>
<td>copy src_file dst_file</td>
<td>类似 <code>cp(1)</code> 命令</td>
</tr>
<tr>
<td>exec command</td>
<td>执行命令</td>
</tr>
<tr>
<td>enable service</td>
<td>启动一个已被 disable 的服务</td>
</tr>
<tr>
<td>export varible value</td>
<td>在全局环境中，设置环境变量 <code>varible</code> 的值，影响所有进程</td>
</tr>
<tr>
<td>insmod module.ko</td>
<td>加载一个内核模块</td>
</tr>
<tr>
<td>load_all_props</td>
<td>加载所有位置属性</td>
</tr>
<tr>
<td>load_persist_props</td>
<td>加载 /data/propert 目录中的各个文件中的属性</td>
</tr>
<tr>
<td>loglevel level</td>
<td>设置内核的日志级别</td>
</tr>
<tr>
<td>mkdir directory</td>
<td>创建一个目录（调用 <code>mkdir(2)</code>）</td>
</tr>
<tr>
<td>[re]start service_name</td>
<td>启动/重启服务名与参数 service_name 一致的语句块中的服务</td>
</tr>
<tr>
<td>rm[dir] filename</td>
<td>删除一个文件或一个目录（调用 <code>unlink(2)/dmdir(2)</code>）</td>
</tr>
<tr>
<td>restorecon[_recursive] path</td>
<td>用 <code>path</code> 参数指定文件重新加载 SELinux 上下文</td>
</tr>
<tr>
<td>setcon SEcontext</td>
<td>设置 SELinux 的上下文，init 上下文为 <code>u:r:init:s0</code></td>
</tr>
<tr>
<td>setenforce[0|1]</td>
<td>强制启用或关闭 SELinux</td>
</tr>
<tr>
<td>setprop key value</td>
<td>设置指定的系统属性</td>
</tr>
<tr>
<td>stop service_name</td>
<td>停止服务名与参数 service_name 一致的语句块中的服务</td>
</tr>
<tr>
<td>symlink target src</td>
<td>创建一个符号连接 ln-s，即调用 <code>symlink(2)</code></td>
</tr>
<tr>
<td>trgger trigger_name</td>
<td>激活一个 trigger 语句块（会使 init 重新运行该语句块）</td>
</tr>
<tr>
<td>wait file timeout</td>
<td>等待文件 file 创建完毕，等待超时为 timeout 秒</td>
</tr>
<tr>
<td>write file value</td>
<td>把 value 写到文件 file 中去，等价于 <code>echo value &gt; file</code></td>
</tr>
</tbody></table>
<h2 id="init-支持的-option"><a href="#init-支持的-option" class="headerlink" title="init 支持的 option"></a>init 支持的 option</h2><p>枚举出 init 支持的各个 option 关键字：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>capability</td>
<td>支持 Linux 的 <code>capability(7)</code></td>
</tr>
<tr>
<td>class</td>
<td>把服务加入服务组（service group），`可用 class[start</td>
</tr>
<tr>
<td>console</td>
<td>把服务定义为一个 console 服务，stdin/stdout/stderr 会被 link 到 /dev/console 上</td>
</tr>
<tr>
<td>critial</td>
<td>把服务定义为一个关键服务，一旦崩溃，会自动重启，超过一定次数，系统将重启至 recovery 模式</td>
</tr>
<tr>
<td>disable</td>
<td>表示服务不需要启动但，之后还可以手动重启</td>
</tr>
<tr>
<td>group</td>
<td>指定服务以指定的 gid 启动，init 会调用 <code>setgid(2)</code> 来完成这个操作</td>
</tr>
<tr>
<td>ioprio</td>
<td>指定服务的 I/O 优先级，init 会调用 <code>ioprio_set</code> 来完成这个任务</td>
</tr>
<tr>
<td>keycodes</td>
<td>指定触发服务的组合键（key chord）</td>
</tr>
<tr>
<td>oneshot</td>
<td>告诉 init 启动该服务，然后就不管它了（忽略掉 <code>SIGCHLD</code> 信号）</td>
</tr>
<tr>
<td>onrestart</td>
<td>枚举该服务重启时要执行的命令，通常用来重启其他依赖服务（dependent service）</td>
</tr>
<tr>
<td>seclabel</td>
<td>指定应用在该服务上 SELinux 标签（label）</td>
</tr>
<tr>
<td>setenv</td>
<td>在服务被 <code>fork()</code> 出来并 <code>exec()</code> 之前，设置环境变量，只有该服务可看到</td>
</tr>
<tr>
<td>socket</td>
<td>打开一个 socket，让该服务继承这个 socket</td>
</tr>
<tr>
<td>user</td>
<td>指定该服务以 uid 身份运行，init 将调用 <code>setuid(2)</code> 完成这个任务</td>
</tr>
<tr>
<td>writepid</td>
<td>把子进程的 pid 写入指定文件中，用于设置 cgroups 资源控制</td>
</tr>
</tbody></table>
<h1 id="关键服务启动"><a href="#关键服务启动" class="headerlink" title="关键服务启动"></a>关键服务启动</h1><p>查看一下 servicemanager、surfacefliger 和 zygote 服务在 init.rc 文件中的启动配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># init.rc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">service servicemanager /system/bin/servicemanager</span><br><span class="line">    class core</span><br><span class="line">    user system</span><br><span class="line">    group system</span><br><span class="line">    critical</span><br><span class="line">    onrestart restart healthd</span><br><span class="line">    onrestart restart zygote</span><br><span class="line">    onrestart restart media</span><br><span class="line">    onrestart restart surfaceflinger</span><br><span class="line">    onrestart restart drm</span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">service surfaceflinger /system/bin/surfaceflinger</span><br><span class="line">    class core</span><br><span class="line">    user system</span><br><span class="line">    group graphics drmrpc</span><br><span class="line">    onrestart restart zygote</span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure>

<p>zygote 服务的启动在单独的 .rc 文件中，这个 rc 文件在 init.rc 的开头被导入：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># init.rc</span></span><br><span class="line"></span><br><span class="line">import /init.environ.rc</span><br><span class="line">import /init.usb.rc</span><br><span class="line">import /init.<span class="variable">$&#123;ro.hardware&#125;</span>.rc</span><br><span class="line">import /init.<span class="variable">$&#123;ro.zygote&#125;</span>.rc</span><br><span class="line">import /init.trace.rc</span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure>

<p><code>$&#123;ro.zygote&#125;</code> 表示 32 位和 64 位 zygote，这里看一下 32 位 zygote 启动描述：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># init.zygote32.rc</span></span><br><span class="line"></span><br><span class="line">service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server</span><br><span class="line">    class main</span><br><span class="line">    priority -20</span><br><span class="line">    user root</span><br><span class="line">    group root readproc reserved_disk</span><br><span class="line">    socket zygote stream 660 root system</span><br><span class="line">    onrestart write /sys/android_power/request_state wake</span><br><span class="line">    onrestart write /sys/power/state on</span><br><span class="line">    onrestart restart audioserver</span><br><span class="line">    onrestart restart cameraserver</span><br><span class="line">    onrestart restart media</span><br><span class="line">    onrestart restart netd</span><br><span class="line">    onrestart restart wificond</span><br><span class="line">    writepid /dev/cpuset/foreground/tasks</span><br></pre></td></tr></table></figure>

<p>所有的 service 里面只有 servicemanager、zygote、surfaceflinger 这 3 个服务有 onrestart 关键字来触发其他 service 启动过程。</p>
<p>可以看到它们之间的依赖关系：</p>
<ol>
<li>zygote 重启将会触发 audioserver、cameraserver、media 以及相关子进程（包括 system_server 进程）重启；</li>
<li>system_server 重启将会触发 zygote 重启；</li>
<li>surfaceflinger 重启将会触发 zygote 重启；</li>
<li>servicemanager 重启将会触发 zygote、healthd、media、surfaceflinger、drm 重启。</li>
</ol>
<p><code>class</code> 表示依赖的服务组，看到 servicemanager 和 surfaceflinger 属于 <code>core</code>，而 zygote 属于 <code>main</code>。</p>
<p>在 init.rc 文件中查找这些服务组的启动时机：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># init.rc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">on early-init</span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">on init</span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">on late-init</span><br><span class="line">    trigger early-fs</span><br><span class="line">    trigger fs</span><br><span class="line">    trigger post-fs</span><br><span class="line">    trigger post-fs-data</span><br><span class="line">    trigger load_all_props_action</span><br><span class="line">    trigger firmware_mounts_complete</span><br><span class="line">    trigger early-boot</span><br><span class="line">    trigger boot</span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">on boot</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    class_start core</span><br><span class="line"></span><br><span class="line">on nonencrypted</span><br><span class="line">    class_start main</span><br><span class="line">    class_start late_start</span><br><span class="line"></span><br><span class="line">on property:vold.decrypt=trigger_encryption</span><br><span class="line">    start surfaceflinger</span><br><span class="line">    start encrypt</span><br><span class="line"></span><br><span class="line">on property:vold.decrypt=trigger_reset_main</span><br><span class="line">    class_reset main</span><br><span class="line"></span><br><span class="line">on property:vold.decrypt=trigger_post_fs_data</span><br><span class="line">    trigger post-fs-data</span><br><span class="line"></span><br><span class="line">on property:vold.decrypt=trigger_restart_min_framework</span><br><span class="line">    class_start main</span><br><span class="line"></span><br><span class="line">on property:vold.decrypt=trigger_restart_framework</span><br><span class="line">    class_start main</span><br><span class="line">    class_start late_start</span><br><span class="line"></span><br><span class="line">on property:vold.decrypt=trigger_shutdown_framework</span><br><span class="line">    class_reset late_start</span><br><span class="line">    class_reset main</span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure>

<p>看到 core 服务组，在 boot 阶段被启动，优先与 main 服务组，boot 由 late-init 阶段触发；main 服务组在 <code>vold.decrypt</code> 属性被改变的多处时机被触发，这些属性将在 vold 服务启动时的相关流程被触发。</p>
<p>下面是 vold 服务的启动内容：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># init.rc</span></span><br><span class="line"></span><br><span class="line">service vold /system/bin/vold \</span><br><span class="line">        --blkid_context=u:r:blkid:s0 --blkid_untrusted_context=u:r:blkid_untrusted:s0 \</span><br><span class="line">        --fsck_context=u:r:fsck:s0 --fsck_untrusted_context=u:r:fsck_untrusted:s0</span><br><span class="line">    class core</span><br><span class="line">    socket vold stream 0660 root mount</span><br><span class="line">    socket cryptd stream 0660 root mount</span><br><span class="line">    ioprio be 2</span><br></pre></td></tr></table></figure>

<p>vold 是用于管理和控制 Android 外部存储介质的服务进程，它的实现代码在 <code>system/vold/cryptfs.c</code> 中。</p>
<h2 id="zygote"><a href="#zygote" class="headerlink" title="zygote"></a>zygote</h2><p>以 zygote 服务为出发点，分析启动一个服务的具体代码。</p>
<p>前面 init.cpp 中，调用 <code>init_parse_config_file(&quot;/init.rc&quot;)</code> 解析 init.rc 文件，内部会辗转调用到 <code>parse_service</code> 函数，它用来解析 service 信息，会创建一个 <code>service</code> 的结构体，保存服务进程的信息，同时创建了一个 socket，保存在结构体成员 <code>socketinfo *sockets</code> 中，同时 onrestart 相关的信息存放在成员 <code>action onrestart</code> 中，<code>action</code> 也是一个结构体，存放相关执行动作：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// init.h</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">service</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">NotifyStateChange</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* new_state)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">listnode</span> <span class="title">slist</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *classname;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> flags;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">uid_t</span> uid;</span><br><span class="line">    <span class="keyword">gid_t</span> gid;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">socketinfo</span> *<span class="title">sockets</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">svcenvinfo</span> *<span class="title">envvars</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">action</span> <span class="title">onrestart</span>;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>触发启动服务的代码由 <code>do_class_start</code> 函数负责，它的实现在 <code>/system/core/init/builtins.cpp</code> 中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">service_start_if_not_disabled</span><span class="params">(struct service *svc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(svc-&gt;flags &amp; SVC_DISABLED)) &#123;</span><br><span class="line">        <span class="comment">// 启动服务</span></span><br><span class="line">        <span class="built_in">service_start</span>(svc, <span class="literal">NULL</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        svc-&gt;flags |= SVC_DISABLED_START;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_class_start</span><span class="params">(<span class="keyword">int</span> nargs, <span class="keyword">char</span> **args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">service_for_each_class</span>(args[<span class="number">1</span>], service_start_if_not_disabled);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>service_start</code> 函数中会首先使用 <code>fork</code> 创建子进程，然后在子进程中调用 <code>execve(svc-&gt;args[0], (char**) svc-&gt;args, (char**) ENV)</code> 执行 zygote 的可执行程序 <code>/system/bin/app_process</code>，从而进入 zygote 的流程中。</p>
<p>zygote 的实现代码在 <code>/frameworks/base/cmds/app_process/app_main.cpp</code> 中。</p>
<p>至于其他服务的启动，以此类推。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>到这里就分析完了 init 进程的整个流程，这对于了解之后的系统服务的启动流程奠定了基础。</p>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p>相关概念的解释</p>
<h2 id="IO-多路复用"><a href="#IO-多路复用" class="headerlink" title="IO 多路复用"></a>IO 多路复用</h2><p>阻塞 I/O（Blocking IO）：</p>
<p>例如用户进程使用 <code>recvfrom</code> 系统调用，kernel 开始准备数据，对于 Network IO，很多数据一开始没有到达，需要等待，此时用户进程将被阻塞，当 kernel 等到数据准备好的时候，将数据从内核空间拷贝到用户空间，返回结果，此时用户进程解除 block 状态。</p>
<p>IO 多路复用（IO multiplexing）：</p>
<p>和阻塞 IO 类似，在发出时会被阻塞，但可以等待多个数据报就绪（datagram ready），即可以处理多个链接。例如 select，它相当于一个代理，用户进程调用后会被阻塞，此时 select 在内核空间会监听多个 datagram（如 socket 连接），如果启动一个数据就绪了就返回。</p>
<h2 id="僵尸进程"><a href="#僵尸进程" class="headerlink" title="僵尸进程"></a>僵尸进程</h2><p>僵尸进程是指当子进程比父进程先结束，而父进程又没有回收子进程，释放子进程的资源，此时子进程将成为一个僵尸进程。如果父进程先退出，则子进程被 init 进程接管，子进程退出后 init 会回收其占用的相关资源。</p>
<p>系统会为僵尸进程保存一定的信息，包括 pid 和运行时间等，系统所能使用的进程号是有限的，如果产生大量的僵尸进程，将因为没有可用的进程号而导致系统不能产生新的进程。</p>
<p>僵尸进程的避免：</p>
<ol>
<li>父进程通过 <code>wait</code> 和 <code>waitpid</code> 等函数等待子进程结束，这会导致父进程挂起；</li>
<li>如果父进程很忙，那么可以用 signal 函数为 <code>SIGCHLD</code> 安装 handler，因为子进程结束后， 父进程会收到该信号，可以在 handler 中调用 <code>wait</code> 回收；</li>
<li>如果父进程不关心子进程什么时候结束，那么可以用 signal（<code>SIGCHLD</code>，<code>SIG_IGN</code>） 通知内核，自己对子进程的结束不感兴趣，那么子进程结束后，内核会回收， 并不再给父进程发送信号；</li>
<li>还有一些技巧，就是 <code>fork</code> 两次，父进程 <code>fork</code> 一个子进程，然后继续工作，子进程 <code>fork</code> 一个孙进程后退出，那么孙进程被 init 接管，孙进程结束后，init 会回收。不过子进程的回收 还要自己做。</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><p><a target="_blank" rel="noopener" href="http://gityuan.com/2016/02/05/android-init/">http://gityuan.com/2016/02/05/android-init/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ljx0305/article/details/4065058">https://blog.csdn.net/ljx0305/article/details/4065058</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/6a6845464770">https://www.jianshu.com/p/6a6845464770</a></p>
</li>
<li><p>《最强 Android 书：架构大剖析》</p>
</li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>Android init 进程启动分析</p><p><a href="https://l0neman.github.io/2020/08/17/android-init-进程启动分析/">https://l0neman.github.io/2020/08/17/android-init-进程启动分析/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>l0neman</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2020-08-17</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2020-08-17</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/android/">Android</a><a class="link-muted mr-2" rel="tag" href="/tags/zygote/">Zygote</a></div><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5f0f12c19a2af379" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/qrcode/alipay.jpg" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/qrcode/wxpay.jpg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/08/24/android-zygote-%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E5%88%86%E6%9E%90/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Android zygote 进程启动分析</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/08/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%90%AF%E5%8A%A8%E5%8E%9F%E7%90%86/"><span class="level-item">计算机启动原理</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><script src="https://utteranc.es/client.js" repo="l0neman/l0neman.github.io" issue-term="pathname" label="comment" theme="github-light" crossorigin="anonymous" async></script></div></div></div><!--!--><div class="column column-right  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#前言"><span class="level-left"><span class="level-item">1</span><span class="level-item">前言</span></span></a></li><li><a class="level is-mobile" href="#概述"><span class="level-left"><span class="level-item">2</span><span class="level-item">概述</span></span></a></li><li><a class="level is-mobile" href="#init-进程入口"><span class="level-left"><span class="level-item">3</span><span class="level-item">init 进程入口</span></span></a></li><li><a class="level is-mobile" href="#内核日志"><span class="level-left"><span class="level-item">4</span><span class="level-item">内核日志</span></span></a></li><li><a class="level is-mobile" href="#TEMP-FAILURE-RETRY-宏"><span class="level-left"><span class="level-item">5</span><span class="level-item">TEMP_FAILURE_RETRY 宏</span></span></a></li><li><a class="level is-mobile" href="#信号处理"><span class="level-left"><span class="level-item">6</span><span class="level-item">信号处理</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#时序图"><span class="level-left"><span class="level-item">6.1</span><span class="level-item">时序图</span></span></a></li></ul></li><li><a class="level is-mobile" href="#属性服务"><span class="level-left"><span class="level-item">7</span><span class="level-item">属性服务</span></span></a></li><li><a class="level is-mobile" href="#init-rc-文件"><span class="level-left"><span class="level-item">8</span><span class="level-item">init.rc 文件</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#rc-文件语法"><span class="level-left"><span class="level-item">8.1</span><span class="level-item">.rc 文件语法</span></span></a></li><li><a class="level is-mobile" href="#init-启动阶段"><span class="level-left"><span class="level-item">8.2</span><span class="level-item">init 启动阶段</span></span></a></li><li><a class="level is-mobile" href="#init-支持的-command"><span class="level-left"><span class="level-item">8.3</span><span class="level-item">init 支持的 command</span></span></a></li><li><a class="level is-mobile" href="#init-支持的-option"><span class="level-left"><span class="level-item">8.4</span><span class="level-item">init 支持的 option</span></span></a></li></ul></li><li><a class="level is-mobile" href="#关键服务启动"><span class="level-left"><span class="level-item">9</span><span class="level-item">关键服务启动</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#zygote"><span class="level-left"><span class="level-item">9.1</span><span class="level-item">zygote</span></span></a></li></ul></li><li><a class="level is-mobile" href="#总结"><span class="level-left"><span class="level-item">10</span><span class="level-item">总结</span></span></a></li><li><a class="level is-mobile" href="#附录"><span class="level-left"><span class="level-item">11</span><span class="level-item">附录</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#IO-多路复用"><span class="level-left"><span class="level-item">11.1</span><span class="level-item">IO 多路复用</span></span></a></li><li><a class="level is-mobile" href="#僵尸进程"><span class="level-left"><span class="level-item">11.2</span><span class="level-item">僵尸进程</span></span></a></li><li><a class="level is-mobile" href="#参考"><span class="level-left"><span class="level-item">11.3</span><span class="level-item">参考</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/android-%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">Android 实用工具</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/android-%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/"><span class="level-start"><span class="level-item">Android 应用开发</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/android-%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/"><span class="level-start"><span class="level-item">Android 系统原理</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/android-%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/"><span class="level-start"><span class="level-item">Android 逆向工程</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3/"><span class="level-start"><span class="level-item">参考文档</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">实用工具</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/"><span class="level-start"><span class="level-item">编程基础</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-06-29T16:45:50.000Z">2021-06-30</time></p><p class="title"><a href="/2021/06/30/%E6%94%AF%E6%8C%81%E8%A7%A6%E6%91%B8%E6%8B%96%E5%8A%A8%E7%9A%84-touchdelegate/">支持触摸拖动的 TouchDelegate</a></p><p class="categories"><a href="/categories/android-%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/">Android 应用开发</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-21T15:08:15.000Z">2021-04-21</time></p><p class="title"><a href="/2021/04/21/gdb-arm-%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">GDB ARM 交叉编译环境搭建</a></p><p class="categories"><a href="/categories/android-%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/">Android 实用工具</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-21T15:04:39.000Z">2021-04-21</time></p><p class="title"><a href="/2021/04/21/dropbear-android-%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4/">Dropbear Android 安装步骤</a></p><p class="categories"><a href="/categories/android-%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/">Android 实用工具</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-21T14:49:48.000Z">2021-04-21</time></p><p class="title"><a href="/2021/04/21/material-design-%E5%8F%82%E8%80%83/">Material Design 参考</a></p><p class="categories"><a href="/categories/%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3/">参考文档</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-21T10:20:58.000Z">2021-04-21</time></p><p class="title"><a href="/2021/04/21/android-avd-%E4%BD%8D%E7%BD%AE%E4%BF%AE%E6%94%B9/">Android AVD 位置修改</a></p><p class="categories"><a href="/categories/android-%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/">Android 实用工具</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">四月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/02/"><span class="level-start"><span class="level-item">二月 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/arm/"><span class="tag">ARM</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/avd/"><span class="tag">AVD</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/activity/"><span class="tag">Activity</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/android/"><span class="tag">Android</span><span class="tag">23</span></a></div><div class="control"><a class="tags has-addons" href="/tags/assembly/"><span class="tag">Assembly</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/binder/"><span class="tag">Binder</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/classloader/"><span class="tag">ClassLoader</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/computer/"><span class="tag">Computer</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dex/"><span class="tag">Dex</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/elf/"><span class="tag">ELF</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/emulator/"><span class="tag">Emulator</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">Git</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/jni/"><span class="tag">JNI</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/java/"><span class="tag">Java</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/log/"><span class="tag">Log</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/make/"><span class="tag">Make</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/makefile/"><span class="tag">Makefile</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/markdown/"><span class="tag">MarkDown</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/metrial/"><span class="tag">Metrial</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ndk/"><span class="tag">NDK</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/regex/"><span class="tag">Regex</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssh/"><span class="tag">SSH</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/theme/"><span class="tag">Theme</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/touch/"><span class="tag">Touch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/view/"><span class="tag">View</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xposed/"><span class="tag">Xposed</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zygote/"><span class="tag">Zygote</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/aapt/"><span class="tag">aapt</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%83%AD%E4%BF%AE%E5%A4%8D/"><span class="tag">热修复</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%83%AD%E6%9B%B4%E6%96%B0/"><span class="tag">热更新</span><span class="tag">1</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="l0neman 的博客" height="28"></a><p class="is-size-7"><span>&copy; 2021 l0neman</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/l0neman"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>