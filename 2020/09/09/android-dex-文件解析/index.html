<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Android Dex 文件解析 - l0neman 的博客</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="l0neman 的博客"><meta name="msapplication-TileImage" content="/img/avatar.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="l0neman 的博客"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="前言Java 代码文件在经过 javac 编译器编译后会产出 .class 格式的 Java 虚拟机可执行的字节码文件，而 Dex 文件则是 Android SDK 编译 Java 代码后的产物（Android SDK 使用 dx 或 d8 编译器将 .class 文件编译为 .dex 文件），了解 Dex 文件结构是理解 Android 虚拟机原理的基础，同时也是学习 Android 逆向工程的"><meta property="og:type" content="blog"><meta property="og:title" content="Android Dex 文件解析"><meta property="og:url" content="https://l0neman.github.io/2020/09/09/android-dex-%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90/"><meta property="og:site_name" content="l0neman 的博客"><meta property="og:description" content="前言Java 代码文件在经过 javac 编译器编译后会产出 .class 格式的 Java 虚拟机可执行的字节码文件，而 Dex 文件则是 Android SDK 编译 Java 代码后的产物（Android SDK 使用 dx 或 d8 编译器将 .class 文件编译为 .dex 文件），了解 Dex 文件结构是理解 Android 虚拟机原理的基础，同时也是学习 Android 逆向工程的"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://l0neman.github.io/2020/09/09/android-dex-%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90/dex_struct.png"><meta property="article:published_time" content="2020-09-09T13:26:53.000Z"><meta property="article:modified_time" content="2020-09-09T13:26:53.000Z"><meta property="article:author" content="l0neman"><meta property="article:tag" content="Android"><meta property="article:tag" content="Dex"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="./dex_struct.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://l0neman.github.io/2020/09/09/android-dex-%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90/"},"headline":"Android Dex 文件解析","image":["https://l0neman.github.io/2020/09/09/android-dex-%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90/dex_struct.png"],"datePublished":"2020-09-09T13:26:53.000Z","dateModified":"2020-09-09T13:26:53.000Z","author":{"@type":"Person","name":"l0neman"},"publisher":{"@type":"Organization","name":"l0neman 的博客","logo":{"@type":"ImageObject","url":"https://l0neman.github.io/img/logo.png"}},"description":"前言Java 代码文件在经过 javac 编译器编译后会产出 .class 格式的 Java 虚拟机可执行的字节码文件，而 Dex 文件则是 Android SDK 编译 Java 代码后的产物（Android SDK 使用 dx 或 d8 编译器将 .class 文件编译为 .dex 文件），了解 Dex 文件结构是理解 Android 虚拟机原理的基础，同时也是学习 Android 逆向工程的"}</script><link rel="canonical" href="https://l0neman.github.io/2020/09/09/android-dex-%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90/"><link rel="icon" href="/img/avatar.png"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.15.2/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?1727d76e0a823184efc8776f32a916a9";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="l0neman 的博客" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/l0neman"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-three-quarters"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-09-09T13:26:53.000Z" title="2020/9/9 下午9:26:53">2020-09-09</time>发表</span><span class="level-item"><time dateTime="2020-09-09T13:26:53.000Z" title="2020/9/9 下午9:26:53">2020-09-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/android-%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/">Android 逆向工程</a><span> / </span><a class="link-muted" href="/categories/android-%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/">Android 系统原理</a></span><span class="level-item">1 小时读完 (大约11921个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Android Dex 文件解析</h1><div class="content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Java 代码文件在经过 javac 编译器编译后会产出 .class 格式的 Java 虚拟机可执行的字节码文件，而 Dex 文件则是 Android SDK 编译 Java 代码后的产物（Android SDK 使用 dx 或 d8 编译器将 .class 文件编译为 .dex 文件），了解 Dex 文件结构是理解 Android 虚拟机原理的基础，同时也是学习 Android 逆向工程的基础。</p>
<p>Dex 文件的文件后缀为 .dex，是 Android 虚拟机的可执行文件。</p>
<span id="more"></span>


<h1 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h1><p>首先说明组成 Dex 文件结构中的基本类型，包含原生类型和 uleb128 类型：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>byte</td>
<td>8 位有符号整数</td>
</tr>
<tr>
<td>ubyte</td>
<td>8 位无符号整数</td>
</tr>
<tr>
<td>short</td>
<td>16 位有符号整数，小端字节序</td>
</tr>
<tr>
<td>ushort</td>
<td>16 位无符号整数，小端字节序</td>
</tr>
<tr>
<td>int</td>
<td>32 位有符号整数，小端字节序</td>
</tr>
<tr>
<td>uint</td>
<td>32 位无符号整数，小端字节序</td>
</tr>
<tr>
<td>long</td>
<td>64 位有符号整数，小端字节序</td>
</tr>
<tr>
<td>ulong</td>
<td>64 位无符号整数，小端字节序</td>
</tr>
<tr>
<td>sleb128</td>
<td>有符号 LEB128，可变长度</td>
</tr>
<tr>
<td>uleb128</td>
<td>无符号 LEB128，可变长度</td>
</tr>
<tr>
<td>uleb128p1</td>
<td>无符号 LEB128 + 1，可变长度</td>
</tr>
</tbody></table>
<p>在系统源码 DexFile.h 的对应类型别名定义如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// DexFile.h</span><br><span class="line"></span><br><span class="line">typedef uint8_t   u1;</span><br><span class="line">typedef uint16_t  u2;</span><br><span class="line">typedef uint32_t  u4;</span><br><span class="line">typedef uint64_t  u8;</span><br><span class="line">typedef int8_t    s1;</span><br><span class="line">typedef int16_t   s2;</span><br><span class="line">typedef int32_t   s4;</span><br><span class="line">typedef int64_t   s8;</span><br></pre></td></tr></table></figure>



<h1 id="LEB128-类型"><a href="#LEB128-类型" class="headerlink" title="LEB128 类型"></a>LEB128 类型</h1><p>LEB128 类型是 Dex 文件中的基础类型之一，该类型格式借鉴了 DWARF3 规范。在 Dex 文件中，LEB128 仅用于对 32 位数字进行编码。</p>
<p>LEB128 全称为“Little-Endian Base 128“，表示任意有符号或无符号整数的可变长度编码。</p>
<p>每个 LEB128 编码值由 1-5 个字节组成，共同表示一个 32 位的值，设计 LEB128 的目的是为了节省内存。</p>
<p>表示方法是：每个字节的首位为标志位，为 0 说明这个字节是 LEB128 类型的最后一个字节，为 1 则表示后面还有若干字节，然后将每个字节去除标志位后的 7 位组合成一个 32 数字。</p>
<h2 id="uleb128"><a href="#uleb128" class="headerlink" title="uleb128"></a>uleb128</h2><p>对于无符号的 <code>uleb128</code> 类型，使用两个字节表示十进制数字 <code>4176</code> 的示例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 1 0 1 0 0 0 0   0 0 1 0 0 0 0 0</span><br></pre></td></tr></table></figure>

<p>去除标志位后：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  1 0 1 0 0 0 0     0 1 0 0 0 0 0</span><br><span class="line">^                 ^</span><br><span class="line">去除              去除</span><br></pre></td></tr></table></figure>

<p>组合后使用便于阅读的大端格式表示为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0 0 0 1 0 0 0 0   0 1 0 1 0 0 0 0</span><br><span class="line">^ ^</span><br><span class="line">补充 0</span><br></pre></td></tr></table></figure>

<p><code>1000001010000</code> 转化为十进制的值为 4176。</p>
<h2 id="leb128"><a href="#leb128" class="headerlink" title="leb128"></a>leb128</h2><p>对于有符号的 <code>leb128</code> 类型，最后一个字节的除了标志位的最高位将为符号位，将进行符号扩展。</p>
<p>例如下面使用两个字节的 <code>leb128</code> 表示有符号数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1 1 0 1 0 0 0 0   0 1 1 0 0 0 0 0</span><br><span class="line">                    ^</span><br><span class="line">                    将进行符号扩展</span><br></pre></td></tr></table></figure>

<p>去除标志位后：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  1 0 1 0 0 0 0     1 1 0 0 0 0 0</span><br><span class="line">^                 ^</span><br><span class="line">去除              去除</span><br></pre></td></tr></table></figure>

<p>组合后使用便于阅读的大端格式表示为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0 0 1 1 0 0 0 0   0 1 0 1 0 0 0 0</span><br><span class="line">^ ^</span><br><span class="line">补充 0</span><br></pre></td></tr></table></figure>

<p>由于符号位为 1，说明表示负数，则使用补码计算：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">首先求反码：</span><br><span class="line"></span><br><span class="line">0 0 0 0 1 1 1 1   1 0 1 0 1 1 1 1</span><br><span class="line"></span><br><span class="line">然后 +1 -&gt;</span><br><span class="line"></span><br><span class="line">0 0 0 0 1 1 1 1   1 0 1 1 0 0 0 0</span><br></pre></td></tr></table></figure>

<p><code>111110110000</code> 的十进制结果为 <code>4016</code>，添加负号为 <code>-4016</code>。</p>
<h2 id="uleb128p1"><a href="#uleb128p1" class="headerlink" title="uleb128p1"></a>uleb128p1</h2><p><code>uleb128p1</code> 用于表示一个有符号值，它的编码方法为 <code>uleb128</code> 的值加 1，那么解码时首先以 <code>uleb128</code> 格式解析值，然后减去 1，主要是为了表示 -1 这个常用数而节省空间，原本使用 <code>sleb128</code> 需要 2 个字节才能表示 -1（11111111 01111111），现在一个字节就可以表示了（00000000）。</p>
<p>LEB128 类型的一些典型值：</p>
<table>
<thead>
<tr>
<th>Binary</th>
<th>Hex</th>
<th>sleb128</th>
<th>uleb128</th>
<th>uleb128p1</th>
</tr>
</thead>
<tbody><tr>
<td>00000000 00000000</td>
<td>00</td>
<td>0</td>
<td>0</td>
<td>-1</td>
</tr>
<tr>
<td>00000000 00000001</td>
<td>01</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>00000000 01111111</td>
<td>7f</td>
<td>-1</td>
<td>127</td>
<td>126</td>
</tr>
<tr>
<td>10000000 01111111</td>
<td>80 7f</td>
<td>-128</td>
<td>16256</td>
<td>16255</td>
</tr>
</tbody></table>
<h1 id="Dex-文件结构图"><a href="#Dex-文件结构图" class="headerlink" title="Dex 文件结构图"></a>Dex 文件结构图</h1><p>Dex 文件的总体结构图：</p>
<p><img src="./dex_struct.png" alt="dex_struct.png"></p>
<h1 id="Dex-结构说明"><a href="#Dex-结构说明" class="headerlink" title="Dex 结构说明"></a>Dex 结构说明</h1><p>下面对于 Dex 的详细结构进行说明（下面的参考了 Android 9.0.0_r3 系统源码中的 <code>dalvik/libdex/DexFile.h</code> 头文件）。</p>
<h2 id="hedaer-item"><a href="#hedaer-item" class="headerlink" title="hedaer_item"></a>hedaer_item</h2><p>首先 Dex 文件的头部具有一个 <code>hedaer_item</code> 结构，它存放了整个 Dex 文件的元信息，描述了一个 Dex 文件的概要结构。</p>
<p>下面是它的结构定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hedaer_item</span> &#123;</span></span><br><span class="line">  <span class="comment">/* 魔数 */</span></span><br><span class="line">  u1 magic[<span class="number">8</span>];</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    文件剩余内容（除 magic 和此字段之外的所有内容)的 adler32 校验和；</span></span><br><span class="line"><span class="comment">    用于检测文件损坏情况。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 checksum;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    文件剩余内容（除 magic、checksum 和此字段之外的所有内容)的 SHA-1 签名（哈希)；</span></span><br><span class="line"><span class="comment">    用于对文件进行唯一标识。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u1 signature[<span class="number">20</span>];</span><br><span class="line">  <span class="comment">/* 整个文件（包括标头)的大小，以字节为单位 */</span></span><br><span class="line">  u4 file_size;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    标头（整个区段)的大小，以字节为单位。这一项允许至少一定程度的向后/向前兼容性，</span></span><br><span class="line"><span class="comment">    而不必让格式失效。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 header_size;</span><br><span class="line">  <span class="comment">/* 字节序标记 */</span></span><br><span class="line">  u4 endian_tag;</span><br><span class="line">  <span class="comment">/* 链接区段的大小；如果此文件未进行静态链接，则该值为 0 */</span></span><br><span class="line">  u4 link_size;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    从文件开头到链接区段的偏移量；如果 link_size == 0，则该值为 0。</span></span><br><span class="line"><span class="comment">    该偏移量（如果为非零值)应该是到 link_data 区段的偏移量。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 link_off;</span><br><span class="line">  <span class="comment">/* 从文件开头到映射项的偏移量。该偏移量（必须为非零)应该是到 data 区段的偏移量 */</span></span><br><span class="line">  u4 map_off;</span><br><span class="line">  <span class="comment">/* 字符串标识符列表中的字符串数量 */</span></span><br><span class="line">  u4 string_ids_size;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    从文件开头到字符串标识符列表的偏移量；如果 string_ids_size == 0（极端情况)，</span></span><br><span class="line"><span class="comment">    则该值为 0。该偏移量（如果为非零值)应该是到 string_ids 区段开头的偏移量。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 string_ids_off;</span><br><span class="line">  <span class="comment">/* 类型标识符列表中的元素数量，最多为 65535 */</span></span><br><span class="line">  u4 type_ids_size;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    从文件开头到类型标识符列表的偏移量；如果 type_ids_size == 0（极端情况)，</span></span><br><span class="line"><span class="comment">    则该值为 0。该偏移量（如果为非零值)应该是到 type_ids 区段开头的偏移量。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 type_ids_off;</span><br><span class="line">  <span class="comment">/* 原型标识符列表中的元素数量，最多为 65535 */</span></span><br><span class="line">  u4 proto_ids_size;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    从文件开头到原型标识符列表的偏移量；如果 proto_ids_size == 0（极端情况)，</span></span><br><span class="line"><span class="comment">    则该值为 0。该偏移量（如果为非零值)应该是到 proto_ids 区段开头的偏移量。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 proto_ids_off;</span><br><span class="line">  <span class="comment">/* 字段标识符列表中的元素数量 */</span></span><br><span class="line">  u4 field_ids_size;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    从文件开头到字段标识符列表的偏移量；如果 field_ids_size == 0，则该值为 0。</span></span><br><span class="line"><span class="comment">    该偏移量（如果为非零值)应该是到 field_ids 区段开头的偏移量。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 field_ids_off;</span><br><span class="line">  <span class="comment">/* 方法标识符列表中的元素数量 */</span></span><br><span class="line">  u4 method_ids_size;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    从文件开头到方法标识符列表的偏移量；如果 method_ids_size == 0，则该值为 0。</span></span><br><span class="line"><span class="comment">    该偏移量（如果为非零值)应该是到 method_ids 区段开头的偏移量</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 method_ids_off;</span><br><span class="line">  <span class="comment">/* 类定义列表中的元素数量 */</span></span><br><span class="line">  u4 class_defs_size;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    从文件开头到类定义列表的偏移量；如果 class_defs_size == 0（极端情况)，</span></span><br><span class="line"><span class="comment">    则该值为 0。该偏移量（如果为非零值)应该是到 class_defs 区段开头的偏移量。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 class_defs_off;</span><br><span class="line">  <span class="comment">/* data 区段的大小（以字节为单位)。该数值必须是 sizeof(uint) 的偶数倍 */</span></span><br><span class="line">  u4 data_size;</span><br><span class="line">  <span class="comment">/* 从文件开头到 data 区段开头的偏移量 */</span></span><br><span class="line">  u4 data_off;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>和所有文件格式标准一样（使用魔数标识文件类型），Dex 文件的前 8 个字节 <code>magic</code> 字段是魔数，表示 Dex 这种文件类型，它的值是 <code>dex</code> 字符串和文件格式版本号的组合，例如 <code>dex\n039\0</code>，其中版本号用于为系统识别解析不同版本格式的 Dex 文件提供支持，不同版本的 Dex 文件可能具有结构差异，新版本可能支持更多指令。<code>039</code> 版本的格式在 Android 9.0 中被增加。 </p>
<p>从前面的结构图中可以知道，Dex 文件大致分为 3 块区域，文件头、索引区域以及数据区域。其中索引区域用于描述 Dex 几个关键子结构的分布，包含指向子结构的地址偏移的列表，数据区用于存放具体的信息，是索引区域所指向的目标区域，包含每个类的详细信息以及类成员和类方法的信息，以及每个方法的完整字节码指令等。</p>
<p>如果要对一个 Dex 文件进行解析，那么可以按照从上至下的方式，由文件概要信息自然的解析到具体数据结构。</p>
<p>索引区内容，包含 <code>string_ids</code>、<code>type_ids</code>、<code>proto_ids</code>、<code>field_ids</code>、<code>method_ids</code>、<code>class_defs</code>、<code>call_site_ids</code> 一共 7 个 Dex 核心结构，上面 <code>header_item</code> 结构的已经包含了每个结构的相关信息，每个结构都是一个数组，在 <code>header_item</code> 的描述中都具有一个 <code>size</code> 属性表示数组成员数量，和一个 <code>off</code> 表示在文件中的偏移值。</p>
<p>下面介绍索引区结构的详细结构。</p>
<h2 id="string-ids"><a href="#string-ids" class="headerlink" title="string_ids"></a>string_ids</h2><p><code>string_ids</code> 是字符串池，保存 Dex 文件中所用到的所有字符串，其他结构中如果包含字符串类型的变量，将会提供对应字符串在字符串池中的索引。</p>
<p><code>string_ids</code> 是数组结构，每个数组成员为一个 <code>string_id_item</code>，它存放了每个字符串在 <code>data</code> 结构中的偏移地址。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">string_id_item</span> &#123;</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    从文件开头到此项的字符串数据的偏移量。该偏移量应该是到 data 区段中某个位置的</span></span><br><span class="line"><span class="comment">    偏移量。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 string_data_off;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>string_id_item</code> 的偏移指向一个表示字符串的结构，为 <code>string_data_item</code>，它包含字符串的长度和具体内容，长度使用 <code>uleb128</code> 类型存储：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">string_data_item</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    此字符串的大小；以 UTF-16 代码单元（在许多系统中为“字符串长度”）为单位。</span></span><br><span class="line"><span class="comment">    也就是说，这是该字符串的解码长度（编码长度隐含在 0 字节的位置）。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  uleb128 utf16_size;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    一系列 MUTF-8 代码单元（又称八位字节），后跟一个值为 0 的字节。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u1* data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="type-ids"><a href="#type-ids" class="headerlink" title="type_ids"></a>type_ids</h2><p><code>type_ids</code> 是类型标识符信息，包含了代码中使用到的所有 Java 类型以及原始类型。</p>
<p><code>type_ids</code> 是数组结构，每个数组成员为一个 <code>type_id_item</code> 结构，它存放了类型所对应名字的字符串的在字符串池中的索引。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">type_id_item</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    此类描述符字符串的 string_ids 列表中的索引。该字符串必须符合上文定义的</span></span><br><span class="line"><span class="comment">    TypeDescriptor 的语法。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 descriptor_idx;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="proto-ids"><a href="#proto-ids" class="headerlink" title="proto_ids"></a>proto_ids</h2><p><code>proto_ids</code> 是方法原型标识符信息，存放方法返回值和参数的类型标识符信息。</p>
<p><code>proto_ids</code> 是数组结构，每个数组成员为一个 <code>proto_id_item</code>，它存放了方法返回类型标识符字符串在字符串池中的索引，以及参数、返回类型在 <code>type_ids</code> 中的索引。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proto_id_item</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    此原型的简短式描述符字符串的 string_ids 列表中的索引。该字符串必须符合上文定义</span></span><br><span class="line"><span class="comment">    的 ShortyDescriptor 的语法，而且必须与该项的返回类型和参数相对应。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 shorty_ids;</span><br><span class="line">  <span class="comment">/* 此原型的返回类型的 type_ids 列表中的索引 */</span></span><br><span class="line">  u4 return_type_idx;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    从文件开头到此原型的参数类型列表的偏移量；如果此原型没有参数，则该值为 0。</span></span><br><span class="line"><span class="comment">    该偏移量（如果为非零值）应该位于 data 区段中，且其中的数据应采用下文中</span></span><br><span class="line"><span class="comment">    “&quot;type_list&quot;”指定的格式。此外，不得对列表中的类型 void 进行任何引用。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 parameters_off;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="field-ids"><a href="#field-ids" class="headerlink" title="field_ids"></a>field_ids</h2><p><code>field_ids</code> 是类成员变量标识符信息，存放所有类成员类型标识符信息。</p>
<p><code>field_ids</code> 是数组结构，每个数组成员为一个 <code>field_id_item</code>，它存放了成员变量所属类型的信息，和成员变量本身的类型信息：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">field_id_item</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    此字段的定义符的 type_ids 列表中的索引。此项必须是“类”类型，而不能是“数组”或</span></span><br><span class="line"><span class="comment">    “基元”类型。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u2 class_idx;</span><br><span class="line">  <span class="comment">/* 此字段的类型的 type_ids 列表中的索引 */</span></span><br><span class="line">  u2 type_idx;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    此字段的名称的 string_ids 列表中的索引。该字符串必须符合上文定义的 MemberName</span></span><br><span class="line"><span class="comment">    的语法。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 name_idx;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="method-ids"><a href="#method-ids" class="headerlink" title="method_ids"></a>method_ids</h2><p><code>method_ids</code> 是类方法标识符信息，存放所有类方法的类型标识符信息。</p>
<p><code>method_ids</code> 是数组结构，每个数组成员为一个 <code>method_id_item</code>，它存放了方法所属类型的信息，和方法本身的类型信息： </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">method_id_item</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    此方法的定义符的 type_ids 列表中的索引。此项必须是“类”或“数组”类型，而不能是</span></span><br><span class="line"><span class="comment">    “基元”类型。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u2 class_idx;</span><br><span class="line">  <span class="comment">/* 此方法的原型的 proto_ids 列表中的索引 */</span></span><br><span class="line">  u2 proto_idx;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    此方法名称的 string_ids 列表中的索引。该字符串必须符合上文定义的 MemberName</span></span><br><span class="line"><span class="comment">    的语法。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 name_idx;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="class-defs"><a href="#class-defs" class="headerlink" title="class_defs"></a>class_defs</h2><p><code>class_defs</code> 是类定义信息，存放了所有类的定义信息。</p>
<p><code>class_defs</code> 是数组结构，每个数组成员为一个 <code>class_def_item</code>，包含这个类定义所需要的全部信息。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_def_item</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    此类的 type_ids 列表中的索引。此项必须是“类”类型，而不能是“数组”或“基元”类型。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 class_idx;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    类的访问标记（public、final 等）。有关详情，请参阅“access_flags 定义”。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 access_flag;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   超类的 type_ids 列表中的索引。如果此类没有超类（即它是根类，例如 Object），</span></span><br><span class="line"><span class="comment">   则该值为常量值 NO_INDEX。如果此类存在超类，则此项必须是“类”类型，而不能是</span></span><br><span class="line"><span class="comment">   “数组”或“基元”类型。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 superclass_idx;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    从文件开头到接口列表的偏移量；如果没有接口，则该值为 0。该偏移量应该位于 data</span></span><br><span class="line"><span class="comment">    区段，且其中的数据应采用下文中“type_list”指定的格式。该列表的每个元素都必须是</span></span><br><span class="line"><span class="comment">    “类”类型（而不能是“数组”或“基元”类型），并且不得包含任何重复项。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 interfaces_off;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   文件（包含这个类（至少大部分）的原始来源）名称的 string_ids 列表中的索引；</span></span><br><span class="line"><span class="comment">   或者该值为特殊值 NO_INDEX，以表示缺少这种信息。任何指定方法的 debug_info_item</span></span><br><span class="line"><span class="comment">   都可以覆盖此源文件，但预期情况是大多数类只能来自一个源文件。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 source_file_idx;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    从文件开头到此类的注释结构的偏移量；如果此类没有注释，则该值为 0。该偏移量</span></span><br><span class="line"><span class="comment">    （如果为非零值）应该位于 data 区段，且其中的数据应采用下文中</span></span><br><span class="line"><span class="comment">    “annotations_directory_item”指定的格式，同时所有项将此类作为定义符进行引用。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 annotations_off;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    从文件开头到此项的关联类数据的偏移量；如果此类没有类数据，则该值为 0（这种情况</span></span><br><span class="line"><span class="comment">    有可能出现，例如，如果此类是标记接口）。该偏移量（如果为非零值）应该位于 data</span></span><br><span class="line"><span class="comment">    区段，且其中的数据应采用下文中“class_data_item”指定的格式，同时所有项将此类作</span></span><br><span class="line"><span class="comment">    为定义符进行引用。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 class_data_off;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    从文件开头到 static 字段的初始值列表的偏移量；如果没有该列表（并且所有 static</span></span><br><span class="line"><span class="comment">    字段都将使用 0 或 null 进行初始化），则该值为 0。该偏移量应该位于 data 区段，</span></span><br><span class="line"><span class="comment">    且其中的数据应采用下文中“encoded_array_item”指定的格式。该数组的大小不得超出</span></span><br><span class="line"><span class="comment">    此类所声明的 static 字段的数量，且 static 字段所对应的元素应采用相对应的</span></span><br><span class="line"><span class="comment">    field_list 中所声明的顺序每个数组元素的类型均必须与其相应字段的声明类型相匹配。</span></span><br><span class="line"><span class="comment">    如果该数组中的元素比 static 字段中的少，则剩余字段将使用适当类型 0 或 null</span></span><br><span class="line"><span class="comment">    进行初始化。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 static_values_off;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中 <code>access_flags</code> 为访问标识符，可选值如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">  ACC_PUBLIC      = <span class="number">0x00000001</span>,       <span class="comment">// class, field, method, ic</span></span><br><span class="line">  ACC_PRIVATE     = <span class="number">0x00000002</span>,       <span class="comment">// field, method, ic</span></span><br><span class="line">  ACC_PROTECTED   = <span class="number">0x00000004</span>,       <span class="comment">// field, method, ic</span></span><br><span class="line">  ACC_STATIC      = <span class="number">0x00000008</span>,       <span class="comment">// field, method, ic</span></span><br><span class="line">  ACC_FINAL       = <span class="number">0x00000010</span>,       <span class="comment">// class, field, method, ic</span></span><br><span class="line">  ACC_SYNCHRONIZED= <span class="number">0x00000020</span>,       <span class="comment">// method (only allowed on natives)</span></span><br><span class="line">  ACC_SUPER       = <span class="number">0x00000020</span>,       <span class="comment">// class (not used in Dalvik)</span></span><br><span class="line">  ACC_VOLATILE    = <span class="number">0x00000040</span>,       <span class="comment">// field</span></span><br><span class="line">  ACC_BRIDGE      = <span class="number">0x00000040</span>,       <span class="comment">// method (1.5)</span></span><br><span class="line">  ACC_TRANSIENT   = <span class="number">0x00000080</span>,       <span class="comment">// field</span></span><br><span class="line">  ACC_VARARGS     = <span class="number">0x00000080</span>,       <span class="comment">// method (1.5)</span></span><br><span class="line">  ACC_NATIVE      = <span class="number">0x00000100</span>,       <span class="comment">// method</span></span><br><span class="line">  ACC_INTERFACE   = <span class="number">0x00000200</span>,       <span class="comment">// class, ic</span></span><br><span class="line">  ACC_ABSTRACT    = <span class="number">0x00000400</span>,       <span class="comment">// class, method, ic</span></span><br><span class="line">  ACC_STRICT      = <span class="number">0x00000800</span>,       <span class="comment">// method</span></span><br><span class="line">  ACC_SYNTHETIC   = <span class="number">0x00001000</span>,       <span class="comment">// field, method, ic</span></span><br><span class="line">  ACC_ANNOTATION  = <span class="number">0x00002000</span>,       <span class="comment">// class, ic (1.5)</span></span><br><span class="line">  ACC_ENUM        = <span class="number">0x00004000</span>,       <span class="comment">// class, field, ic (1.5)</span></span><br><span class="line">  ACC_CONSTRUCTOR = <span class="number">0x00010000</span>,       <span class="comment">// method (Dalvik only)</span></span><br><span class="line">  ACC_DECLARED_SYNCHRONIZED = <span class="number">0x00020000</span>, <span class="comment">// method (Dalvik only)</span></span><br><span class="line">  ACC_CLASS_MASK =</span><br><span class="line">  (ACC_PUBLIC | ACC_FINAL | ACC_INTERFACE | ACC_ABSTRACT</span><br><span class="line">      | ACC_SYNTHETIC | ACC_ANNOTATION | ACC_ENUM),</span><br><span class="line">  ACC_INNER_CLASS_MASK =</span><br><span class="line">  (ACC_CLASS_MASK | ACC_PRIVATE | ACC_PROTECTED | ACC_STATIC),</span><br><span class="line">  ACC_FIELD_MASK =</span><br><span class="line">  (ACC_PUBLIC | ACC_PRIVATE | ACC_PROTECTED | ACC_STATIC | ACC_FINAL</span><br><span class="line">      | ACC_VOLATILE | ACC_TRANSIENT | ACC_SYNTHETIC | ACC_ENUM),</span><br><span class="line">  ACC_METHOD_MASK =</span><br><span class="line">  (ACC_PUBLIC | ACC_PRIVATE | ACC_PROTECTED | ACC_STATIC | ACC_FINAL</span><br><span class="line">      | ACC_SYNCHRONIZED | ACC_BRIDGE | ACC_VARARGS | ACC_NATIVE</span><br><span class="line">      | ACC_ABSTRACT | ACC_STRICT | ACC_SYNTHETIC | ACC_CONSTRUCTOR</span><br><span class="line">      | ACC_DECLARED_SYNCHRONIZED),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="call-site-ids"><a href="#call-site-ids" class="headerlink" title="call_site_ids"></a>call_site_ids</h2><p><code>call_site_ids</code> 存放的是调用站点标识符信息，它是和 Java 中的提供的 MethodHandler 相关的信息。</p>
<p><code>call_site_ids</code> 是数组结构，每个数组成员为一个 <code>call_site_id_item</code>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">call_site_id_item</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    从文件开头到调用点定义的偏移量。该偏移量应位于数据区段中，且其中的数据应采用下</span></span><br><span class="line"><span class="comment">    文中“call_site_item”指定的格式。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u4 call_site_off;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>call_site_item</code> 是一个 <code>encoded_array_item</code> 结构，具体内容，可参考官方介绍，这里不对它进行重点关注。</p>
<p>到这里就介绍完了索引区的基本内容。</p>
<p>然后现在回到 <code>header_item</code> 中，看第 9 个 <code>map_off</code> 字段，它指向一个 <code>map_list</code> 结构，<code>map_list</code> 存放了 Dex 文件所有的结构描述，同时也包含 <code>header_item</code> 区域和索引区结构，下面看一下它的具体内容。</p>
<h2 id="map-list"><a href="#map-list" class="headerlink" title="map_list"></a>map_list</h2><p><code>map_list</code> 结构定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">map_list</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  u4 size;          <span class="comment">// 列表的大小（以条目数表示）。</span></span><br><span class="line">  map_item* list;   <span class="comment">// 列表的元素。</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>有大小和数组成员，在解析时首先读取数组元素的大小，再根据大小解析指定数量的 <code>map_item</code> 数组成员结构。</p>
<p><code>map_item</code> 结构定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">map_item</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  u2 type;   <span class="comment">// 项的类型。</span></span><br><span class="line">  u2 unused; <span class="comment">// 未使用。</span></span><br><span class="line">  u4 size;   <span class="comment">// 在指定偏移量处找到的项数量。</span></span><br><span class="line">  u4 offset; <span class="comment">// 从文件开头到相关项的偏移量。</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>根据 <code>type</code> 的值来可确认其说明的对应结构：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  TYPE_HEADER_ITEM                = <span class="number">0x0000</span>, <span class="comment">// header_item</span></span><br><span class="line">  TYPE_STRING_ID_ITEM             = <span class="number">0x0001</span>, <span class="comment">// string_id_item</span></span><br><span class="line">  TYPE_TYPE_ID_ITEM               = <span class="number">0x0002</span>, <span class="comment">// type_id_item</span></span><br><span class="line">  TYPE_PROTO_ID_ITEM              = <span class="number">0x0003</span>, <span class="comment">// proto_id_item</span></span><br><span class="line">  TYPE_FIELD_ID_ITEM              = <span class="number">0x0004</span>, <span class="comment">// field_id_item</span></span><br><span class="line">  TYPE_METHOD_ID_ITEM             = <span class="number">0x0005</span>, <span class="comment">// method_id_item</span></span><br><span class="line">  TYPE_CLASS_DEF_ITEM             = <span class="number">0x0006</span>, <span class="comment">// class_def_item</span></span><br><span class="line">  TYPE_CALL_SITE_ID_ITEM          = <span class="number">0x0007</span>, <span class="comment">// call_site_id_item</span></span><br><span class="line">  TYPE_METHOD_HANDLE_ITEM         = <span class="number">0x0008</span>, <span class="comment">// method_handle_item</span></span><br><span class="line">  TYPE_MAP_LIST                   = <span class="number">0x1000</span>, <span class="comment">// map_list</span></span><br><span class="line">  TYPE_TYPE_LIST                  = <span class="number">0x1001</span>, <span class="comment">// type_list</span></span><br><span class="line">  TYPE_ANNOTATION_SET_REF_LIST    = <span class="number">0x1002</span>, <span class="comment">// annotation_set_ref_list</span></span><br><span class="line">  TYPE_ANNOTATION_SET_ITEM        = <span class="number">0x1003</span>, <span class="comment">// annotation_set_item</span></span><br><span class="line">  TYPE_CLASS_DATA_ITEM            = <span class="number">0x2000</span>, <span class="comment">// class_data_item</span></span><br><span class="line">  TYPE_CODE_ITEM                  = <span class="number">0x2001</span>, <span class="comment">// code_item</span></span><br><span class="line">  TYPE_STRING_DATA_ITEM           = <span class="number">0x2002</span>, <span class="comment">// string_data_item</span></span><br><span class="line">  TYPE_DEBUG_INFO_ITEM            = <span class="number">0x2003</span>, <span class="comment">// debug_info_item</span></span><br><span class="line">  TYPE_ANNOTATION_ITEM            = <span class="number">0x2004</span>, <span class="comment">// annotation_item</span></span><br><span class="line">  TYPE_ENCODED_ARRAY_ITEM         = <span class="number">0x2005</span>, <span class="comment">// encoded_array_item</span></span><br><span class="line">  TYPE_ANNOTATIONS_DIRECTORY_ITEM = <span class="number">0x2006</span>, <span class="comment">// annotations_directory_item</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>通过遍历 <code>map_list</code> 即可得到每个结构的偏移地址和结构中项的数量，从而对整个 Dex 文件进行解析。</p>
<p>下面看一下除了索引区结构的其他结构。</p>
<h2 id="type-list"><a href="#type-list" class="headerlink" title="type_list"></a>type_list</h2><p><code>type_list</code> 是类型列表，结构如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">type_list</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  u4 size;         <span class="comment">// 列表的大小（以条目数表示）</span></span><br><span class="line">  type_item *list; <span class="comment">// 列表的元素。</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>每个列表成员为 <code>type_item</code>，包含 <code>type_ids</code> 数组的索引：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">type_item</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  u2 type_idx;                   <span class="comment">// type_ids 列表中的索引。</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="class-data-item"><a href="#class-data-item" class="headerlink" title="class_data_item"></a>class_data_item</h2><p><code>class_data_item</code> 表示类的信息，包含类成员和类方法的信息。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_data_item</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  uleb128 static_fields_size;    <span class="comment">// 此项中定义的静态字段的数量。</span></span><br><span class="line">  uleb128 instance_fields_size;  <span class="comment">// 此项中定义的实例字段的数量。</span></span><br><span class="line">  uleb128 direct_methods_size;   <span class="comment">// 此项中定义的直接方法的数量。</span></span><br><span class="line">  uleb128 virtual_methods_size;  <span class="comment">// 此项中定义的虚拟方法的数量。</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    定义的静态字段；以一系列编码元素的形式表示。这些字段必须按 field_idx 以升序进行排序。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  encoded_field* static_fields;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    定义的实例字段；以一系列编码元素的形式表示。这些字段必须按 field_idx 以升序进行排序。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  encoded_field* instance_fields;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    定义的直接（static、private 或构造函数的任何一个）方法；以一系列编码元素的形式</span></span><br><span class="line"><span class="comment">    表示。这些方法必须按 method_idx 以升序进行排序。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  encoded_method* direct_methods;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    定义的虚拟（非 static、private 或构造函数）方法；以一系列编码元素的形式表示。</span></span><br><span class="line"><span class="comment">    此列表不得包括继承方法，除非被此项所表示的类覆盖。这些方法必须按 method_idx 以</span></span><br><span class="line"><span class="comment">    升序进行排序。虚拟方法的 method_idx 不得与任何直接方法相同。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  encoded_method* virtual_methods;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>描述类成员和类方法的子结构：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">encoded_field</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    此字段标识（包括名称和描述符）的 field_ids 列表中的索引；</span></span><br><span class="line"><span class="comment">    它会表示为与列表中前一个元素的索引之间的差值。列表中第一个元素的索引则直接表示出来。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  uleb128 field_idx_diff;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    字段的访问标记（public、final 等）。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  uleb128 access_flags;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">encoded_method</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    此方法标识（包括名称和描述符）的 method_ids 列表中的索引；</span></span><br><span class="line"><span class="comment">    它会表示为与列表中前一个元素的索引之间的差值。列表中第一个元素的索引则直接表示出来。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  uleb128 method_idx_diff;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    方法的访问标记（public、final 等）。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  uleb128 access_flags;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    从文件开头到此方法代码结构的偏移量；如果此方法是 abstract 或 native，则该值为 0。</span></span><br><span class="line"><span class="comment">    该偏移量应该是到 data 区段中某个位置的偏移量。数据格式由下文的“code_item”指定。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  uleb128 code_off;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="code-item"><a href="#code-item" class="headerlink" title="code_item"></a>code_item</h2><p><code>code_item</code> 是字节码信息，包含每个 Java 代码块的代码，和寄存器数量等相关信息。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">code_item</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  u2 registers_size; <span class="comment">// 此代码使用的寄存器数量。</span></span><br><span class="line">  u2 ins_size;       <span class="comment">// 此代码所用方法的传入参数的字数。</span></span><br><span class="line">  u2 outs_size;      <span class="comment">// 此代码进行方法调用所需的传出参数空间的字数。</span></span><br><span class="line">  <span class="comment">/* </span></span><br><span class="line"><span class="comment">    此实例的 try_item 数量。如果此值为非零值，则这些项会显示为 tries 数组</span></span><br><span class="line"><span class="comment">   （正好位于此实例中 insns 的后面）。 </span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  u2 tries_size;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    从文件开头到此代码的调试信息（行号 + 局部变量信息）序列的偏移量；如果没有任</span></span><br><span class="line"><span class="comment">    何信息，则该值为 0。该偏移量（如果为非零值）应该是到 data 区段中某个位置的偏移量。数据格式由下文的“debug_info_item”指定。</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  u4 debug_info_off;</span><br><span class="line">  u4 insns_size;   <span class="comment">// 指令列表的大小（以 16 位代码单元为单位）。</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    字节码的实际数组。insns 数组中代码的格式由随附文档 Dalvik 字节码指定。请注意，</span></span><br><span class="line"><span class="comment">    尽管此项被定义为 ushort 的数组，但仍有一些内部结构倾向于采用四字节对齐方式。</span></span><br><span class="line"><span class="comment">    此外，如果此项恰好位于某个字节序交换文件中，则交换操作将只在单个 ushort 上进</span></span><br><span class="line"><span class="comment">    行，而不是在较大的内部结构上进行。</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  u2* insns;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    （可选）使 tries 实现四字节对齐的两字节填充。只有 tries_size 为非零值且 </span></span><br><span class="line"><span class="comment">    insns_size 是奇数时，此元素才会存在。</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  u2 padding;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    （可选）用于表示在代码中捕获异常的位置以及如何对异常进行处理的数组。该数组的元</span></span><br><span class="line"><span class="comment">    素在范围内不得重叠，且数值地址按照从低到高的顺序排列。只有 tries_size 为非零</span></span><br><span class="line"><span class="comment">    值时，此元素才会存在。</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  try_item* tries;</span><br><span class="line">  <span class="comment">/* </span></span><br><span class="line"><span class="comment">    （可选）用于表示“捕获类型列表和关联处理程序地址”的列表的字节。每个 try_item </span></span><br><span class="line"><span class="comment">    都具有到此结构的分组偏移量。只有 tries_size 为非零值时，此元素才会存在。</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  encoded_catch_handler_list handlers;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>string_data_item</code> 前面已经说过了，表示 Dex 文件中用到的每一个字符串。</p>
<h2 id="debug-info-item"><a href="#debug-info-item" class="headerlink" title="debug_info_item"></a>debug_info_item</h2><p><code>debug_info_item</code> 存放代码调试信息。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">debug_info_item</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    状态机的 line 寄存器的初始值。不表示实际的位置条目。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  uleb128 line_start;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    已编码的参数名称的数量。每个方法参数都应该有一个名称，但不包括实例方法的 this</span></span><br><span class="line"><span class="comment">   （如果有）。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  uleb128 parameters_size;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    方法参数名称的字符串索引。NO_INDEX 的编码值表示该关联参数没有可用的名称。</span></span><br><span class="line"><span class="comment">    该类型描述符和签名隐含在方法描述符和签名中。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  uleb128p1 parameter_names;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其他几个 <code>annotation_set_ref_list</code>、<code>annotation_set_item</code>、<code>annotation_item</code>、<code>annotations_directory_item</code> 是存放代码注释相关信息的结构，这里不再列出了。</p>
<p>到这里整个 Dex 文件的结构也就介绍的差不多了，但是只看这些文字说明，并不能真正了解一个 Dex 文件中的内容，下面通过解析一个真实的 Dex 文件，来了解 Dex 文件的具体内容。</p>
<h1 id="Dex-文件解析"><a href="#Dex-文件解析" class="headerlink" title="Dex 文件解析"></a>Dex 文件解析</h1><p>为了解析 Dex 文件，首先需要有一个 Dex 文件，下面来手动构建一个 Dex 文件。</p>
<h2 id="构建-Dex-文件"><a href="#构建-Dex-文件" class="headerlink" title="构建 Dex 文件"></a>构建 Dex 文件</h2><p>Dex 文件由 dx 或 d8 编译器编译 .class 文件生成，这里首先编写一个简单的 Java 类，包含成员变量和方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// io/l0neman/example/Hello.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> io.l0neman.example;                                                </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> sField = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">private</span> String mField = <span class="string">&quot;field&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(mField);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Hello Dex.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译为 Hello.class 文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac io/l0neman/example/Hello.java</span><br></pre></td></tr></table></figure>

<p>然后使用 dx 命令将 Hello.class 编译为 Hello.dex 文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dx --dex --output=Hello.dex io/l0neman/example/Hello.class</span><br></pre></td></tr></table></figure>

<p>或使用 d8 命令将 Hello.class 编译为 Hello.jar 文件，Hello.jar 是一个压缩包，里面包含一个 classes.dex 文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d8 --output Hello-d8.jar io/l0neman/example/Hello.class</span><br></pre></td></tr></table></figure>

<p>使用 dx 或者 d8 编译出来的 dex 文件的执行结果是一样的（打印出 <code>Hello Dex.</code>）。</p>
<h2 id="执行-Dex-文件"><a href="#执行-Dex-文件" class="headerlink" title="执行 Dex 文件"></a>执行 Dex 文件</h2><p>Dex 文件是 Android 虚拟机的可执行文件，所以在 Android 设备上可以直接执行 Dex 文件。</p>
<p>首先将 Dex 文件推送到 Android 设备：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb push Hello.dex /sdcard/</span><br></pre></td></tr></table></figure>

<p>然后使用如下两种方式之一进行执行：</p>
<ol>
<li>使用 <code>dalvikvm</code> 命令</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dalvikvm -cp Hello.dex io.l0neman.example.Hello</span><br></pre></td></tr></table></figure>



<ol start="2">
<li>使用 <code>app_process</code> 命令</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app_process -Djava.class.path=Hello.dex /data/local/temp io.l0neman.example.Hello</span><br></pre></td></tr></table></figure>



<h2 id="解析-Dex-文件"><a href="#解析-Dex-文件" class="headerlink" title="解析 Dex 文件"></a>解析 Dex 文件</h2><p>下面开始解析 Dex 文件。</p>
<p>对于解析一个文件结构来说，使用 C/C++ 语言要比 Java 语言更容易实现，因为 C/C++ 语言的 <code>read</code> 函数可直接传入一个结构体指针，文件中对应的字节将会被字节映射到结构体中，而 Java 只能逐个字节的解析，除非进行封装。</p>
<p>如果想要类似于 C/C++ 方法的 <code>read</code> 函数体验，可以用我之前封装的一个工具类：<a target="_blank" rel="noopener" href="https://github.com/l0neman/program-notes/blob/master/android-notes-reverse/utils_parse.md">ObjectInput</a>，可以直接自动将文件指定字节，解析到类的每个类型的成员上。</p>
<p>这里采用 C++ 语言对 Dex 文件进行解析。</p>
<p>首先将上面每个结构体放在新建的 DexFile.h 中，为了解析时可以直接用到它们（相关结构体可直接从 Android 系统源码中提取，路径是 <code>dalvik/libdex/DexFile.h</code>）。</p>
<p>解析核心方法主要是利用 <code>fread</code> 和 <code>fseek</code> 函数读取文件和控制文件读取偏移，遇到具体结构再根据具体内容进行解析，例如遇到 <code>uleb128</code> 作为数组大小，那就先解析这个 <code>uleb128</code> 的值，再根据它的值再解析每个数组成员。</p>
<h2 id="开始解析"><a href="#开始解析" class="headerlink" title="开始解析"></a>开始解析</h2><p>下面开始解析 Dex 文件，首先需要读取 Hello.dex 文件，这里使用面向对象的方式，首先定义一个解析类 <code>DexFileParser</code>，通过它的构造函数传入 Dex 文件路径。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DexParser.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> DEX_PARSER_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEX_PARSER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;type/DexFile.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DexParser</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">DexParser</span>(<span class="keyword">char</span> <span class="keyword">const</span>* dex_file_path);</span><br><span class="line">  ~<span class="built_in">DexParser</span>();</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">parse</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">// 解析各个结构的方法</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">parse_header_item</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">parse_map_list</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">parse_string_list</span><span class="params">(<span class="keyword">const</span> u4 size, <span class="keyword">const</span> u4 offset)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">parse_type_ids</span><span class="params">(<span class="keyword">const</span> u4 size, <span class="keyword">const</span> u4 offset)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">parse_proto_ids</span><span class="params">(<span class="keyword">const</span> u4 size, <span class="keyword">const</span> u4 offset)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">parse_field_ids</span><span class="params">(<span class="keyword">const</span> u4 size, <span class="keyword">const</span> u4 offset)</span> <span class="keyword">const</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">parse_method_ids</span><span class="params">(<span class="keyword">const</span> u4 size, <span class="keyword">const</span> u4 offset)</span> <span class="keyword">const</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">parse_class_defs</span><span class="params">(<span class="keyword">const</span> u4 size, <span class="keyword">const</span> u4 offset)</span> <span class="keyword">const</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">parse_encoded_field</span><span class="params">(<span class="keyword">const</span> u4 offset, encoded_field* p)</span> <span class="keyword">const</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">parse_encoded_method</span><span class="params">(<span class="keyword">const</span> u4 offset, encoded_method* p)</span> <span class="keyword">const</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">parse_class_data_list</span><span class="params">(<span class="keyword">const</span> u4 size, <span class="keyword">const</span> u4 offset)</span> <span class="keyword">const</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">parse_code_list</span><span class="params">(<span class="keyword">const</span> u4 size, <span class="keyword">const</span> u4 offset)</span> <span class="keyword">const</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">call_site_ids</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">method_handles</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">get_string_from_string_list</span><span class="params">(<span class="keyword">const</span> u4 index)</span> <span class="keyword">const</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">get_type_description</span><span class="params">(<span class="keyword">const</span> u4 index)</span> <span class="keyword">const</span></span>;</span><br><span class="line">  <span class="function">proto_id_item <span class="title">get_proto_item</span><span class="params">(<span class="keyword">const</span> u4 index)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Dex 文件的指针</span></span><br><span class="line">  FILE* dex_file_;</span><br><span class="line">  <span class="comment">// 文件头。</span></span><br><span class="line">  header_item dex_header_;</span><br><span class="line">  <span class="comment">// 类型映射表。</span></span><br><span class="line">  map_list map_list_;</span><br><span class="line">  <span class="comment">// 字符串偏移信息。</span></span><br><span class="line">  string_id_item* string_ids_;</span><br><span class="line">  <span class="comment">// 字符串数量。</span></span><br><span class="line">  u4 string_list_size_;</span><br><span class="line">  <span class="comment">// 字符串列表。</span></span><br><span class="line">  string_data_item* string_list_;</span><br><span class="line">  <span class="comment">// 类型列表。</span></span><br><span class="line">  type_id_item* type_list_;</span><br><span class="line">  <span class="comment">// 原型列表。</span></span><br><span class="line">  proto_id_item* proto_list_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// !DEX_PARSER_H</span></span></span><br></pre></td></tr></table></figure>

<p><code>main</code> 函数调用代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DexFileParser.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;DexParser.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="function">DexParser <span class="title">dex_parser</span><span class="params">(<span class="string">R&quot;(.\Hello.dex)&quot;</span>)</span></span>;</span><br><span class="line">  <span class="comment">// 开始解析</span></span><br><span class="line">  dex_parser.<span class="built_in">parse</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="打开-Dex-文件"><a href="#打开-Dex-文件" class="headerlink" title="打开 Dex 文件"></a>打开 Dex 文件</h2><p>下面看构造函数如何打开文件：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DexParser.cpp</span></span><br><span class="line"></span><br><span class="line">DexParser::<span class="built_in">DexParser</span>(<span class="keyword">char</span> <span class="keyword">const</span>* dex_file_path)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 相关指针初始化</span></span><br><span class="line">  <span class="keyword">this</span>-&gt;dex_file_   = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="keyword">this</span>-&gt;dex_header_ = <span class="built_in">header_item</span>();</span><br><span class="line">  <span class="keyword">this</span>-&gt;map_list_   = <span class="built_in">map_list</span>();</span><br><span class="line">  <span class="keyword">this</span>-&gt;string_ids_ = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="keyword">this</span>-&gt;string_list_size_ = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">this</span>-&gt;string_list_ = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="keyword">this</span>-&gt;type_list_ = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="keyword">this</span>-&gt;proto_list_ = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;dex file: %s\n\n&quot;</span>, dex_file_path);</span><br><span class="line">  <span class="comment">// 打开 dex 文件，并将文件指针赋予给 this-&gt;dex_file_ 保存起来</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> s = <span class="built_in">fopen_s</span>(&amp;<span class="keyword">this</span>-&gt;dex_file_, dex_file_path, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (s != <span class="number">0</span> || <span class="keyword">this</span>-&gt;dex_file_ == <span class="literal">nullptr</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;open dex file error: %s\n&quot;</span>, dex_file_path);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>读取后就可以开始使用 <code>fread</code> 函数解析结构体了。</p>
<h2 id="header-item"><a href="#header-item" class="headerlink" title="header_item"></a>header_item</h2><p>首先解析 Dex 文件头，<code>header_item</code> 结构：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DexParser.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DexParser::parse</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; parse header_item &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">parse_header_item</span>();</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DexParser::parse_header_item</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// 解析数据到 header_item 结构体</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">fread</span>(&amp;<span class="keyword">this</span>-&gt;dex_header_, <span class="built_in"><span class="keyword">sizeof</span></span>(header_item), <span class="number">1</span>,</span><br><span class="line">      <span class="keyword">this</span>-&gt;dex_file_))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;parse dex header error.\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 打印 header_item</span></span><br><span class="line">  <span class="built_in">print_dex_header</span>(&amp;<span class="keyword">this</span>-&gt;dex_header_);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">print_dex_header</span><span class="params">(header_item* dex_header)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;magic: &quot;</span>);</span><br><span class="line">  Printer::<span class="built_in">print_hex_array</span>(dex_header-&gt;magic, <span class="number">8</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;checksum: %6x\n&quot;</span>, dex_header-&gt;checksum);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;signature: &quot;</span>);</span><br><span class="line">  Printer::<span class="built_in">print_hex_array</span>(dex_header-&gt;signature, <span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;file_size: %d\n&quot;</span>, dex_header-&gt;file_size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;header_size: %d\n&quot;</span>, dex_header-&gt;header_size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;endian_tag: %d\n&quot;</span>, dex_header-&gt;endian_tag);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;link_size: %d\n&quot;</span>, dex_header-&gt;link_size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;link_off: %d\n&quot;</span>, dex_header-&gt;link_off);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;map_off: %d\n&quot;</span>, dex_header-&gt;map_off);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;string_ids_size: %d\n&quot;</span>, dex_header-&gt;string_ids_size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;string_ids_off: %d\n&quot;</span>, dex_header-&gt;string_ids_off);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;type_ids_size: %d\n&quot;</span>, dex_header-&gt;type_ids_size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;type_ids_off: %d\n&quot;</span>, dex_header-&gt;type_ids_off);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;proto_ids_size: %d\n&quot;</span>, dex_header-&gt;proto_ids_size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;proto_ids_off: %d\n&quot;</span>, dex_header-&gt;proto_ids_off);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;field_ids_size: %d\n&quot;</span>, dex_header-&gt;field_ids_size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;field_ids_off: %d\n&quot;</span>, dex_header-&gt;field_ids_off);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;method_ids_size: %d\n&quot;</span>, dex_header-&gt;method_ids_size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;method_ids_off: %d\n&quot;</span>, dex_header-&gt;method_ids_off);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;class_defs_size: %d\n&quot;</span>, dex_header-&gt;class_defs_size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;class_defs_off: %d\n&quot;</span>, dex_header-&gt;class_defs_off);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;data_size: %d\n&quot;</span>, dex_header-&gt;data_size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;data_off: %d\n&quot;</span>, dex_header-&gt;data_off);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，解析非常简单，一行代码就搞定了。</p>
<p>上面的 <code>print_hex_array</code> 函数是把整型数组作为 16 进制打印出来，更适合阅读：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Printer::print_hex_array</span><span class="params">(<span class="keyword">uint8_t</span> <span class="keyword">const</span>* array, <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%.2x &quot;</span>, array[i]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于 Hello.dex 的 <code>header_item</code> 解析结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; parse header_item &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><br><span class="line"></span><br><span class="line">magic: 64 65 78 0a 30 33 35 00</span><br><span class="line">checksum: 99137d68</span><br><span class="line">signature: 68 bf 36 a6 0d f7 51 a8 7e 79 c8 09 2f 15 ac fa 7b da 6a 42</span><br><span class="line">file_size: 944</span><br><span class="line">header_size: 112</span><br><span class="line">endian_tag: 305419896</span><br><span class="line">link_size: 0</span><br><span class="line">link_off: 0</span><br><span class="line">map_off: 784</span><br><span class="line">string_ids_size: 20</span><br><span class="line">string_ids_off: 112</span><br><span class="line">type_ids_size: 8</span><br><span class="line">type_ids_off: 192</span><br><span class="line">proto_ids_size: 3</span><br><span class="line">proto_ids_off: 224</span><br><span class="line">field_ids_size: 3</span><br><span class="line">field_ids_off: 260</span><br><span class="line">method_ids_size: 6</span><br><span class="line">method_ids_off: 284</span><br><span class="line">class_defs_size: 1</span><br><span class="line">class_defs_off: 332</span><br><span class="line">data_size: 580</span><br><span class="line">data_off: 364</span><br></pre></td></tr></table></figure>

<p>其中 <code>magic</code> 的值如下（<code>.</code> 表示空格）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">64 65 78 0A 30 33 35 00 -&gt; dex.035.</span><br></pre></td></tr></table></figure>

<p>符合前面所说的 Dex 文件的魔数，里面包含 <code>dex</code> 字符串，以及版本号 <code>035</code>；</p>
<p>其中的 <code>file_size</code> 为 Dex 文件的大小，在电脑上看这个 Dex 文件的大小属性，将和 <code>file_size</code> 一致。</p>
<p>其他的字段为文件校验值和各个结构的偏移。</p>
<p>下面解析其他结构，这里不用根据 <code>header_item</code> 里面提供的索引区标识来解析，由于 <code>map_list</code> 结构就包含了整个 Dex 文件的所有结构的信息，那么直接解析它就可以了解 Dex 文件其他结构的信息了，从而解析每个结构。</p>
<h2 id="map-list-1"><a href="#map-list-1" class="headerlink" title="map_list"></a>map_list</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DexParser.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DexParser::parse</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; parse header_item &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">parse_header_item</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; parse map_list &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">parse_map_list</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DexParser::parse_map_list</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// 从 header_item 中读取 map_off （map_list 的偏移）</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> offset = <span class="keyword">this</span>-&gt;dex_header_.map_off;</span><br><span class="line">  <span class="comment">// 移动至 map list 偏移处</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> != <span class="built_in">fseek</span>(dex_file_, offset, <span class="number">0</span>))</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;#parse_map_list - seek file error.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 解析 map_list 大小</span></span><br><span class="line">  u4 t_size = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">fread</span>(&amp;t_size, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>), <span class="number">1</span>, dex_file_))</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;#parse_map_list - read file error.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (t_size == <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;#parse_map_list - map_list.size error.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建 map_list 结构体，将 size 传入，用于初始化 map_item 数组</span></span><br><span class="line">  <span class="keyword">this</span>-&gt;map_list_ = <span class="built_in">map_list</span>(t_size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;map_list size: %u\n&quot;</span>, <span class="keyword">this</span>-&gt;map_list_.size);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 移动到 map_item 区域</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> != _fseeki64(dex_file_, offset + <span class="built_in"><span class="keyword">sizeof</span></span>(u4), <span class="number">0</span>))</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;#parse_map_list - seek file error.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建 map_item 数组</span></span><br><span class="line">  <span class="keyword">this</span>-&gt;map_list_.list = <span class="keyword">new</span> map_item[<span class="keyword">this</span>-&gt;map_list_.size];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">size_t</span> size = <span class="keyword">this</span>-&gt;map_list_.size;</span><br><span class="line">  <span class="comment">// 解析整个 map_item，数量为 size</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">fread</span>(<span class="keyword">this</span>-&gt;map_list_.list, <span class="built_in"><span class="keyword">sizeof</span></span>(map_item), size, dex_file_))</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;#parse_map_list - read map_list.list error.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (u4 i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>-&gt;map_list_.size; i++)</span><br><span class="line">      <span class="comment">// 打印 map_item 内容</span></span><br><span class="line">      <span class="built_in">print_map_item</span>(&amp;<span class="keyword">this</span>-&gt;map_list_.list[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">print_map_item</span><span class="params">(map_item <span class="keyword">const</span>* map_item)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nmap_item:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;type: 0x%x\n&quot;</span>, map_item-&gt;type);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;type desc: %s\n&quot;</span>, <span class="built_in">type_string</span>(map_item-&gt;type));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;size: %d\n&quot;</span>, map_item-&gt;size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;offset: %u\n&quot;</span>, map_item-&gt;offset);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面解析了 map_list 结构，包含一个 <code>map_item</code> 数组，每个 <code>map_item</code> 描述 Dex 文件的每个结构。</p>
<p>解析结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; parse map_list &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><br><span class="line"></span><br><span class="line">map_list size: 13</span><br><span class="line"></span><br><span class="line">map_item:</span><br><span class="line">type: 0x0</span><br><span class="line">type desc: header_item</span><br><span class="line">size: 1</span><br><span class="line">offset: 0</span><br><span class="line"></span><br><span class="line">map_item:</span><br><span class="line">type: 0x1</span><br><span class="line">type desc: string_id_item</span><br><span class="line">size: 20</span><br><span class="line">offset: 112</span><br><span class="line"></span><br><span class="line">map_item:</span><br><span class="line">type: 0x2</span><br><span class="line">type desc: type_id_item</span><br><span class="line">size: 8</span><br><span class="line">offset: 192</span><br><span class="line"></span><br><span class="line">map_item:</span><br><span class="line">type: 0x3</span><br><span class="line">type desc: proto_id_item</span><br><span class="line">size: 3</span><br><span class="line">offset: 224</span><br><span class="line"></span><br><span class="line">map_item:</span><br><span class="line">type: 0x4</span><br><span class="line">type desc: field_id_item</span><br><span class="line">size: 3</span><br><span class="line">offset: 260</span><br><span class="line"></span><br><span class="line">map_item:</span><br><span class="line">type: 0x5</span><br><span class="line">type desc: method_id_item</span><br><span class="line">size: 6</span><br><span class="line">offset: 284</span><br><span class="line"></span><br><span class="line">map_item:</span><br><span class="line">type: 0x6</span><br><span class="line">type desc: class_def_item</span><br><span class="line">size: 1</span><br><span class="line">offset: 332</span><br><span class="line"></span><br><span class="line">map_item:</span><br><span class="line">type: 0x2001</span><br><span class="line">type desc: code_item</span><br><span class="line">size: 4</span><br><span class="line">offset: 364</span><br><span class="line"></span><br><span class="line">map_item:</span><br><span class="line">type: 0x1001</span><br><span class="line">type desc: type_list</span><br><span class="line">size: 2</span><br><span class="line">offset: 484</span><br><span class="line"></span><br><span class="line">map_item:</span><br><span class="line">type: 0x2002</span><br><span class="line">type desc: string_data_item</span><br><span class="line">size: 20</span><br><span class="line">offset: 498</span><br><span class="line"></span><br><span class="line">map_item:</span><br><span class="line">type: 0x2003</span><br><span class="line">type desc: debug_info_item</span><br><span class="line">size: 4</span><br><span class="line">offset: 731</span><br><span class="line"></span><br><span class="line">map_item:</span><br><span class="line">type: 0x2000</span><br><span class="line">type desc: class_data_item</span><br><span class="line">size: 1</span><br><span class="line">offset: 755</span><br><span class="line"></span><br><span class="line">map_item:</span><br><span class="line">type: 0x1000</span><br><span class="line">type desc: map_list</span><br><span class="line">size: 1</span><br><span class="line">offset: 784</span><br></pre></td></tr></table></figure>

<p>下面就可以遍历 <code>map_list</code> 了，然后根据提供的偏移和大小解析对应结构就好了。</p>
<p>代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DexParser::parse</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; parse header_item &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">parse_header_item</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; parse map_list &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">parse_map_list</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 遍历 map_list 以解析每个结构</span></span><br><span class="line">  <span class="keyword">for</span> (u4 i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>-&gt;map_list_.size; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">const</span> map_item item = map_list_.list[i];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; parse %s:\n\n&quot;</span>, <span class="built_in">type_string</span>(item.type));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (item.size == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;item is empty.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in"><span class="keyword">switch</span></span> (item.type)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> TYPE_STRING_ID_ITEM:</span><br><span class="line">      <span class="built_in">parse_string_list</span>(item.size, item.offset);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_TYPE_ID_ITEM:</span><br><span class="line">      <span class="built_in">parse_type_ids</span>(item.size, item.offset);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_PROTO_ID_ITEM:</span><br><span class="line">      <span class="built_in">parse_proto_ids</span>(item.size, item.offset);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_FIELD_ID_ITEM:</span><br><span class="line">      <span class="built_in">parse_field_ids</span>(item.size, item.offset);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_METHOD_ID_ITEM:</span><br><span class="line">      <span class="built_in">parse_method_ids</span>(item.size, item.offset);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_CLASS_DEF_ITEM:</span><br><span class="line">      <span class="built_in">parse_class_defs</span>(item.size, item.offset);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_MAP_LIST:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;ignore.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_TYPE_LIST:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;ignore.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_ANNOTATION_SET_ITEM:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;ignore.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_CLASS_DATA_ITEM:</span><br><span class="line">      <span class="built_in">parse_class_data_list</span>(item.size, item.offset);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_CODE_ITEM:</span><br><span class="line">      <span class="built_in">parse_code_list</span>(item.size, item.offset);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_STRING_DATA_ITEM:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;ignore.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_DEBUG_INFO_ITEM:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;ignore.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_ANNOTATION_ITEM:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;ignore.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_ENCODED_ARRAY_ITEM:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;ignore.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_ANNOTATIONS_DIRECTORY_ITEM:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;ignore.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;item: %s\n&quot;</span>, <span class="built_in">type_string</span>(item.type));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是 Dex 关键结构（跳过了一些注释和调试结构的解析）的解析代码以及解析 Hello.dex 的结果。</p>
<h2 id="string-list"><a href="#string-list" class="headerlink" title="string_list"></a>string_list</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DexParser.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DexParser::parse_string_list</span><span class="params">(<span class="keyword">const</span> u4 size, <span class="keyword">const</span> u4 offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;string ids count: %u\n&quot;</span>, size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;string ids offset: %u\n&quot;</span>, offset);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (size == <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;#parse_string_list - not found string ids.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// parse string id items.</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != <span class="built_in">fseek</span>(<span class="keyword">this</span>-&gt;dex_file_, offset, <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;#parse_string_list - seek file error.&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>-&gt;string_ids_ = <span class="keyword">new</span> string_id_item[size];</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">fread</span>(<span class="keyword">this</span>-&gt;string_ids_, <span class="built_in"><span class="keyword">sizeof</span></span>(string_id_item),  size, </span><br><span class="line">        <span class="keyword">this</span>-&gt;dex_file_))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;#parse_string_list - read file error.&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// parse string data items.</span></span><br><span class="line">  <span class="keyword">this</span>-&gt;string_list_size_ = size;</span><br><span class="line">  <span class="keyword">this</span>-&gt;string_list_ = <span class="keyword">new</span> string_data_item[size];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (u4 i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> str_off = <span class="keyword">this</span>-&gt;string_ids_[i].string_data_off;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nstring offset: %d\n&quot;</span>, str_off);</span><br><span class="line"></span><br><span class="line">    string_data_item&amp; item = <span class="keyword">this</span>-&gt;string_list_[i];</span><br><span class="line">    item.<span class="built_in">parse</span>(<span class="keyword">this</span>-&gt;dex_file_, str_off);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;string: %s\n&quot;</span>, <span class="keyword">this</span>-&gt;string_list_[i].data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解析结果如下，包含 Dex 文件中所有使用到的字符串：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; parse string_id_item:</span><br><span class="line"></span><br><span class="line">string ids count: 20</span><br><span class="line">string ids offset: 112</span><br><span class="line"></span><br><span class="line">string offset: 498</span><br><span class="line">string: &lt;clinit&gt;</span><br><span class="line"></span><br><span class="line">string offset: 508</span><br><span class="line">string: &lt;init&gt;</span><br><span class="line"></span><br><span class="line">string offset: 516</span><br><span class="line">string: Hello Dex.</span><br><span class="line"></span><br><span class="line">string offset: 528</span><br><span class="line">string: Hello.java</span><br><span class="line"></span><br><span class="line">string offset: 540</span><br><span class="line">string: I</span><br><span class="line"></span><br><span class="line">string offset: 543</span><br><span class="line">string: Lio/l0neman/example/Hello;</span><br><span class="line"></span><br><span class="line">string offset: 571</span><br><span class="line">string: Ljava/io/PrintStream;</span><br><span class="line"></span><br><span class="line">string offset: 594</span><br><span class="line">string: Ljava/lang/Object;</span><br><span class="line"></span><br><span class="line">string offset: 614</span><br><span class="line">string: Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">string offset: 634</span><br><span class="line">string: Ljava/lang/System;</span><br><span class="line"></span><br><span class="line">string offset: 654</span><br><span class="line">string: V</span><br><span class="line"></span><br><span class="line">string offset: 657</span><br><span class="line">string: VL</span><br><span class="line"></span><br><span class="line">string offset: 661</span><br><span class="line">string: [Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">string offset: 682</span><br><span class="line">string: field</span><br><span class="line"></span><br><span class="line">string offset: 689</span><br><span class="line">string: mField</span><br><span class="line"></span><br><span class="line">string offset: 697</span><br><span class="line">string: main</span><br><span class="line"></span><br><span class="line">string offset: 703</span><br><span class="line">string: out</span><br><span class="line"></span><br><span class="line">string offset: 708</span><br><span class="line">string: println</span><br><span class="line"></span><br><span class="line">string offset: 717</span><br><span class="line">string: sField</span><br><span class="line"></span><br><span class="line">string offset: 725</span><br><span class="line">string: test</span><br></pre></td></tr></table></figure>



<h2 id="type-ids-1"><a href="#type-ids-1" class="headerlink" title="type_ids"></a>type_ids</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DexParser::parse_type_ids</span><span class="params">(<span class="keyword">const</span> u4 size, <span class="keyword">const</span> u4 offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> type_ids_size = size;</span><br><span class="line">  <span class="keyword">if</span> (type_ids_size == <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;#parse_type_ids - not found type ids.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;type_ids size: %u\n&quot;</span>, type_ids_size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;type_ids offset: %u\n&quot;</span>, offset);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> != <span class="built_in">fseek</span>(<span class="keyword">this</span>-&gt;dex_file_, offset, <span class="number">0</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;#parse_type_ids - seek file error.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>-&gt;type_list_ = <span class="keyword">new</span> type_id_item[type_ids_size];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">fread</span>(<span class="keyword">this</span>-&gt;type_list_, <span class="built_in"><span class="keyword">sizeof</span></span>(type_id_item),</span><br><span class="line">      type_ids_size, <span class="keyword">this</span>-&gt;dex_file_))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;#parse_type_ids - read file error.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (u4 i = <span class="number">0</span>; i &lt; type_ids_size; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;type: %s\n&quot;</span>, <span class="built_in">get_string_from_string_list</span>(</span><br><span class="line">        <span class="keyword">this</span>-&gt;type_list_[i].descriptor_idx));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解析结果如下，所有类型标识符：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; parse type_id_item:</span><br><span class="line"></span><br><span class="line">type_ids size: 8</span><br><span class="line">type_ids offset: 192</span><br><span class="line">type: I</span><br><span class="line">type: Lio/l0neman/example/Hello;</span><br><span class="line">type: Ljava/io/PrintStream;</span><br><span class="line">type: Ljava/lang/Object;</span><br><span class="line">type: Ljava/lang/String;</span><br><span class="line">type: Ljava/lang/System;</span><br><span class="line">type: V</span><br><span class="line">type: [Ljava/lang/String;</span><br></pre></td></tr></table></figure>



<h2 id="proto-ids-1"><a href="#proto-ids-1" class="headerlink" title="proto_ids"></a>proto_ids</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DexParser::parse_proto_ids</span><span class="params">(<span class="keyword">const</span> u4 size, <span class="keyword">const</span> u4 offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;proto ids size: %d\n&quot;</span>, size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;proto ids offset: %d\n\n&quot;</span>, offset);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> != <span class="built_in">fseek</span>(<span class="keyword">this</span>-&gt;dex_file_, offset, <span class="number">0</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;#parse_proto_ids - seek file error.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>-&gt;proto_list_ = <span class="keyword">new</span> proto_id_item[size];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">fread</span>(<span class="keyword">this</span>-&gt;proto_list_, <span class="built_in"><span class="keyword">sizeof</span></span>(proto_id_item), size, <span class="keyword">this</span>-&gt;dex_file_))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;#parse_proto_ids - read file error.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (u4 i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;shorty: %s\n&quot;</span>, <span class="built_in">get_string_from_string_list</span>(</span><br><span class="line">        <span class="keyword">this</span>-&gt;proto_list_[i].shorty_ids));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;return type: %s\n&quot;</span>, <span class="built_in">get_type_description</span>(</span><br><span class="line">        <span class="keyword">this</span>-&gt;proto_list_[i].return_type_idx));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;parameters offset: %d\n\n&quot;</span>, <span class="keyword">this</span>-&gt;proto_list_[i].parameters_off);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解析结果如下，方法类型标识符：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; parse proto_id_item:</span><br><span class="line"></span><br><span class="line">proto ids size: 3</span><br><span class="line">proto ids offset: 224</span><br><span class="line"></span><br><span class="line">shorty: V</span><br><span class="line">return type: V</span><br><span class="line">parameters offset: 0</span><br><span class="line"></span><br><span class="line">shorty: VL</span><br><span class="line">return type: V</span><br><span class="line">parameters offset: 484</span><br><span class="line"></span><br><span class="line">shorty: VL</span><br><span class="line">return type: V</span><br><span class="line">parameters offset: 492</span><br></pre></td></tr></table></figure>



<h2 id="field-ids-1"><a href="#field-ids-1" class="headerlink" title="field_ids"></a>field_ids</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DexParser::parse_field_ids</span><span class="params">(<span class="keyword">const</span> u4 size, <span class="keyword">const</span> u4 offset)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;field list size: %d\n&quot;</span>, size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;field list offset: %d\n\n&quot;</span>, offset);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> != <span class="built_in">fseek</span>(<span class="keyword">this</span>-&gt;dex_file_, offset, <span class="number">0</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;#parse_field_ids - seek file error.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> field_list = <span class="keyword">new</span> field_id_item[size];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">fread</span>(field_list, <span class="built_in"><span class="keyword">sizeof</span></span>(field_id_item), size, <span class="keyword">this</span>-&gt;dex_file_))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;#parse_field_ids - read file error.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (u4 i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;field name: %s\n&quot;</span>, <span class="built_in">get_string_from_string_list</span>(field_list[i].name_idx));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;parent class name: %s\n&quot;</span>, <span class="built_in">get_type_description</span>(field_list[i].class_idx));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;type name: %s\n\n&quot;</span>, <span class="built_in">get_type_description</span>(field_list[i].type_idx));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">delete</span>[] field_list;</span><br><span class="line">  field_list = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解析结果如下，所有类成员：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; parse field_id_item:</span><br><span class="line"></span><br><span class="line">field list size: 3</span><br><span class="line">field list offset: 260</span><br><span class="line"></span><br><span class="line">field name: mField</span><br><span class="line">parent class name: Lio/l0neman/example/Hello;</span><br><span class="line">type name: Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">field name: sField</span><br><span class="line">parent class name: Lio/l0neman/example/Hello;</span><br><span class="line">type name: I</span><br><span class="line"></span><br><span class="line">field name: out</span><br><span class="line">parent class name: Ljava/lang/System;</span><br><span class="line">type name: Ljava/io/PrintStream;</span><br></pre></td></tr></table></figure>



<h2 id="method-ids-1"><a href="#method-ids-1" class="headerlink" title="method_ids"></a>method_ids</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DexParser::parse_method_ids</span><span class="params">(<span class="keyword">const</span> u4 size, <span class="keyword">const</span> u4 offset)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;method ids size: %d\n&quot;</span>, size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;method ids offset: %d\n\n&quot;</span>, offset);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> != <span class="built_in">fseek</span>(<span class="keyword">this</span>-&gt;dex_file_, offset, <span class="number">0</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;#parse_method_ids - seek file error.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> method_list = <span class="keyword">new</span> method_id_item[size];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">fread</span>(method_list, <span class="built_in"><span class="keyword">sizeof</span></span>(method_id_item), size, <span class="keyword">this</span>-&gt;dex_file_))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;#parse_method_ids - read file error.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (u4 i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;method name: %s\n&quot;</span>, <span class="built_in">get_string_from_string_list</span>(</span><br><span class="line">        method_list[i].name_idx));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;method proto return type: %s\n&quot;</span>, <span class="built_in">get_type_description</span>(</span><br><span class="line">        <span class="built_in">get_proto_item</span>(method_list[i].proto_idx).return_type_idx));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;parent class name: %s\n\n&quot;</span>, <span class="built_in">get_type_description</span>(method_list[i].class_idx));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">delete</span>[] method_list;</span><br><span class="line">  method_list = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解析结果如下，所有类方法信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; parse method_id_item:</span><br><span class="line"></span><br><span class="line">method ids size: 6</span><br><span class="line">method ids offset: 284</span><br><span class="line"></span><br><span class="line">method name: &lt;clinit&gt;</span><br><span class="line">method proto return type: V</span><br><span class="line">parent class name: Lio/l0neman/example/Hello;</span><br><span class="line"></span><br><span class="line">method name: &lt;init&gt;</span><br><span class="line">method proto return type: V</span><br><span class="line">parent class name: Lio/l0neman/example/Hello;</span><br><span class="line"></span><br><span class="line">method name: main</span><br><span class="line">method proto return type: V</span><br><span class="line">parent class name: Lio/l0neman/example/Hello;</span><br><span class="line"></span><br><span class="line">method name: test</span><br><span class="line">method proto return type: V</span><br><span class="line">parent class name: Lio/l0neman/example/Hello;</span><br><span class="line"></span><br><span class="line">method name: println</span><br><span class="line">method proto return type: V</span><br><span class="line">parent class name: Ljava/io/PrintStream;</span><br><span class="line"></span><br><span class="line">method name: &lt;init&gt;</span><br><span class="line">method proto return type: V</span><br><span class="line">parent class name: Ljava/lang/Object;</span><br></pre></td></tr></table></figure>



<h2 id="class-def-item"><a href="#class-def-item" class="headerlink" title="class_def_item"></a>class_def_item</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DexParser::parse_class_defs</span><span class="params">(<span class="keyword">const</span> u4 size, <span class="keyword">const</span> u4 offset)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;class defs size: %u\n&quot;</span>, size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;class defs offset: %u\n\n&quot;</span>, offset);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> != <span class="built_in">fseek</span>(<span class="keyword">this</span>-&gt;dex_file_, offset, <span class="number">0</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;#parse_class_defs - seek file error.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> class_def_list = <span class="keyword">new</span> class_def_item[size];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">fread</span>(class_def_list, <span class="built_in"><span class="keyword">sizeof</span></span>(class_def_item), size, <span class="keyword">this</span>-&gt;dex_file_))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;#parse_class_defs - read file error.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (u4 i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;class name: %s\n&quot;</span>, <span class="built_in">get_type_description</span>(class_def_list[i].class_idx));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;access flags: &quot;</span>);</span><br><span class="line">    <span class="built_in">print_access_flags_description</span>(class_def_list[i].access_flag);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">delete</span>[] class_def_list;</span><br><span class="line">  class_def_list = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>解析结果如下，类定义信息，这里只有一个 <code>Hello</code> 类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; parse class_def_item:</span><br><span class="line"></span><br><span class="line">class defs size: 1</span><br><span class="line">class defs offset: 332</span><br><span class="line"></span><br><span class="line">class name: Lio/l0neman/example/Hello;</span><br><span class="line">access flags: public</span><br></pre></td></tr></table></figure>



<h2 id="class-data-list"><a href="#class-data-list" class="headerlink" title="class_data_list"></a>class_data_list</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DexParser::parse_class_data_list</span><span class="params">(<span class="keyword">const</span> u4 size, <span class="keyword">const</span> u4 offset)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;class data list size: %u\n&quot;</span>, size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;class data list offset: %u\n&quot;</span>, offset);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> != <span class="built_in">fseek</span>(<span class="keyword">this</span>-&gt;dex_file_, offset, <span class="number">0</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;#parse_class_data_list - seek file error.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  class_data_item* class_data_list = <span class="keyword">new</span> class_data_item[size];</span><br><span class="line"></span><br><span class="line">  u4 seek_add = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (u4 i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nparse %d class_data_item:\n\n&quot;</span>, i);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;seek add: %d\n&quot;</span>, seek_add);</span><br><span class="line">    class_data_item* item = &amp;class_data_list[i];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// parse static_fields_size.</span></span><br><span class="line">    item-&gt;static_fields_size.<span class="built_in">parse</span>(<span class="keyword">this</span>-&gt;dex_file_, offset + seek_add);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;static fields size: %d\n&quot;</span>, item-&gt;static_fields_size.value);</span><br><span class="line">    seek_add += item-&gt;static_fields_size.length;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// parse instance_field_size.</span></span><br><span class="line">    item-&gt;instance_fields_size.<span class="built_in">parse</span>(<span class="keyword">this</span>-&gt;dex_file_, offset + seek_add);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;instance fields size: %d\n&quot;</span>, item-&gt;instance_fields_size.value);</span><br><span class="line">    seek_add += item-&gt;instance_fields_size.length;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// parse direct_methods_size.</span></span><br><span class="line">    item-&gt;direct_methods_size.<span class="built_in">parse</span>(<span class="keyword">this</span>-&gt;dex_file_, offset + seek_add);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;direct methods size: %d\n&quot;</span>, item-&gt;direct_methods_size.value);</span><br><span class="line">    seek_add += item-&gt;direct_methods_size.length;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// parse virtual_methods_size.</span></span><br><span class="line">    item-&gt;virtual_methods_size.<span class="built_in">parse</span>(<span class="keyword">this</span>-&gt;dex_file_, offset + seek_add);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;virtual methods size: %d\n&quot;</span>, item-&gt;virtual_methods_size.value);</span><br><span class="line">    seek_add += item-&gt;virtual_methods_size.length;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// parse static_fields.</span></span><br><span class="line">    item-&gt;static_fields = <span class="keyword">new</span> encoded_field[item-&gt;static_fields_size.value];</span><br><span class="line">    <span class="keyword">for</span> (u4 j = <span class="number">0</span>; j &lt; item-&gt;static_fields_size.value; j++)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">parse_encoded_field</span>(offset + seek_add, &amp;item-&gt;static_fields[j]);</span><br><span class="line">      seek_add += item-&gt;static_fields[j].field_idx_diff.length +</span><br><span class="line">          item-&gt;static_fields[j].access_flags.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// parse instance_fields.</span></span><br><span class="line">    item-&gt;instance_fields = <span class="keyword">new</span> encoded_field[item-&gt;instance_fields_size.value];</span><br><span class="line">    <span class="keyword">for</span> (u4 j = <span class="number">0</span>; j &lt; item-&gt;instance_fields_size.value; j++)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">parse_encoded_field</span>(offset + seek_add, &amp;item-&gt;instance_fields[j]);</span><br><span class="line">      seek_add += item-&gt;instance_fields[j].field_idx_diff.length +</span><br><span class="line">          item-&gt;instance_fields[j].access_flags.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// parse direct_methods.</span></span><br><span class="line">    item-&gt;direct_methods = <span class="keyword">new</span> encoded_method[item-&gt;direct_methods_size.value];</span><br><span class="line">    <span class="keyword">for</span> (u4 j = <span class="number">0</span>; j &lt; item-&gt;direct_methods_size.value; j++)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">parse_encoded_method</span>(offset + seek_add, &amp;item-&gt;direct_methods[j]);</span><br><span class="line">      seek_add += item-&gt;direct_methods[j].method_idx_diff.length +</span><br><span class="line">          item-&gt;direct_methods[j].access_flags.length +</span><br><span class="line">          item-&gt;direct_methods[j].code_off.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// parse virtual_methods.</span></span><br><span class="line">    item-&gt;virtual_methods = <span class="keyword">new</span> encoded_method[item-&gt;virtual_methods_size.value];</span><br><span class="line">    <span class="keyword">for</span> (u4 j = <span class="number">0</span>; j &lt; item-&gt;virtual_methods_size.value; j++)</span><br><span class="line">    &#123;</span><br><span class="line">      encoded_method* vmethod = &amp;item-&gt;virtual_methods[j];</span><br><span class="line">      <span class="built_in">parse_encoded_method</span>(offset + seek_add, &amp;item-&gt;virtual_methods[j]);</span><br><span class="line"></span><br><span class="line">      seek_add += vmethod-&gt;method_idx_diff.length +</span><br><span class="line">          vmethod-&gt;access_flags.length + vmethod-&gt;code_off.length;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">delete</span>[] class_data_list;</span><br><span class="line">  class_data_list = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印如下信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; parse class_data_item:</span><br><span class="line"></span><br><span class="line">class data list size: 1</span><br><span class="line">class data list offset: 755</span><br><span class="line"></span><br><span class="line">parse 0 class_data_item:</span><br><span class="line"></span><br><span class="line">seek add: 0</span><br><span class="line">static fields size: 1</span><br><span class="line">instance fields size: 1</span><br><span class="line">direct methods size: 4</span><br><span class="line">virtual methods size: 0</span><br></pre></td></tr></table></figure>



<h2 id="code-item-1"><a href="#code-item-1" class="headerlink" title="code_item"></a>code_item</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DexParser::parse_code_list</span><span class="params">(<span class="keyword">const</span> u4 size, <span class="keyword">const</span> u4 offset)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;code list size: %u\n&quot;</span>, size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;code list offset: %u\n&quot;</span>, offset);</span><br><span class="line"></span><br><span class="line">  code_item* code_list = <span class="keyword">new</span> code_item[size];</span><br><span class="line"></span><br><span class="line">  u4 seek_add = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (u4 i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">  &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nparse %d code_item:\n\n&quot;</span>, i);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;seek_add: %u\n&quot;</span>, seek_add);</span><br><span class="line"></span><br><span class="line">    code_item* item = &amp;code_list[i];</span><br><span class="line">    u4 item_size = item-&gt;<span class="built_in">parse</span>(<span class="keyword">this</span>-&gt;dex_file_, offset + seek_add);</span><br><span class="line">    <span class="keyword">if</span> (item_size == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;parse code list error.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Byte aligned!.</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">auto</span> mod = item_size % <span class="number">4</span>;</span><br><span class="line">      item_size += (mod == <span class="number">0</span> ? <span class="number">0</span> : <span class="number">4</span> - mod);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    seek_add += item_size;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">delete</span>[] code_list;</span><br><span class="line">  code_list = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解析结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; parse code_item:</span><br><span class="line"></span><br><span class="line">code list size: 4</span><br><span class="line">code list offset: 364</span><br><span class="line"></span><br><span class="line">parse 0 code_item:</span><br><span class="line"></span><br><span class="line">seek_add: 0</span><br><span class="line">registers_size: 1</span><br><span class="line">ins_size: 0</span><br><span class="line">outs_size: 0</span><br><span class="line">tries_size: 0</span><br><span class="line">debug_info_off: 731</span><br><span class="line">insns_size: 4</span><br><span class="line">insns: 1012 0067 0001 000e</span><br><span class="line"></span><br><span class="line">parse 1 code_item:</span><br><span class="line"></span><br><span class="line">seek_add: 24</span><br><span class="line">registers_size: 2</span><br><span class="line">ins_size: 1</span><br><span class="line">outs_size: 1</span><br><span class="line">tries_size: 0</span><br><span class="line">debug_info_off: 736</span><br><span class="line">insns_size: 8</span><br><span class="line">insns: 1070 0005 0001 001a 000d 105b 0000 000e</span><br><span class="line"></span><br><span class="line">parse 2 code_item:</span><br><span class="line"></span><br><span class="line">seek_add: 56</span><br><span class="line">registers_size: 3</span><br><span class="line">ins_size: 1</span><br><span class="line">outs_size: 2</span><br><span class="line">tries_size: 0</span><br><span class="line">debug_info_off: 742</span><br><span class="line">insns_size: 8</span><br><span class="line">insns: 0062 0002 0011a 0002 206e 0004 0010 000e</span><br><span class="line"></span><br><span class="line">parse 3 code_item:</span><br><span class="line"></span><br><span class="line">seek_add: 88</span><br><span class="line">registers_size: 3</span><br><span class="line">ins_size: 1</span><br><span class="line">outs_size: 2</span><br><span class="line">tries_size: 0</span><br><span class="line">debug_info_off: 749</span><br><span class="line">insns_size: 8</span><br><span class="line">insns: 0062 0002 2154 0000 206e 0004 0010 000e</span><br></pre></td></tr></table></figure>

<p>对应代码字节码如下：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">.class</span><span class="keyword"> public</span> <span class="class">Lio/l0neman/example/Hello;</span></span><br><span class="line"><span class="keyword">.super</span> <span class="class">Ljava/lang/Object;</span></span><br><span class="line"><span class="keyword">.source</span> <span class="string">&quot;Hello.java&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># static fields</span></span><br><span class="line"><span class="keyword">.field</span><span class="keyword"> private</span><span class="keyword"> static</span> sField:I</span><br><span class="line"></span><br><span class="line"><span class="comment"># instance fields</span></span><br><span class="line"><span class="keyword">.field</span><span class="keyword"> private</span> mField:<span class="class">Ljava/lang/String;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># direct methods</span></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> static</span><span class="keyword"> constructor</span> &lt;clinit&gt;()V</span><br><span class="line"><span class="keyword">    .registers</span> 1</span><br><span class="line"><span class="keyword">    .prologue</span></span><br><span class="line">   <span class="built_in"> const/4 </span>v0, 0x1</span><br><span class="line">   <span class="built_in"> sput </span>v0, <span class="class">Lio/l0neman/example/Hello;</span>-&gt;sField:I</span><br><span class="line">   <span class="built_in"> return-void</span></span><br><span class="line"><span class="built_in"></span><span class="keyword">.end method</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span><span class="keyword"> constructor</span> &lt;init&gt;()V</span><br><span class="line"><span class="keyword">    .registers</span> 2</span><br><span class="line"><span class="keyword">    .prologue</span></span><br><span class="line">   <span class="built_in"> invoke-direct </span>&#123;p0&#125;, <span class="class">Ljava/lang/Object;</span>-&gt;&lt;init&gt;()V</span><br><span class="line">   <span class="built_in"> const-string </span>v0, <span class="string">&quot;field&quot;</span></span><br><span class="line">   <span class="built_in"> iput-object </span>v0, p0, <span class="class">Lio/l0neman/example/Hello;</span>-&gt;mField:<span class="class">Ljava/lang/String;</span></span><br><span class="line">   <span class="built_in"> return-void</span></span><br><span class="line"><span class="built_in"></span><span class="keyword">.end method</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span><span class="keyword"> static</span> main([<span class="class">Ljava/lang/String;</span>)V</span><br><span class="line"><span class="keyword">    .registers</span> 3</span><br><span class="line"><span class="keyword">    .prologue</span></span><br><span class="line">   <span class="built_in"> sget-object </span>v0, <span class="class">Ljava/lang/System;</span>-&gt;out:<span class="class">Ljava/io/PrintStream;</span></span><br><span class="line">   <span class="built_in"> const-string </span>v1, <span class="string">&quot;Hello Dex.&quot;</span></span><br><span class="line">   <span class="built_in"> invoke-virtual </span>&#123;v0, v1&#125;, <span class="class">Ljava/io/PrintStream;</span>-&gt;println(<span class="class">Ljava/lang/String;</span>)V</span><br><span class="line">   <span class="built_in"> return-void</span></span><br><span class="line"><span class="built_in"></span><span class="keyword">.end method</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> private</span> test()V</span><br><span class="line"><span class="keyword">    .registers</span> 3</span><br><span class="line"><span class="keyword">    .prologue</span></span><br><span class="line">   <span class="built_in"> sget-object </span>v0, <span class="class">Ljava/lang/System;</span>-&gt;out:<span class="class">Ljava/io/PrintStream;</span></span><br><span class="line">   <span class="built_in"> iget-object </span>v1, p0, <span class="class">Lio/l0neman/example/Hello;</span>-&gt;mField:<span class="class">Ljava/lang/String;</span></span><br><span class="line">   <span class="built_in"> invoke-virtual </span>&#123;v0, v1&#125;, <span class="class">Ljava/io/PrintStream;</span>-&gt;println(<span class="class">Ljava/lang/String;</span>)V</span><br><span class="line">   <span class="built_in"> return-void</span></span><br><span class="line"><span class="built_in"></span><span class="keyword">.end method</span></span><br></pre></td></tr></table></figure>



<h2 id="uleb128-1"><a href="#uleb128-1" class="headerlink" title="uleb128"></a>uleb128</h2><p>对于 uleb128 类型的解析，这里参考了系统实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// uleb128.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">Leb128::decode_signed_leb128</span><span class="params">(<span class="keyword">uint8_t</span> <span class="keyword">const</span>** data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> ptr = *data;</span><br><span class="line">  <span class="keyword">int32_t</span> result = *(ptr++);</span><br><span class="line">  <span class="keyword">if</span> (result &lt;= <span class="number">0x7f</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    result = (result &lt;&lt; <span class="number">25</span>) &gt;&gt; <span class="number">25</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">int</span> cur = *(ptr++);</span><br><span class="line">    result = (result &amp; <span class="number">0x7f</span>) | ((cur &amp; <span class="number">0x7f</span>) &lt;&lt; <span class="number">7</span>);</span><br><span class="line">    <span class="keyword">if</span> (cur &lt;= <span class="number">0x7f</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      result = (result &lt;&lt; <span class="number">18</span>) &gt;&gt; <span class="number">18</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      cur = *(ptr++);</span><br><span class="line">      result |= (cur &amp; <span class="number">0x7f</span>) &lt;&lt; <span class="number">14</span>;</span><br><span class="line">      <span class="keyword">if</span> (cur &lt;= <span class="number">0x7f</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        result = (result &lt;&lt; <span class="number">11</span>) &gt;&gt; <span class="number">11</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        cur = *(ptr++);</span><br><span class="line">        result |= (cur &amp; <span class="number">0x7f</span>) &lt;&lt; <span class="number">21</span>;</span><br><span class="line">        <span class="keyword">if</span> (cur &lt;= <span class="number">0x7f</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          result = (result &lt;&lt; <span class="number">4</span>) &gt;&gt; <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">// Note: We don&#x27;t check to see if cur is out of range here,</span></span><br><span class="line">          <span class="comment">// meaning we tolerate garbage in the four high-order bits.</span></span><br><span class="line">          cur = *(ptr++);</span><br><span class="line">          result |= cur &lt;&lt; <span class="number">28</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  *data = ptr;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">Leb128::decode_unsigned_leb128</span><span class="params">(<span class="keyword">uint8_t</span> <span class="keyword">const</span>** data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> ptr = *data;</span><br><span class="line">  <span class="keyword">int</span> result = *(ptr++);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">LIKELY</span>(result &gt; <span class="number">0x7f</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">int</span> cur = *(ptr++);</span><br><span class="line">    result = (result &amp; <span class="number">0x7f</span>) | ((cur &amp; <span class="number">0x7f</span>) &lt;&lt; <span class="number">7</span>);</span><br><span class="line">    <span class="keyword">if</span> (cur &gt; <span class="number">0x7f</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      cur = *(ptr++);</span><br><span class="line">      result |= (cur &amp; <span class="number">0x7f</span>) &lt;&lt; <span class="number">14</span>;</span><br><span class="line">      <span class="keyword">if</span> (cur &gt; <span class="number">0x7f</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        cur = *(ptr++);</span><br><span class="line">        result |= (cur &amp; <span class="number">0x7f</span>) &lt;&lt; <span class="number">21</span>;</span><br><span class="line">        <span class="keyword">if</span> (cur &gt; <span class="number">0x7f</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">// Note: We don&#x27;t check to see if cur is out of range here,</span></span><br><span class="line">          <span class="comment">// meaning we tolerate garbage in the four high-order bits.</span></span><br><span class="line">          cur = *(ptr++);</span><br><span class="line">          result |= cur &lt;&lt; <span class="number">28</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  *data = ptr;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里解析代码就列出的差不多了，真正理解具体的解析还需要自己去动手实现，下面给出仓库地址，可以参考相关代码进行解析。</p>
<h1 id="dexdump"><a href="#dexdump" class="headerlink" title="dexdump"></a>dexdump</h1><p>Android SDK 提供了一个 <code>dexdump</code> 工具，可以解析 Dex 文件的信息。</p>
<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dexdump -f Hello.dex </span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Processing &#x27;Hello.dex&#x27;...</span><br><span class="line">Opened &#x27;Hello.dex&#x27;, DEX version &#x27;035&#x27;</span><br><span class="line">DEX file header:</span><br><span class="line">magic               : &#x27;dex\n035\0&#x27;</span><br><span class="line">checksum            : 99137d68</span><br><span class="line">signature           : 68bf...6a42</span><br><span class="line">file_size           : 944</span><br><span class="line">header_size         : 112</span><br><span class="line">link_size           : 0</span><br><span class="line">link_off            : 0 (0x000000)</span><br><span class="line">string_ids_size     : 20</span><br><span class="line">string_ids_off      : 112 (0x000070)</span><br><span class="line">type_ids_size       : 8</span><br><span class="line">type_ids_off        : 192 (0x0000c0)</span><br><span class="line">proto_ids_size      : 3</span><br><span class="line">proto_ids_off       : 224 (0x0000e0)</span><br><span class="line">field_ids_size      : 3</span><br><span class="line">field_ids_off       : 260 (0x000104)</span><br><span class="line">method_ids_size     : 6</span><br><span class="line">method_ids_off      : 284 (0x00011c)</span><br><span class="line">class_defs_size     : 1</span><br><span class="line">class_defs_off      : 332 (0x00014c)</span><br><span class="line">data_size           : 580</span><br><span class="line">data_off            : 364 (0x00016c)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<h1 id="代码仓库"><a href="#代码仓库" class="headerlink" title="代码仓库"></a>代码仓库</h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/l0neman/DexFileParser/">https://github.com/l0neman/DexFileParser/</a></li>
</ul>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://source.android.google.cn/devices/tech/dalvik/dex-format">https://source.android.google.cn/devices/tech/dalvik/dex-format</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://androidxref.com/9.0.0_r3/xref/dalvik/libdex/DexFile.h">http://androidxref.com/9.0.0_r3/xref/dalvik/libdex/DexFile.h</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://www.520monkey.com/archives/579">http://www.520monkey.com/archives/579</a></p>
</li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>Android Dex 文件解析</p><p><a href="https://l0neman.github.io/2020/09/09/android-dex-文件解析/">https://l0neman.github.io/2020/09/09/android-dex-文件解析/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>l0neman</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2020-09-09</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2020-09-09</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/android/">Android</a><a class="link-muted mr-2" rel="tag" href="/tags/dex/">Dex</a></div><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5f0f12c19a2af379" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/qrcode/alipay.jpg" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/qrcode/wxpay.jpg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/09/19/android-%E6%A8%A1%E6%8B%9F%E5%99%A8-root-%E5%92%8C-supersu-%E5%AE%89%E8%A3%85/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Android 模拟器 Root 和 SuperSU 安装</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/08/24/android-zygote-%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E5%88%86%E6%9E%90/"><span class="level-item">Android zygote 进程启动分析</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><script src="https://utteranc.es/client.js" repo="l0neman/l0neman.github.io" issue-term="pathname" label="comment" theme="github-light" crossorigin="anonymous" async></script></div></div></div><!--!--><div class="column column-right  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#前言"><span class="level-left"><span class="level-item">1</span><span class="level-item">前言</span></span></a></li><li><a class="level is-mobile" href="#基本数据类型"><span class="level-left"><span class="level-item">2</span><span class="level-item">基本数据类型</span></span></a></li><li><a class="level is-mobile" href="#LEB128-类型"><span class="level-left"><span class="level-item">3</span><span class="level-item">LEB128 类型</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#uleb128"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">uleb128</span></span></a></li><li><a class="level is-mobile" href="#leb128"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">leb128</span></span></a></li><li><a class="level is-mobile" href="#uleb128p1"><span class="level-left"><span class="level-item">3.3</span><span class="level-item">uleb128p1</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Dex-文件结构图"><span class="level-left"><span class="level-item">4</span><span class="level-item">Dex 文件结构图</span></span></a></li><li><a class="level is-mobile" href="#Dex-结构说明"><span class="level-left"><span class="level-item">5</span><span class="level-item">Dex 结构说明</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#hedaer-item"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">hedaer_item</span></span></a></li><li><a class="level is-mobile" href="#string-ids"><span class="level-left"><span class="level-item">5.2</span><span class="level-item">string_ids</span></span></a></li><li><a class="level is-mobile" href="#type-ids"><span class="level-left"><span class="level-item">5.3</span><span class="level-item">type_ids</span></span></a></li><li><a class="level is-mobile" href="#proto-ids"><span class="level-left"><span class="level-item">5.4</span><span class="level-item">proto_ids</span></span></a></li><li><a class="level is-mobile" href="#field-ids"><span class="level-left"><span class="level-item">5.5</span><span class="level-item">field_ids</span></span></a></li><li><a class="level is-mobile" href="#method-ids"><span class="level-left"><span class="level-item">5.6</span><span class="level-item">method_ids</span></span></a></li><li><a class="level is-mobile" href="#class-defs"><span class="level-left"><span class="level-item">5.7</span><span class="level-item">class_defs</span></span></a></li><li><a class="level is-mobile" href="#call-site-ids"><span class="level-left"><span class="level-item">5.8</span><span class="level-item">call_site_ids</span></span></a></li><li><a class="level is-mobile" href="#map-list"><span class="level-left"><span class="level-item">5.9</span><span class="level-item">map_list</span></span></a></li><li><a class="level is-mobile" href="#type-list"><span class="level-left"><span class="level-item">5.10</span><span class="level-item">type_list</span></span></a></li><li><a class="level is-mobile" href="#class-data-item"><span class="level-left"><span class="level-item">5.11</span><span class="level-item">class_data_item</span></span></a></li><li><a class="level is-mobile" href="#code-item"><span class="level-left"><span class="level-item">5.12</span><span class="level-item">code_item</span></span></a></li><li><a class="level is-mobile" href="#debug-info-item"><span class="level-left"><span class="level-item">5.13</span><span class="level-item">debug_info_item</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Dex-文件解析"><span class="level-left"><span class="level-item">6</span><span class="level-item">Dex 文件解析</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#构建-Dex-文件"><span class="level-left"><span class="level-item">6.1</span><span class="level-item">构建 Dex 文件</span></span></a></li><li><a class="level is-mobile" href="#执行-Dex-文件"><span class="level-left"><span class="level-item">6.2</span><span class="level-item">执行 Dex 文件</span></span></a></li><li><a class="level is-mobile" href="#解析-Dex-文件"><span class="level-left"><span class="level-item">6.3</span><span class="level-item">解析 Dex 文件</span></span></a></li><li><a class="level is-mobile" href="#开始解析"><span class="level-left"><span class="level-item">6.4</span><span class="level-item">开始解析</span></span></a></li><li><a class="level is-mobile" href="#打开-Dex-文件"><span class="level-left"><span class="level-item">6.5</span><span class="level-item">打开 Dex 文件</span></span></a></li><li><a class="level is-mobile" href="#header-item"><span class="level-left"><span class="level-item">6.6</span><span class="level-item">header_item</span></span></a></li><li><a class="level is-mobile" href="#map-list-1"><span class="level-left"><span class="level-item">6.7</span><span class="level-item">map_list</span></span></a></li><li><a class="level is-mobile" href="#string-list"><span class="level-left"><span class="level-item">6.8</span><span class="level-item">string_list</span></span></a></li><li><a class="level is-mobile" href="#type-ids-1"><span class="level-left"><span class="level-item">6.9</span><span class="level-item">type_ids</span></span></a></li><li><a class="level is-mobile" href="#proto-ids-1"><span class="level-left"><span class="level-item">6.10</span><span class="level-item">proto_ids</span></span></a></li><li><a class="level is-mobile" href="#field-ids-1"><span class="level-left"><span class="level-item">6.11</span><span class="level-item">field_ids</span></span></a></li><li><a class="level is-mobile" href="#method-ids-1"><span class="level-left"><span class="level-item">6.12</span><span class="level-item">method_ids</span></span></a></li><li><a class="level is-mobile" href="#class-def-item"><span class="level-left"><span class="level-item">6.13</span><span class="level-item">class_def_item</span></span></a></li><li><a class="level is-mobile" href="#class-data-list"><span class="level-left"><span class="level-item">6.14</span><span class="level-item">class_data_list</span></span></a></li><li><a class="level is-mobile" href="#code-item-1"><span class="level-left"><span class="level-item">6.15</span><span class="level-item">code_item</span></span></a></li><li><a class="level is-mobile" href="#uleb128-1"><span class="level-left"><span class="level-item">6.16</span><span class="level-item">uleb128</span></span></a></li></ul></li><li><a class="level is-mobile" href="#dexdump"><span class="level-left"><span class="level-item">7</span><span class="level-item">dexdump</span></span></a></li><li><a class="level is-mobile" href="#代码仓库"><span class="level-left"><span class="level-item">8</span><span class="level-item">代码仓库</span></span></a></li><li><a class="level is-mobile" href="#参考"><span class="level-left"><span class="level-item">9</span><span class="level-item">参考</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/android-%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">Android 实用工具</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/android-%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/"><span class="level-start"><span class="level-item">Android 应用开发</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/android-%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/"><span class="level-start"><span class="level-item">Android 系统原理</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/android-%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/"><span class="level-start"><span class="level-item">Android 逆向工程</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3/"><span class="level-start"><span class="level-item">参考文档</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">实用工具</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/"><span class="level-start"><span class="level-item">编程基础</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-06-29T16:45:50.000Z">2021-06-30</time></p><p class="title"><a href="/2021/06/30/%E6%94%AF%E6%8C%81%E8%A7%A6%E6%91%B8%E6%8B%96%E5%8A%A8%E7%9A%84-touchdelegate/">支持触摸拖动的 TouchDelegate</a></p><p class="categories"><a href="/categories/android-%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/">Android 应用开发</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-21T15:08:15.000Z">2021-04-21</time></p><p class="title"><a href="/2021/04/21/gdb-arm-%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">GDB ARM 交叉编译环境搭建</a></p><p class="categories"><a href="/categories/android-%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/">Android 实用工具</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-21T15:04:39.000Z">2021-04-21</time></p><p class="title"><a href="/2021/04/21/dropbear-android-%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4/">Dropbear Android 安装步骤</a></p><p class="categories"><a href="/categories/android-%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/">Android 实用工具</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-21T14:49:48.000Z">2021-04-21</time></p><p class="title"><a href="/2021/04/21/material-design-%E5%8F%82%E8%80%83/">Material Design 参考</a></p><p class="categories"><a href="/categories/%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3/">参考文档</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-21T10:20:58.000Z">2021-04-21</time></p><p class="title"><a href="/2021/04/21/android-avd-%E4%BD%8D%E7%BD%AE%E4%BF%AE%E6%94%B9/">Android AVD 位置修改</a></p><p class="categories"><a href="/categories/android-%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/">Android 实用工具</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">四月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/02/"><span class="level-start"><span class="level-item">二月 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/arm/"><span class="tag">ARM</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/avd/"><span class="tag">AVD</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/activity/"><span class="tag">Activity</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/android/"><span class="tag">Android</span><span class="tag">23</span></a></div><div class="control"><a class="tags has-addons" href="/tags/assembly/"><span class="tag">Assembly</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/binder/"><span class="tag">Binder</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/classloader/"><span class="tag">ClassLoader</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/computer/"><span class="tag">Computer</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dex/"><span class="tag">Dex</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/elf/"><span class="tag">ELF</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/emulator/"><span class="tag">Emulator</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">Git</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/jni/"><span class="tag">JNI</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/java/"><span class="tag">Java</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/log/"><span class="tag">Log</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/make/"><span class="tag">Make</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/makefile/"><span class="tag">Makefile</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/markdown/"><span class="tag">MarkDown</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/metrial/"><span class="tag">Metrial</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ndk/"><span class="tag">NDK</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/regex/"><span class="tag">Regex</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssh/"><span class="tag">SSH</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/theme/"><span class="tag">Theme</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/touch/"><span class="tag">Touch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/view/"><span class="tag">View</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xposed/"><span class="tag">Xposed</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zygote/"><span class="tag">Zygote</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/aapt/"><span class="tag">aapt</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%83%AD%E4%BF%AE%E5%A4%8D/"><span class="tag">热修复</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%83%AD%E6%9B%B4%E6%96%B0/"><span class="tag">热更新</span><span class="tag">1</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="l0neman 的博客" height="28"></a><p class="is-size-7"><span>&copy; 2021 l0neman</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/l0neman"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>