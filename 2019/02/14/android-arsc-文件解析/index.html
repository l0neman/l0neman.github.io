<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Android arsc 文件解析 - l0neman 的博客</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="l0neman 的博客"><meta name="msapplication-TileImage" content="/img/avatar.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="l0neman 的博客"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="apk 文件结构在使用 Android SDK 编译 Android 工程时，它会将工程的源代码和资源打包为一个 apk 文件，apk 文件实质为一个压缩包，一个未签名的 apk 文件典型结构如下： 1234567apk file:assets&amp;#x2F;         - assets 原始资源文件lib&amp;#x2F;            - so 库文件res&amp;#x2F;            - 资源文件 classe"><meta property="og:type" content="blog"><meta property="og:title" content="Android arsc 文件解析"><meta property="og:url" content="https://l0neman.github.io/2019/02/14/android-arsc-%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90/"><meta property="og:site_name" content="l0neman 的博客"><meta property="og:description" content="apk 文件结构在使用 Android SDK 编译 Android 工程时，它会将工程的源代码和资源打包为一个 apk 文件，apk 文件实质为一个压缩包，一个未签名的 apk 文件典型结构如下： 1234567apk file:assets&amp;#x2F;         - assets 原始资源文件lib&amp;#x2F;            - so 库文件res&amp;#x2F;            - 资源文件 classe"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://l0neman.github.io/2019/02/14/android-arsc-%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90/arsc_struct.png"><meta property="article:published_time" content="2019-02-13T19:06:01.000Z"><meta property="article:modified_time" content="2019-02-13T19:06:01.000Z"><meta property="article:author" content="l0neman"><meta property="article:tag" content="Android"><meta property="article:tag" content="aapt"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="./arsc_struct.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://l0neman.github.io/2019/02/14/android-arsc-%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90/"},"headline":"Android arsc 文件解析","image":["https://l0neman.github.io/2019/02/14/android-arsc-%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90/arsc_struct.png"],"datePublished":"2019-02-13T19:06:01.000Z","dateModified":"2019-02-13T19:06:01.000Z","author":{"@type":"Person","name":"l0neman"},"publisher":{"@type":"Organization","name":"l0neman 的博客","logo":{"@type":"ImageObject","url":"https://l0neman.github.io/img/logo.png"}},"description":"apk 文件结构在使用 Android SDK 编译 Android 工程时，它会将工程的源代码和资源打包为一个 apk 文件，apk 文件实质为一个压缩包，一个未签名的 apk 文件典型结构如下： 1234567apk file:assets&#x2F;         - assets 原始资源文件lib&#x2F;            - so 库文件res&#x2F;            - 资源文件 classe"}</script><link rel="canonical" href="https://l0neman.github.io/2019/02/14/android-arsc-%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90/"><link rel="icon" href="/img/avatar.png"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.15.2/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?1727d76e0a823184efc8776f32a916a9";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="l0neman 的博客" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/l0neman"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-three-quarters"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-02-13T19:06:01.000Z" title="2019/2/14 上午3:06:01">2019-02-14</time>发表</span><span class="level-item"><time dateTime="2019-02-13T19:06:01.000Z" title="2019/2/14 上午3:06:01">2019-02-14</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/android-%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/">Android 逆向工程</a></span><span class="level-item">1 小时读完 (大约7487个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Android arsc 文件解析</h1><div class="content"><h2 id="apk-文件结构"><a href="#apk-文件结构" class="headerlink" title="apk 文件结构"></a>apk 文件结构</h2><p>在使用 Android SDK 编译 Android 工程时，它会将工程的源代码和资源打包为一个 apk 文件，apk 文件实质为一个压缩包，一个未签名的 apk 文件典型结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apk file:</span><br><span class="line">assets/         - assets 原始资源文件</span><br><span class="line">lib/            - so 库文件</span><br><span class="line">res/            - 资源文件 </span><br><span class="line">classes.dex     - 编译后的代码</span><br><span class="line">resources.arsc  - 资源信息文件</span><br><span class="line">AndroidManifest.xml - 二进制的清单文件</span><br></pre></td></tr></table></figure>

<p>在 Android 项目的编译过程中，Java 代码将会被编译为 classes.dex 文件，JNI 代码被编译为 .so 文件存放在 lib 目录下，assets 目录和 res/raw 目录中文件的将不会发生变化，对于资源文件中 xml 形式的资源将会被编译为优化过的特定的二进制 xml 格式，而类似于图片这种本身为二进制的类型也不会发生变化，AndroidManifest.xml 清单文件被编译为优化过的二进制格式。</p>
<span id="more"></span>


<h2 id="资源编译过程"><a href="#资源编译过程" class="headerlink" title="资源编译过程"></a>资源编译过程</h2><p>在开发 Android 项目时，需要在布局中引用资源，当资源在工程中被创建时，IDE 将会使用 Android SDK 中的 aapt 工具自动生成 R.java 文件，这时在代码或布局文件中即可使用资源 id 来引用资源。</p>
<p>在 aapt 工具生成 R 文件的同时，还同时生成了一个 resources.arsc 文件，它负责记录资源信息，类似于一张表，当 apk 运行在 Android 设备时，应用将会首先将 resources.arsc 包含的资源信息映射到内存中的数据结构中，当需要使用资源 id 引用具体资源时，只需要在内存中的数据结构中进行查询，即可得到具体的资源文件路径。</p>
<p>一个典型的资源 id 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7f020000</span></span><br></pre></td></tr></table></figure>

<p>它由 3 部分组成：</p>
<ol>
<li>首字节为 Package ID，代表资源所在的资源包 ID，一般 apk 中只包含两种资源包，系统资源包和应用资源包，它们的包 ID 分别为 0x01 和 0x7f。</li>
<li>次字节为 Type ID，代表资源类型，即 animator、anim、color、drawable、layout、menu、raw、string 和 xml 等类型，每种类型对应一个 id。</li>
<li>末两个字节为 Entry ID，代表资源在其类型中的次序。</li>
</ol>
<p>aapt 工具编译资源的过程是比较复杂的，其中的步骤非常细致，在它编译时会将资源逐步保存至一个 ResourceTable 类中，它的源码路径是 <code>frameworks\base\tools\aapt\ResourceTable</code>，下面简述资源编译过程（参考了罗升阳的博客）。</p>
<h3 id="1-Parse-AndroidManifst-xml"><a href="#1-Parse-AndroidManifst-xml" class="headerlink" title="1. Parse AndroidManifst.xml"></a>1. Parse AndroidManifst.xml</h3><p>解析 Android 清单文件中的 package 属性，为了提供生成 R 文件的包名。</p>
<h3 id="2-Add-Included-Resources"><a href="#2-Add-Included-Resources" class="headerlink" title="2. Add Included Resources"></a>2. Add Included Resources</h3><p>添加被引用的资源包，此时会引用系统资源包，在 android 源码工程的 <code>out/target/common/obj/APPS/framework-res_intermediates/package-export.apk</code>，可通过资源 id 引用其中的资源。</p>
<h3 id="3-Collection-Resource-Files"><a href="#3-Collection-Resource-Files" class="headerlink" title="3. Collection Resource Files"></a>3. Collection Resource Files</h3><p>aapt 工具开始收集需要编译的资源，将每种类型的资源以及对应的配置维度保存起来。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Type         Name             Config         Data</span><br><span class="line">anim</span><br><span class="line">xml</span><br><span class="line">color</span><br><span class="line">drawable     main.png</span><br><span class="line">...          sub.png</span><br><span class="line">             ok.png            mdpi   </span><br><span class="line">             ...               hdpi</span><br><span class="line">                               xhdpi         binary</span><br><span class="line">                               ...</span><br></pre></td></tr></table></figure>



<h3 id="4-Add-Resources-to-Resource-Table"><a href="#4-Add-Resources-to-Resource-Table" class="headerlink" title="4. Add Resources to Resource Table"></a>4. Add Resources to Resource Table</h3><p>将资源加入资源表。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Package         Type         Name             Config         Path</span><br><span class="line">com.xx.xx       anim</span><br><span class="line">                xml</span><br><span class="line">                color</span><br><span class="line">                drawable     main.png</span><br><span class="line">                ...          sub.png</span><br><span class="line">                             ok.png            mdpi   </span><br><span class="line">                             ...               hdpi          res/drawable-hdpi/ok.png</span><br><span class="line">                                               xhdpi         res/drawable-xhdpi/ok.png</span><br><span class="line">                                               ...           ...</span><br></pre></td></tr></table></figure>



<h3 id="5-Compile-Values-Resources"><a href="#5-Compile-Values-Resources" class="headerlink" title="5. Compile Values Resources"></a>5. Compile Values Resources</h3><p>收集 value 下的资源。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Package       Name              Config         Value</span><br><span class="line">string        app_name          default        TestApp</span><br><span class="line">string        sub_title         default        SubTitleText</span><br><span class="line">...           ...               ...            ...</span><br></pre></td></tr></table></figure>



<h3 id="6-Assign-Resource-ID-to-Bag"><a href="#6-Assign-Resource-ID-to-Bag" class="headerlink" title="6. Assign Resource ID to Bag"></a>6. Assign Resource ID to Bag</h3><p>给特殊的 Bag 资源类型分配 id，例如 style，array 等资源。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Type         Name                   Configt         Value</span><br><span class="line">style        orientation            default         -</span><br><span class="line">...          layout_vertical        default         0</span><br><span class="line">             layout_horizontal      default         1</span><br><span class="line">             ...                    ...             ...</span><br></pre></td></tr></table></figure>



<h3 id="7-Compile-Xml-Resources"><a href="#7-Compile-Xml-Resources" class="headerlink" title="7. Compile Xml Resources"></a>7. Compile Xml Resources</h3><p>这一步是将 xml 类型的资源编译为优化过后的二进制格式，便于压缩大小和解析时提高性能。有 6 个子步骤。</p>
<ol>
<li><p>Parser Xml File（解析原始 xml 文件中的节点树）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">XMLNode</span><br><span class="line">-elementName   -Xml 元素标签</span><br><span class="line">-chars         -Xml 元素的文本内容</span><br><span class="line">-attributes    -Xml 元素的属性列表</span><br><span class="line">-children      -Xml 的子元素</span><br></pre></td></tr></table></figure></li>
<li><p>Assign Resource IDs（赋予属性名资源 id）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">android:layout_width  -&gt; find ResID From ResourceTable -&gt; set ResID</span><br><span class="line">android:layout_height -&gt; find ResID From ResourceTable -&gt; set ResID</span><br><span class="line">android:gravity       -&gt; find ResID From ResourceTable -&gt; set ResID</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li>
<li><p>Parse Values（解析属性的原始值）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">android:orientation = horizontal -&gt; 0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>对于 <code>@+</code> 符号表示无此 id，则新建此 id。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">name            Config         Value</span><br><span class="line">et_name         default        -</span><br><span class="line">et_pwd          default        -</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li>
<li><p>Flatten（平铺，即转化为最终的二进制格式）</p>
<ol>
<li><p>Collect Resource ID Strings（收集有资源 id 的属性的名称字符串）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String         orientation  layout_width  layout_height  id           ...</span><br><span class="line">Resource ID    0x010100c4   0x010100f4    0x010100f5     0x010100d0   ...</span><br></pre></td></tr></table></figure></li>
<li><p>Collect Strings（收集其他字符串）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String android  http://schemas.android.com/apk/res/android  LinearLayout ...</span><br></pre></td></tr></table></figure></li>
<li><p>Write Xml header（写入 xml 头部）</p>
</li>
<li><p>Write String Pool（依 id 次序写入字符串池）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">orientation  layout_width  layout_height  id  android  http://schemas.android.com/apk/res/android  LinearLayout Button</span><br></pre></td></tr></table></figure></li>
<li><p>Write Resource IDs（写入资源 id 值二进制的 xml 文件中）</p>
</li>
<li><p>Flatten Nodes（平铺，即将二进制的 xml 文件中的资源全部替换为资源索引）</p>
</li>
</ol>
</li>
</ol>
<h3 id="8-Add-Resource-Symbols"><a href="#8-Add-Resource-Symbols" class="headerlink" title="8. Add Resource Symbols"></a>8. Add Resource Symbols</h3><p>添加资源符号，根据资源在其资源类型中的位置，为每个资源分配资源 id。</p>
<h3 id="9-Write-resource-arsc"><a href="#9-Write-resource-arsc" class="headerlink" title="9. Write resource.arsc"></a>9. Write resource.arsc</h3><p>将上述收集的资源写入 resoruce.arsc 文件中。分为 7 个步骤。</p>
<ol>
<li><p>Collect Type Strings（收集每个 package 的类型字符串）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drawable  layout  string  id  ...</span><br></pre></td></tr></table></figure></li>
<li><p>Collect Key Strings（收集每个 package 的资源项的名称字符串）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">main icon  app_name  et_name ... </span><br></pre></td></tr></table></figure></li>
<li><p>Collect Value Strings（收集资源原始值字符串）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res/drawable-ldpi/icon.png  TestApp  SubTitleText</span><br></pre></td></tr></table></figure></li>
<li><p>Generate Package Trunk（生成 package 数据块）</p>
<ol>
<li>Write Package Header（写入 package 资源的原信息数据块）</li>
<li>Write Type Strings（写入类型字符串资源池）</li>
<li>Write Key Strings（写入资源项名称字符串资源池）</li>
<li>Write Type Specification（写入类型规范数据块）</li>
<li>Write Type Info（写入类型资源项数据块）</li>
</ol>
</li>
<li><p>Write Resource Table Header（写入资源表的头部数据块）</p>
</li>
<li><p>Write Value Strings（ 写入上面收集的资源项的值字符串）</p>
</li>
<li><p>Write Package Trunk（写入上面收集的 Package 数据块）</p>
</li>
</ol>
<h3 id="10-Compile-AndroidManifest-xml"><a href="#10-Compile-AndroidManifest-xml" class="headerlink" title="10. Compile AndroidManifest.xml"></a>10. Compile AndroidManifest.xml</h3><p>将 AndroidManifest.xml 编译为二进制。</p>
<h3 id="11-Write-R-java"><a href="#11-Write-R-java" class="headerlink" title="11. Write R.java"></a>11. Write R.java</h3><p>生成 R 文件。</p>
<h3 id="12-Write-APK"><a href="#12-Write-APK" class="headerlink" title="12. Write APK"></a>12. Write APK</h3><p>写入 apk 文件。</p>
<h2 id="arsc-文件结构"><a href="#arsc-文件结构" class="headerlink" title="arsc 文件结构"></a>arsc 文件结构</h2><p>arsc 文件作为资源信息的存储结构，其结构将会遵循上述编译过程的写入顺序。整体结构如下图所示：</p>
<p><img src="./arsc_struct.png" alt="arsc_struct"></p>
<p>（图片来自互联网）</p>
<p>arsc 文件的由若干 chunk 结构组成，所有 chunk 在 android 源码中的 <code>ResourceTypes.h</code> 头文件中均有定义，路径为 <code>frameworks\base\include\utils\ResourceTypes.h</code>。</p>
<p>对于不同 android 版本的 <code>ResourceTypes.h</code> 头文件，为了保证向下兼容性，所以其定义的 chunk 结构相同，不过高版本相对于低版本可能增加了一些配置的常量，例如适配高分辨率设备的 xxhdpi，xxxhdpi 维度选项。</p>
<p>每个 chunk 都会包含一个基础描述类型的对象，它的原始定义如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ResChunk_header</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">/* Chunk 类型 */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> type;</span><br><span class="line">    <span class="comment">/* Chunk 头部大小 */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> headerSize;</span><br><span class="line">    <span class="comment">/* Chunk 大小 */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> size;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中类型 type 的值定义如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    RES_NULL_TYPE               = <span class="number">0x0000</span>,</span><br><span class="line">    RES_STRING_POOL_TYPE        = <span class="number">0x0001</span>,</span><br><span class="line">    RES_TABLE_TYPE              = <span class="number">0x0002</span>,</span><br><span class="line">    RES_XML_TYPE                = <span class="number">0x0003</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Chunk types in RES_XML_TYPE</span></span><br><span class="line">    RES_XML_FIRST_CHUNK_TYPE    = <span class="number">0x0100</span>,</span><br><span class="line">    RES_XML_START_NAMESPACE_TYPE= <span class="number">0x0100</span>,</span><br><span class="line">    RES_XML_END_NAMESPACE_TYPE  = <span class="number">0x0101</span>,</span><br><span class="line">    RES_XML_START_ELEMENT_TYPE  = <span class="number">0x0102</span>,</span><br><span class="line">    RES_XML_END_ELEMENT_TYPE    = <span class="number">0x0103</span>,</span><br><span class="line">    RES_XML_CDATA_TYPE          = <span class="number">0x0104</span>,</span><br><span class="line">    RES_XML_LAST_CHUNK_TYPE     = <span class="number">0x017f</span>,</span><br><span class="line">    <span class="comment">// This contains a uint32_t array mapping strings in the string</span></span><br><span class="line">    <span class="comment">// pool back to resource identifiers.  It is optional.</span></span><br><span class="line">    RES_XML_RESOURCE_MAP_TYPE   = <span class="number">0x0180</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Chunk types in RES_TABLE_TYPE</span></span><br><span class="line">    RES_TABLE_PACKAGE_TYPE      = <span class="number">0x0200</span>,</span><br><span class="line">    RES_TABLE_TYPE_TYPE         = <span class="number">0x0201</span>,</span><br><span class="line">    RES_TABLE_TYPE_SPEC_TYPE    = <span class="number">0x0202</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>它表示每种 chunk 的类型，类似于标识文件类型的魔数，而 chunk 大小 <code>size</code> 则表示此 chunk 的容量。</p>
<p>下面开始对 arsc 文件的结构进行解析，这里使用 java 语言进行解析，为了方便，对于 <code>ResourceTypes.h</code> 中的类型，在 java 中都应该定义对应的类，例如基础描述结构体 <code>ResChunk_header</code> 使用 java 定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 资源表 Chunk 基础描述结构。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResChunkHeader</span> </span>&#123;</span><br><span class="line">  <span class="comment">/** Chunk 类型 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">short</span> type;</span><br><span class="line">  <span class="comment">/** Chunk 头部大小 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">short</span> headerSize;</span><br><span class="line">  <span class="comment">/** Chunk 大小 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="arsc-文件解析"><a href="#arsc-文件解析" class="headerlink" title="arsc 文件解析"></a>arsc 文件解析</h2><p>为了便于解析，这里使用了我自己写的工具类，参考这里的简介： <a target="_blank" rel="noopener" href="https://github.com/l0neman/program-notes/blob/master/android-notes-reverse/utils_parse.md">ObjectIO</a>。</p>
<h3 id="解析方法"><a href="#解析方法" class="headerlink" title="解析方法"></a>解析方法</h3><p>针对上述 arsc 文件结构，采用如下方式进行解析：</p>
<ol>
<li>定义指针变量标识当前解析的字节位置，每解析完一个 chunk 则向下移动指针 chunk 的大小。</li>
<li>采用循环解析的方式，通过 chunk 的 <code>type</code> 判断将要解析哪种 chunk，解析对应的结构。 </li>
</ol>
<p>这里定义了 ArscParser 解析器，<code>mIndex</code> 为指针变量，<code>parse(ObjectIO objectIO)</code> 为解析子方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArscParser</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> mIndex;</span><br><span class="line">  ...</span><br><span class="line">      </span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">(ObjectIO objectIO)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 是否到达文件底部。</span></span><br><span class="line">    <span class="keyword">while</span> (!objectIO.isEof(mIndex)) &#123;</span><br><span class="line">      <span class="comment">// 获取将要解析的 chunk 头部信息。 </span></span><br><span class="line">      ResChunkHeader header = objectIO.read(ResChunkHeader.class, mIndex);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 根据类型解析对应格式。</span></span><br><span class="line">      <span class="keyword">switch</span> (header.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> ResourceTypes.RES_TABLE_TYPE: ...</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ResourceTypes.RES_STRING_POOL_TYPE: ...</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ResourceTypes.RES_TABLE_PACKAGE_TYPE: ...</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ResourceTypes.RES_TABLE_TYPE_SPEC_TYPE: ...</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ResourceTypes.RES_TABLE_TYPE_TYPE: ...</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="parse-RES-TABLE-TYPE"><a href="#parse-RES-TABLE-TYPE" class="headerlink" title="parse RES_TABLE_TYPE"></a>parse RES_TABLE_TYPE</h3><p>参考上面的 arsc 结构所示，首先解析的是资源表头部，它描述了整个 arsc 文件的大小，以及包含的资源包数量。</p>
<p>它的 <code>type</code> 值为 <code>RES_TABLE_TYPE</code>，对应的数据结构为 <code>struct ResTable_header</code>，java 对应的表示为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 资源表头结构，对应 ResourceTypes.h 中定义的 ResTable_header。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResTableHeader</span> <span class="keyword">implements</span> <span class="title">Struct</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> ResChunkHeader#type&#125; = &#123;<span class="doctag">@link</span> ResourceTypes#RES_TABLE_TYPE&#125;</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> ResChunkHeader#headerSize&#125; = sizeOf(ResTableHeader.class) 表示头部大小。</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> ResChunkHeader#size&#125; = 整个 resources.arsc 文件的大小。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> ResChunkHeader header;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 被编译的资源包数量。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> packageCount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么解析代码即：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ArscParser.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">(ObjectIO objectIO)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  ResChunkHeader header = objectIO.read(ResChunkHeader.class, mIndex);</span><br><span class="line">  <span class="keyword">switch</span> (header.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> ResourceTypes.RES_TABLE_TYPE:</span><br><span class="line">      parseResTableType(objectIO);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ArscParser.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseResTableType</span><span class="params">(ObjectIO objectIO)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> ResTableHeader tableType = objectIO.read(ResTableHeader.class, mIndex);</span><br><span class="line">  System.out.println(<span class="string">&quot;resource table header:&quot;</span>);</span><br><span class="line">  System.out.println(tableType);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 向下移动资源表头部的大小。</span></span><br><span class="line">  mIndex += tableType.header.headerSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试广点通的 arsc 文件（resources_gdt1.arsc）打印结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">resource table header:</span><br><span class="line">&#123;header=&#123;type=2(RES_TABLE_TYPE), headerSize=12, size=6384&#125;, packageCount=1&#125;</span><br></pre></td></tr></table></figure>



<h3 id="parse-RES-STRING-POOL-TYPE"><a href="#parse-RES-STRING-POOL-TYPE" class="headerlink" title="parse RES_STRING_POOL_TYPE"></a>parse RES_STRING_POOL_TYPE</h3><p>接下来是全局字符串池的解析，它包括如下几个部分：</p>
<ol>
<li>ResStringPool_header 字符串池头部，包含字符串池的信息，大小，数量，数组偏移等。</li>
<li>String Offset Array 字符串在字符串内容中的字节位置数组，32 位 int 类型。</li>
<li>Style Offset Array 字符串样式在字符串样式中的字节位置数组，32 位 int 类型。</li>
<li>String Content 字符串内容块。</li>
<li>Style Content 字符串样式块。</li>
</ol>
<p>字符串池的头部使用 <code>struct ResStringPool_header</code> 数据结构描述，java 表示为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 字符串池头部。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResStringPoolHeader</span> <span class="keyword">implements</span> <span class="title">Struct</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SORTED_FLAG = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UTF8_FLAG = <span class="number">1</span> &lt;&lt; <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> ResChunkHeader#type&#125; = &#123;<span class="doctag">@link</span> ResourceTypes#RES_STRING_POOL_TYPE&#125;</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> ResChunkHeader#headerSize&#125; = sizeOf(ResStringPoolHeader.class) 表示头部大小。</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> ResChunkHeader#size&#125; = 整个字符串 Chunk 的大小，包括 headerSize 的大小。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> ResChunkHeader header;</span><br><span class="line">  <span class="comment">/** 字符串的数量 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> stringCount;</span><br><span class="line">  <span class="comment">/** 字符串样式的数量 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> styleCount;</span><br><span class="line">  <span class="comment">/** 0, SORTED_FLAG, UTF8_FLAG 它们的组合值 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> flags;</span><br><span class="line">  <span class="comment">/** 字符串内容块相对于其头部的距离 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> stringStart;</span><br><span class="line">  <span class="comment">/** 字符串样式块相对于其头部的距离 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> styleStart;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 <code>flags</code> 包含 <code>UTF8_FLAG</code> 表示字符串格式为 utf8， <code>SORTED_FLAG</code> 表示已排序。</p>
<p>字符串的偏移数组使用 <code>struct ResStringPool_ref</code> 数据结构描述，java 表示为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 字符串在字符串内容块中的字节偏移。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResStringPoolRef</span> <span class="keyword">implements</span> <span class="title">Struct</span></span>&#123;</span><br><span class="line">  <span class="comment">/** 字符串在字符串池中的索引 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>字符串样式则使用 <code>struct ResStringPool_span</code> 数据结构描述，java 表示为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 字符串样式块中的字符串样式信息。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResStringPoolSpan</span> <span class="keyword">implements</span> <span class="title">Struct</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> END = <span class="number">0xFFFFFFFF</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** 本样式在字符串内容块中的字节位置 */</span></span><br><span class="line">  <span class="keyword">public</span> ResStringPoolRef name;</span><br><span class="line">  <span class="comment">/** 包含样式的字符串的第一个字符索引 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> firstChar;</span><br><span class="line">  <span class="comment">/** 包含样式的字符串的最后一个字符索引 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> lastChar;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 <code>name</code> 表示字符串样式本身字符串的索引，比如 <code>&lt;b&gt;</code> 样式本身的字符串为 b，即为 b 在字符串池中的索引。 </p>
<p><code>firstChar</code> 和 <code>lastChar</code> 则为具有样式的字符串的中字符串首位的索引，例如 <code>he&lt;b&gt;ll&lt;/b&gt;o</code>，则为 2 和 3。</p>
<p>字符串样式块和字符串内容块是一一对应的，就是说第一个字符串的样式对应第一个字符串样式块中的样式，如果对应的字符串中有不具有样式的字符串，则对应的 <code>ResStringPool_span</code> 的 <code>name</code> 为 <code>0xFFFFFFFF</code>，起占位的作用。</p>
<p>解析过程如下：</p>
<ol>
<li>首先解析 <code>ResStringPool_header</code>，其中包含字符串和样式池的信息。</li>
<li>通过 <code>header</code> 中 <code>stringCount</code>（字符串数量） 和 <code>styleContent</code>（样式数量）解析出字符串和样式偏移数组。</li>
<li>通过 <code>header</code> 中的 <code>stringStart</code> 找到字符串块的起始字节位置，结合字符串偏移数组解析字符串内容。</li>
<li>通过 <code>header</code> 中的 <code>styleStart</code> 找到样式块的起始字节位置，结合样式偏移数组解析样式内容。</li>
</ol>
<p>需要注意的是每个字符串的前两个字节表示这个字符串的长度，末尾则为结束符 0。</p>
<p>下面是解析代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ArscParser.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">(ObjectIO objectIO)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  ResChunkHeader header = objectIO.read(ResChunkHeader.class, mIndex);</span><br><span class="line">  <span class="keyword">switch</span> (header.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> ResourceTypes.RES_STRING_POOL_TYPE:</span><br><span class="line">      parseStringPool(objectIO);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ArscParser.java</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseStringPool</span><span class="params">(ObjectIO objectIO)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">long</span> stringPoolIndex = mIndex;</span><br><span class="line">  ResStringPoolHeader stringPoolHeader = objectIO.read(ResStringPoolHeader.class, stringPoolIndex);</span><br><span class="line">  System.out.println(<span class="string">&quot;string pool header:&quot;</span>);</span><br><span class="line">  System.out.println(stringPoolHeader);</span><br><span class="line"></span><br><span class="line">  StringPoolChunkParser stringPoolChunkParser = <span class="keyword">new</span> StringPoolChunkParser();</span><br><span class="line">  stringPoolChunkParser.parseStringPoolChunk(objectIO, stringPoolHeader, stringPoolIndex);</span><br><span class="line"></span><br><span class="line">  System.out.println();</span><br><span class="line">  System.out.println(<span class="string">&quot;string index array:&quot;</span>);</span><br><span class="line">  System.out.println(Arrays.toString(stringPoolChunkParser.getStringIndexArray()));</span><br><span class="line"></span><br><span class="line">  System.out.println();</span><br><span class="line">  System.out.println(<span class="string">&quot;style index array:&quot;</span>);</span><br><span class="line">  System.out.println(Arrays.toString(stringPoolChunkParser.getStyleIndexArray()));</span><br><span class="line"></span><br><span class="line">  stringPool = stringPoolChunkParser.getStringPool();</span><br><span class="line"></span><br><span class="line">  System.out.println();</span><br><span class="line">  System.out.println(<span class="string">&quot;string pool:&quot;</span>);</span><br><span class="line">  System.out.println(Arrays.toString(stringPool));</span><br><span class="line"></span><br><span class="line">  System.out.println();</span><br><span class="line">  System.out.println(<span class="string">&quot;style pool:&quot;</span>);</span><br><span class="line">  <span class="keyword">final</span> List&lt;ResStringPoolSpan&gt;[] stylePool = stringPoolChunkParser.getStylePool();</span><br><span class="line"></span><br><span class="line">  System.out.println(Arrays.toString(stylePool));</span><br><span class="line"></span><br><span class="line">  System.out.println();</span><br><span class="line">  System.out.println(<span class="string">&quot;style detail:&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (List&lt;ResStringPoolSpan&gt; spans : stylePool) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;---------&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (ResStringPoolSpan span : spans) &#123;</span><br><span class="line">      System.out.println(stringPool[span.name.index]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 向下移动字符串池的大小。</span></span><br><span class="line">  mIndex += stringPoolHeader.header.size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// StringPoolChunkParser.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringPoolChunkParser</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> ResStringPoolRef[] stringIndexArray;</span><br><span class="line">  <span class="keyword">private</span> ResStringPoolRef[] styleIndexArray;</span><br><span class="line">  <span class="keyword">private</span> String[] stringPool;</span><br><span class="line">  <span class="keyword">private</span> List&lt;ResStringPoolSpan&gt;[] stylePool;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> ResStringPoolRef[] parseStringIndexArray(ObjectIO objectIO, ResStringPoolHeader header, <span class="keyword">long</span> index)</span><br><span class="line">      <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    stringIndexArray = <span class="keyword">new</span> ResStringPoolRef[header.stringCount];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> start = index;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> resStringPoolRefSize = ObjectIO.sizeOf(ResStringPoolRef.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; header.stringCount; i++) &#123;</span><br><span class="line">      stringIndexArray[i] = objectIO.read(ResStringPoolRef.class, start);</span><br><span class="line">      start += resStringPoolRefSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> stringIndexArray;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> ResStringPoolRef[] parseStyleIndexArray(ObjectIO objectIO, ResStringPoolHeader header, <span class="keyword">long</span> index)</span><br><span class="line">      <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    styleIndexArray = <span class="keyword">new</span> ResStringPoolRef[header.styleCount];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> start = index;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> resStringPoolRefSize = ObjectIO.sizeOf(ResStringPoolRef.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; header.styleCount; i++) &#123;</span><br><span class="line">      styleIndexArray[i] = objectIO.read(ResStringPoolRef.class, start);</span><br><span class="line">      start += resStringPoolRefSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> styleIndexArray;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">parseStringLength</span><span class="params">(<span class="keyword">byte</span>[] b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> b[<span class="number">1</span>] &amp; <span class="number">0x7F</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String[] parseStringPool(ObjectIO objectIO, ResStringPoolHeader header, <span class="keyword">long</span> stringPoolIndex)</span><br><span class="line">      <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    String[] stringPool = <span class="keyword">new</span> String[header.stringCount];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; header.stringCount; i++) &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">long</span> index = stringPoolIndex + stringIndexArray[i].index;</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">int</span> parseStringLength = parseStringLength(objectIO.readBytes(index, Short.BYTES));</span><br><span class="line">      <span class="comment">// 经过测试，发现 flags 为0 时，字符串每个字符间会间隔一个空白符，长度变为 2 倍。</span></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">int</span> stringLength = header.flags == <span class="number">0</span> ? parseStringLength * <span class="number">2</span> : parseStringLength;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// trim 去除多余空白符。</span></span><br><span class="line">      stringPool[i] = Formatter.trim(<span class="keyword">new</span> String(objectIO.readBytes(index + Short.BYTES, stringLength), <span class="number">0</span>,</span><br><span class="line">          stringLength, StandardCharsets.UTF_8));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> stringPool;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> List&lt;ResStringPoolSpan&gt;[] parseStylePool(ObjectIO objectIO, ResStringPoolHeader header, <span class="keyword">long</span> stylePoolIndex)</span><br><span class="line">      <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    List&lt;ResStringPoolSpan&gt;[] stylePool = <span class="keyword">new</span> List[header.styleCount];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; header.styleCount; i++) &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">long</span> index = stylePoolIndex + styleIndexArray[i].index;</span><br><span class="line">      <span class="keyword">int</span> end = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">long</span> littleIndex = index;</span><br><span class="line"></span><br><span class="line">      List&lt;ResStringPoolSpan&gt; stringPoolSpans = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">      <span class="keyword">while</span> (end != ResStringPoolSpan.END) &#123;</span><br><span class="line">        ResStringPoolSpan stringPoolSpan = objectIO.read(ResStringPoolSpan.class, littleIndex);</span><br><span class="line">        stringPoolSpans.add(stringPoolSpan);</span><br><span class="line"></span><br><span class="line">        littleIndex += ObjectIO.sizeOf(ResStringPoolSpan.class);</span><br><span class="line"></span><br><span class="line">        end = objectIO.readInt(littleIndex);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      stylePool[i] = stringPoolSpans;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> stylePool;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseStringPoolChunk</span><span class="params">(ObjectIO objectIO, ResStringPoolHeader header, <span class="keyword">long</span> stringPoolHeaderIndex)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// parse string index array.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> stringIndexArrayIndex = stringPoolHeaderIndex + ObjectIO.sizeOf(ResStringPoolHeader.class);</span><br><span class="line"></span><br><span class="line">    stringIndexArray = header.stringCount == <span class="number">0</span> ? <span class="keyword">new</span> ResStringPoolRef[<span class="number">0</span>] :</span><br><span class="line">        parseStringIndexArray(objectIO, header, stringIndexArrayIndex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> styleIndexArrayIndex = stringIndexArrayIndex + header.stringCount *</span><br><span class="line">        ObjectIO.sizeOf(ResStringPoolRef.class);</span><br><span class="line"></span><br><span class="line">    styleIndexArray = header.styleCount == <span class="number">0</span> ? <span class="keyword">new</span> ResStringPoolRef[<span class="number">0</span>] :</span><br><span class="line">        parseStyleIndexArray(objectIO, header, styleIndexArrayIndex);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// parse string pool.</span></span><br><span class="line">    <span class="keyword">if</span> (header.stringCount != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">long</span> stringPoolIndex = stringPoolHeaderIndex + header.stringStart;</span><br><span class="line">      stringPool = parseStringPool(objectIO, header, stringPoolIndex);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      stringPool = <span class="keyword">new</span> String[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// parse style pool.</span></span><br><span class="line">    <span class="keyword">if</span> (header.styleCount != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">long</span> stylePoolIndex = stringPoolHeaderIndex + header.styleStart;</span><br><span class="line">      stylePool = parseStylePool(objectIO, header, stylePoolIndex);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//noinspection unchecked</span></span><br><span class="line">      stylePool = <span class="keyword">new</span> List[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> ResStringPoolRef[] getStringIndexArray() &#123;</span><br><span class="line">    <span class="keyword">return</span> stringIndexArray;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> ResStringPoolRef[] getStyleIndexArray() &#123;</span><br><span class="line">    <span class="keyword">return</span> styleIndexArray;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> String[] getStringPool() &#123;</span><br><span class="line">    <span class="keyword">return</span> stringPool;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> List&lt;ResStringPoolSpan&gt;[] getStylePool() &#123;</span><br><span class="line">    <span class="keyword">return</span> stylePool;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例文件 resources_gdt1.arsc 的解析示例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">string pool header:</span><br><span class="line">&#123;header=&#123;type=1(RES_STRING_POOL_TYPE), headerSize=28, size=1220&#125;, stringCount=42, styleCount=0, flags=256, stringStart=196, styleStart=0&#125;</span><br><span class="line"></span><br><span class="line">string index array:</span><br><span class="line">[&#123;index=0&#125;, &#123;index=25&#125;, &#123;index=52&#125;, &#123;index=78&#125;, &#123;index=110&#125;, &#123;index=135&#125;, &#123;index=181&#125;, &#123;index=205&#125;, &#123;index=240&#125;, &#123;index=278&#125;, &#123;index=315&#125;, ... , &#123;index=879&#125;, &#123;index=904&#125;, &#123;index=932&#125;, &#123;index=960&#125;, &#123;index=972&#125;, &#123;index=995&#125;, &#123;index=1010&#125;]</span><br><span class="line"></span><br><span class="line">style index array: []</span><br><span class="line"></span><br><span class="line">string pool:</span><br><span class="line">[res/drawable/arrow.png, res/drawable/gdticon.png, res/drawable/gridbt.png, res/drawable/header_arrow.png, res/drawable/icon1.png, ... , 应用墙, CustomFeeds2Activity, 加载更多, TranspAct]</span><br><span class="line"></span><br><span class="line">style pool:[]</span><br><span class="line"></span><br><span class="line">style detail:</span><br></pre></td></tr></table></figure>

<p>这个文件没有样式，换一个示例文件 resources_cm.arsc 文件的 style 内容示例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">style pool:</span><br><span class="line">[[&#123;name=&#123;index=15915&#125;, firstChar=13, lastChar=16&#125;], [&#123;name=&#123;index=15916&#125;, firstChar=4, lastChar=7&#125;, &#123;name=&#123;index=15917&#125;, firstChar=11, lastChar=14&#125;], [&#123;name=&#123;index=15916&#125;, firstChar=4, lastChar=7&#125;, &#123;name=&#123;index=15917&#125;, firstChar=11, lastChar=14&#125;], [&#123;name=&#123;index=15918&#125;, firstChar=9, lastChar=12&#125;], [&#123;name=&#123;index=15919&#125;, firstChar=66, lastChar=69&#125;], [&#123;name=&#123;index=15916&#125;, firstChar=15, lastChar=26&#125;, &#123;name=&#123;index=15917&#125;, firstChar=32, lastChar=45&#125;]]</span><br><span class="line"></span><br><span class="line">style detail:</span><br><span class="line">---------</span><br><span class="line">g;id=app_name</span><br><span class="line">---------</span><br><span class="line">a;href=http://www.cmcm.com/protocol/cmbackup/terms-of-use.html</span><br><span class="line">a;href=http://www.cmcm.com/protocol/cmbackup/privacy.html</span><br><span class="line">---------</span><br><span class="line">a;href=http://www.cmcm.com/protocol/cmbackup/terms-of-use.html</span><br><span class="line">a;href=http://www.cmcm.com/protocol/cmbackup/privacy.html</span><br><span class="line">---------</span><br><span class="line">g;id=number</span><br><span class="line">---------</span><br><span class="line">g;id=string</span><br><span class="line">---------</span><br><span class="line">a;href=http://www.cmcm.com/protocol/cmbackup/terms-of-use.html</span><br><span class="line">a;href=http://www.cmcm.com/protocol/cmbackup/privacy.html</span><br></pre></td></tr></table></figure>



<h3 id="parse-RES-TABLE-PACKAGE-TYPE"><a href="#parse-RES-TABLE-PACKAGE-TYPE" class="headerlink" title="parse RES_TABLE_PACKAGE_TYPE"></a>parse RES_TABLE_PACKAGE_TYPE</h3><p>下面是资源项元信息的解析，它包含如下几个部分：</p>
<ol>
<li>ResTable_package 资源项元信息头部，包括 Package ID，包名和资源项索引信息。</li>
<li>Type String Pool 资源类型字符串池，例如 drawable, color, xml, animator。</li>
<li>Key String Pool 资源名字符串池。</li>
<li>Type Specification Trunk 类型规范数据块，描述资源的配置信息。</li>
<li>Type Info Trunk 类型资源项数据块。</li>
</ol>
<p>资源项元信息头部使用 <code>struct ResTable_package</code> 数据结构描述，使用 java 表示为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Package 资源项元信息头部。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResTablePackage</span> <span class="keyword">implements</span> <span class="title">Struct</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> ResChunkHeader#type&#125; = &#123;<span class="doctag">@link</span> ResourceTypes#RES_TABLE_PACKAGE_TYPE&#125;</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> ResChunkHeader#headerSize&#125; = sizeOf(ResTablePackage.class) 表示头部大小。</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> ResChunkHeader#size&#125; = head.headerSize + 类型字符串资源池大小 + 类型规范名称字符串池大小 +</span></span><br><span class="line"><span class="comment">   * 类型规范数据块大小 + 数据项信息数据块大小。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> ResChunkHeader header;</span><br><span class="line">  <span class="comment">/** Package ID */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> id;</span><br><span class="line">  <span class="comment">/** Package Name */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">char</span>[] name = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">128</span>];</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 类型字符串资源池相对头部的偏移位置。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> typeStrings;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 最后一个导出的 public 类型字符串在类型字符串资源池中的索引，目前这个值设置为类型字符串资源池的大小。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> lastPublicType;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 资源项名称字符串相对头部的偏移位置。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> keyStrings;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 最后一个导出的 public 资源项名称字符串在资源项名称字符串资源池中的索引，目前这个值设置为资源项名称字符串资源池的大小。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> lastPublicKey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Type String Pool 和 Key String Pool 的结构和上面的全局字符串结构完全相同。</p>
<p>Type Specification Trunk 和 Type Info Trunk 的 <code>chunk type</code> 分别为 <code>RES_TABLE_TYPE_SPEC_TYPE</code> 和 <code>RES_TABLE_TYPE_TYPE</code>，将在下面的步骤进行解析。</p>
<p>那么元信息头部和两个字符串池的解析代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ArscParser.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">(ObjectIO objectIO)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  ResChunkHeader header = objectIO.read(ResChunkHeader.class, mIndex);</span><br><span class="line">  <span class="keyword">switch</span> (header.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> ResourceTypes.RES_STRING_POOL_TYPE:</span><br><span class="line">      parseStringPool(objectIO);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ResourceTypes.RES_TABLE_PACKAGE_TYPE:</span><br><span class="line">      parseTablePackageType(objectIO);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ArscParser.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseTablePackageType</span><span class="params">(ObjectIO objectIO)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">long</span> tablePackageIndex = mIndex;</span><br><span class="line">  <span class="keyword">final</span> ResTablePackage tablePackage = objectIO.read(ResTablePackage.class, tablePackageIndex);</span><br><span class="line"></span><br><span class="line">  System.out.println(<span class="string">&quot;table package type:&quot;</span>);</span><br><span class="line">  System.out.println(tablePackage);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 向下移动资源表元信息头部的大小。</span></span><br><span class="line">  mIndex += tablePackage.header.headerSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解析示例文件 resources_gdt1.arsc 的结果为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">=== RES_TABLE_PACKAGE_TYPE ===:</span><br><span class="line">table package type:</span><br><span class="line">&#123;header=&#123;type=512(RES_TABLE_PACKAGE_TYPE), headerSize=288, size=5152&#125;, id=0x7f000000, name=com.qq.e.demo, typeStrings=0, lastPublicType=0, keyStrings=0, lastPublicKey=0&#125;</span><br><span class="line"></span><br><span class="line">=== RES_STRING_POOL_TYPE (Type String Pool) ===:</span><br><span class="line">string pool header:</span><br><span class="line">&#123;header=&#123;type=1(RES_STRING_POOL_TYPE), headerSize=28, size=136&#125;, stringCount=9, styleCount=0, flags=256, stringStart=64, styleStart=0&#125;</span><br><span class="line"></span><br><span class="line">string index array:</span><br><span class="line">[&#123;index=0&#125;, &#123;index=7&#125;, &#123;index=18&#125;, &#123;index=27&#125;, &#123;index=35&#125;, &#123;index=43&#125;, &#123;index=52&#125;, &#123;index=60&#125;, &#123;index=67&#125;]</span><br><span class="line"></span><br><span class="line">style index array: []</span><br><span class="line"></span><br><span class="line">string pool:</span><br><span class="line">[attr, drawable, layout, color, dimen, string, style, menu, id]</span><br><span class="line"></span><br><span class="line">style pool: []</span><br><span class="line">style detail:</span><br><span class="line"></span><br><span class="line">=== RES_STRING_POOL_TYPE (Key String Pool) ===:</span><br><span class="line">string pool header:</span><br><span class="line">&#123;header=&#123;type=1(RES_STRING_POOL_TYPE), headerSize=28, size=1720&#125;, stringCount=76, styleCount=0, flags=256, stringStart=332, styleStart=0&#125;</span><br><span class="line"></span><br><span class="line">string index array:</span><br><span class="line">[&#123;index=0&#125;, &#123;index=17&#125;, &#123;index=40&#125;, &#123;index=48&#125;, &#123;index=58&#125;, &#123;index=67&#125;, &#123;index=82&#125;, &#123;index=90&#125;, &#123;index=117&#125;, &#123;index=124&#125;, &#123;index=142&#125;, &#123;index=165&#125;, &#123;index=187&#125;, &#123;index=215&#125;, &#123;index=236&#125;, &#123;index=257&#125;, &#123;index=275&#125;, &#123;index=292&#125;, &#123;index=308&#125;, &#123;index=337&#125;, &#123;index=364&#125;, &#123;index=375&#125;,  ... , &#123;index=1214&#125;, &#123;index=1234&#125;, &#123;index=1249&#125;, &#123;index=1265&#125;, &#123;index=1280&#125;, &#123;index=1301&#125;, &#123;index=1312&#125;, &#123;index=1324&#125;, &#123;index=1336&#125;, &#123;index=1350&#125;, &#123;index=1363&#125;, &#123;index=1373&#125;]</span><br><span class="line"></span><br><span class="line">style index array: []</span><br><span class="line"></span><br><span class="line">string pool:</span><br><span class="line">[buttonBarStyle, buttonBarButtonStyle, arrow, gdticon, gridbt, header_arrow, icon1, listview_item_background, logo, main_background, activity_banner_demo, activity_fullscreen, activity_gdtnativead_demo, activity_list_view, activity_main_demo, headercontainer, nativelistitem, ... , showBannerInListHeaderButton, destoryBtn, splashcontainer, btn_refresh, ad_container, list, showBannerButton, showInterstitialAdButton, showAppWallButton, splashButton, gdtnativeAdbt, imageButton1, headframecontainer, img_logo, text_name, text_desc, text_status, img_poster, divider, btn_download]</span><br><span class="line"></span><br><span class="line">style pool: []</span><br><span class="line">style detail:</span><br></pre></td></tr></table></figure>



<h3 id="parse-RES-TABLE-TYPE-SPEC-TYPE"><a href="#parse-RES-TABLE-TYPE-SPEC-TYPE" class="headerlink" title="parse RES_TABLE_TYPE_SPEC_TYPE"></a>parse RES_TABLE_TYPE_SPEC_TYPE</h3><p>类型规范数据块为了描述资源项的配置差异性，通过它可以了解到每类资源的配置情况。</p>
<p>类型规范数据块由 <code>ResTable_typeSpec</code> 数据结构描述，java 表示为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 类型规范数据块。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResTableTypeSpec</span> <span class="keyword">implements</span> <span class="title">Struct</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SPEC_PUBLIC = <span class="number">0x40000000</span>;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> ResChunkHeader#type&#125; = &#123;<span class="doctag">@link</span> ResourceTypes#RES_TABLE_TYPE_SPEC_TYPE&#125;</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> ResChunkHeader#headerSize&#125; = sizeOf(ResTableTypeSpec.class) 表示头部大小。</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> ResChunkHeader#size&#125; = header.headerSize + &#123;<span class="doctag">@link</span> Integer#BYTES&#125; * &#123;<span class="doctag">@link</span> #entryCount&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> ResChunkHeader header;</span><br><span class="line">  <span class="comment">/** 资源 Type ID */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">byte</span> id;</span><br><span class="line">  <span class="comment">/** 0，保留 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">byte</span> res0;</span><br><span class="line">  <span class="comment">/** 0，保留 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">short</span> res1;</span><br><span class="line">  <span class="comment">/** 本类型的资源项个数，即名称相同的资源项的个数 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> entryCount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中的 id 字段表示资源的类型 id，res0 和 res1 为固定的 0，entryCount 则为资源项的个数，在 ResTable_typeSpec 之后会有一个 int 型数组，来记录在哪些配置发生变化后，需要重新加载该资源。</p>
<p>配置项在 ResourceTypes.h 中有定义：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    CONFIG_MCC = ACONFIGURATION_MCC,</span><br><span class="line">    CONFIG_MNC = ACONFIGURATION_MNC,</span><br><span class="line">    CONFIG_LOCALE = ACONFIGURATION_LOCALE,</span><br><span class="line">    CONFIG_TOUCHSCREEN = ACONFIGURATION_TOUCHSCREEN,</span><br><span class="line">    CONFIG_KEYBOARD = ACONFIGURATION_KEYBOARD,</span><br><span class="line">    CONFIG_KEYBOARD_HIDDEN = ACONFIGURATION_KEYBOARD_HIDDEN,</span><br><span class="line">    CONFIG_NAVIGATION = ACONFIGURATION_NAVIGATION,</span><br><span class="line">    CONFIG_ORIENTATION = ACONFIGURATION_ORIENTATION,</span><br><span class="line">    CONFIG_DENSITY = ACONFIGURATION_DENSITY,</span><br><span class="line">    CONFIG_SCREEN_SIZE = ACONFIGURATION_SCREEN_SIZE,</span><br><span class="line">    CONFIG_SMALLEST_SCREEN_SIZE = ACONFIGURATION_SMALLEST_SCREEN_SIZE,</span><br><span class="line">    CONFIG_VERSION = ACONFIGURATION_VERSION,</span><br><span class="line">    CONFIG_SCREEN_LAYOUT = ACONFIGURATION_SCREEN_LAYOUT,</span><br><span class="line">    CONFIG_UI_MODE = ACONFIGURATION_UI_MODE,</span><br><span class="line">    CONFIG_LAYOUTDIR = ACONFIGURATION_LAYOUTDIR,</span><br><span class="line">    CONFIG_SCREEN_ROUND = ACONFIGURATION_SCREEN_ROUND,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>下面是解析过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ArscParser.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">(ObjectIO objectIO)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  ResChunkHeader header = objectIO.read(ResChunkHeader.class, mIndex);</span><br><span class="line">  <span class="keyword">switch</span> (header.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> ResourceTypes.RES_TABLE_TYPE_SPEC_TYPE:</span><br><span class="line">      parseTableTypeSpecType(objectIO);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ArscParser.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseTableTypeSpecType</span><span class="params">(ObjectIO objectIO)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">long</span> typeSpecIndex = mIndex;</span><br><span class="line">  ResTableTypeSpec tableTypeSpec = objectIO.read(ResTableTypeSpec.class, typeSpecIndex);</span><br><span class="line"></span><br><span class="line">  System.out.println(<span class="string">&quot;table type spec type:&quot;</span>);</span><br><span class="line">  System.out.println(tableTypeSpec);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span>[] entryArray = TableTypeChunkParser.parseSpecEntryArray(objectIO, tableTypeSpec, typeSpecIndex);</span><br><span class="line"></span><br><span class="line">  System.out.println();</span><br><span class="line">  System.out.println(<span class="string">&quot;table type spec type entry array:&quot;</span>);</span><br><span class="line">  System.out.println(Arrays.toString(entryArray));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 向下移动资源表类型规范内容的大小。</span></span><br><span class="line">  mIndex += tableTypeSpec.header.size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TableTypeChunkParser.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span>[] parseSpecEntryArray(ObjectIO objectIO, ResTableTypeSpec tableTypeSpec, <span class="keyword">long</span> typeSpecIndex)</span><br><span class="line">    <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  <span class="keyword">int</span>[] entryArray = <span class="keyword">new</span> <span class="keyword">int</span>[tableTypeSpec.entryCount];</span><br><span class="line">  <span class="keyword">long</span> index = typeSpecIndex + tableTypeSpec.header.headerSize;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; entryArray.length; i++) &#123;</span><br><span class="line">    entryArray[i] = objectIO.readInt(index);</span><br><span class="line">    index += Integer.BYTES;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> entryArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解析示例文件 resource_gdt1.arsc 的结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">table type spec type:</span><br><span class="line">&#123;header=&#123;type=514(RES_TABLE_TYPE_SPEC_TYPE), headerSize=16, size=24&#125;, id=0x01, res0=0, res1=0, entryCount=2&#125;</span><br><span class="line"></span><br><span class="line">table type spec type entry array:</span><br><span class="line">[0, 0]</span><br></pre></td></tr></table></figure>



<h3 id="parse-RES-TABLE-TYPE-TYPE"><a href="#parse-RES-TABLE-TYPE-TYPE" class="headerlink" title="parse RES_TABLE_TYPE_TYPE"></a>parse RES_TABLE_TYPE_TYPE</h3><p>最后是类型资源项数据块，它用来描述资源项的具体信息，通过它可以了解每一个资源项名称、值和配置等信息。类型资源项数据是按照类型和配置来组织的，也就是说，一个具有 N 个配置的类型一共对应有 N 个类型资源项数据块。</p>
<p>类型资源项数据块使用 <code>ResTable_type</code> 数据结构描述，java 表示为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 类型资源项数据块。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResTableType</span> <span class="keyword">implements</span> <span class="title">Struct</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NO_ENTRY = <span class="number">0xFFFFFFFF</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> ResChunkHeader#type&#125; = &#123;<span class="doctag">@link</span> ResourceTypes#RES_TABLE_TYPE_TYPE&#125;</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> ResChunkHeader#headerSize&#125; = sizeOf(ResTableType.class) 表示头部大小。</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> ResChunkHeader#size&#125; = header.headerSize + &#123;<span class="doctag">@link</span> Integer#BYTES&#125; * &#123;<span class="doctag">@link</span> #entryCount&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> ResChunkHeader header;</span><br><span class="line">  <span class="comment">/** 资源 Type ID */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">byte</span> id;</span><br><span class="line">  <span class="comment">/** 0，保留 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">byte</span> res0;</span><br><span class="line">  <span class="comment">/** 0，保留 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">short</span> res1;</span><br><span class="line">  <span class="comment">/** 本类型的资源项个数，即名称相同的资源项的个数 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> entryCount;</span><br><span class="line">  <span class="comment">/** 资源项数据块相对头部的偏移值 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> entriesStart;</span><br><span class="line">  <span class="comment">/** 描述配置信息 */</span></span><br><span class="line">  <span class="keyword">public</span> ResTableConfig tableConfig;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 <code>entryCount</code> 表示资源项的数量，<code>entriesStart</code> 表示数据块的其实位置字节偏移。</p>
<p><code>ResTableConfig</code> 描述了资源的配置信息，内部由多个 Union 联合体构成，由于代码过长，所以具体结构可参考项目源码。</p>
<p>每个资源项通过 <code>ResTable_entry</code> 数据结构描述，java 表示为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 资源项。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResTableEntry</span> <span class="keyword">implements</span> <span class="title">Struct</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_COMPLEX = <span class="number">0x0001</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_PUBLIC = <span class="number">0x0002</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** &#123;<span class="doctag">@link</span> #BYTES&#125; 资源项头部大小 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">short</span> size;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 资源项标志位。如果是一个 Bag 资源项，那么 FLAG_COMPLEX 位就等于 1，并且在 ResTable_entry 后面跟有一个 ResTable_map 数组，</span></span><br><span class="line"><span class="comment">   * 否则的话，在 ResTable_entry &#123;<span class="doctag">@link</span> ResTableEntry&#125; 后面跟的是一个 Res_value。如果是一个可以被引用的资源项，那么 FLAG_PUBLIC 位就等于1</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">short</span> flags;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 资源项名称在资源项名称字符串资源池的索引。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> ResStringPoolRef key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果其中的 <code>flags</code> 的 <code>FLAG_COMPLEX</code> 位为 1，那么这个 <code>struct ResTable_entry</code> 则是一个 <code>struct ResTable_map_entry</code> 类型，然后下面就会跟一个 <code>struct ResTable_map</code> 的数组。</p>
<p><code>struct ResTable_map_entry</code>  是 <code>struct ResTable_entry</code>  的子结构类型，java 表示为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResTableMapEntry</span> <span class="keyword">extends</span> <span class="title">ResTableEntry</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 指向父 ResTable_map_entry 的资源 ID，如果没有父 ResTable_map_entry，则等于 0。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> ResTableRef parent;</span><br><span class="line">  <span class="comment">/** bag 项的个数。 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ResTable_map 的 java 表示为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResTableMap</span> <span class="keyword">implements</span> <span class="title">Struct</span> </span>&#123;</span><br><span class="line">  <span class="comment">/** 引用资源地址 */</span></span><br><span class="line">  <span class="keyword">public</span> ResTableRef name;</span><br><span class="line">  <span class="comment">/** 资源值 */</span></span><br><span class="line">  <span class="keyword">public</span> ResValue value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ResValue</code> 对应数据结构 <code>struct Res_value</code>，它表示资源的具体数值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResValue</span> <span class="keyword">implements</span> <span class="title">Struct</span> </span>&#123;</span><br><span class="line">  <span class="comment">/** ResValue 值大小 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">short</span> size;</span><br><span class="line">  <span class="comment">/** 0, 保留 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">byte</span> res0;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 数据类型取值。</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">short</span> TYPE_NULL = <span class="number">0x00</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">short</span> TYPE_REFERENCE = <span class="number">0x01</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">short</span> TYPE_ATTRIBUTE = <span class="number">0x02</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">short</span> TYPE_STRING = <span class="number">0x03</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">short</span> TYPE_FLOAT = <span class="number">0x04</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">short</span> TYPE_DIMENSION = <span class="number">0x05</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">short</span> TYPE_FRACTION = <span class="number">0x06</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">short</span> TYPE_DYNAMIC_REFERENCE = <span class="number">0x07</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">short</span> TYPE_FIRST_INT = <span class="number">0x10</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">short</span> TYPE_INT_DEC = <span class="number">0x10</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">short</span> TYPE_INT_HEX = <span class="number">0x11</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">short</span> TYPE_INT_BOOLEAN = <span class="number">0x12</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">short</span> TYPE_FIRST_COLOR_INT = <span class="number">0x1c</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">short</span> TYPE_INT_COLOR_ARGB8 = <span class="number">0x1c</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">short</span> TYPE_INT_COLOR_RGB8 = <span class="number">0x1d</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">short</span> TYPE_INT_COLOR_ARGB4 = <span class="number">0x1e</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">short</span> TYPE_INT_COLOR_RGB4 = <span class="number">0x1f</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">short</span> TYPE_LAST_COLOR_INT = <span class="number">0x1f</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">short</span> TYPE_LAST_INT = <span class="number">0x1f</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** 数据类型 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">byte</span> dataType;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMPLEX_UNIT_SHIFT = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMPLEX_UNIT_MASK = <span class="number">0xf</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 数据类型描述。</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMPLEX_UNIT_PX = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMPLEX_UNIT_DIP = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMPLEX_UNIT_SP = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMPLEX_UNIT_PT = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMPLEX_UNIT_IN = <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMPLEX_UNIT_MM = <span class="number">5</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMPLEX_UNIT_FRACTION = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMPLEX_UNIT_FRACTION_PARENT = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMPLEX_RADIX_SHIFT = <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMPLEX_RADIX_MASK = <span class="number">0x3</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMPLEX_RADIX_23p0 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMPLEX_RADIX_16p7 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMPLEX_RADIX_8p15 = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMPLEX_RADIX_0p23 = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMPLEX_MANTISSA_SHIFT = <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMPLEX_MANTISSA_MASK = <span class="number">0xffffff</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DATA_NULL_UNDEFINED = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DATA_NULL_EMPTY = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** 数据 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> data;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将 dataType 翻译为字符串。</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> String <span class="title">dataTypeStr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (dataType) &#123;</span><br><span class="line">      <span class="keyword">case</span> TYPE_NULL:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;TYPE_NULL&quot;</span>;</span><br><span class="line">      <span class="keyword">case</span> TYPE_REFERENCE:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;TYPE_REFERENCE&quot;</span>;</span><br><span class="line">      <span class="keyword">case</span> TYPE_ATTRIBUTE:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;TYPE_ATTRIBUTE&quot;</span>;</span><br><span class="line">      <span class="keyword">case</span> TYPE_STRING:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;TYPE_STRING&quot;</span>;</span><br><span class="line">      <span class="keyword">case</span> TYPE_FLOAT:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;TYPE_FLOAT&quot;</span>;</span><br><span class="line">      <span class="keyword">case</span> TYPE_DIMENSION:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;TYPE_DIMENSION&quot;</span>;</span><br><span class="line">      <span class="keyword">case</span> TYPE_FRACTION:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;TYPE_FRACTION&quot;</span>;</span><br><span class="line">      <span class="keyword">case</span> TYPE_DYNAMIC_REFERENCE:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;TYPE_DYNAMIC_REFERENCE&quot;</span>;</span><br><span class="line">      <span class="comment">// case TYPE_FIRST_INT: return &quot;TYPE_FIRST_INT&quot;;</span></span><br><span class="line">      <span class="keyword">case</span> TYPE_INT_DEC:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;TYPE_INT_DEC&quot;</span>;</span><br><span class="line">      <span class="keyword">case</span> TYPE_INT_HEX:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;TYPE_INT_HEX&quot;</span>;</span><br><span class="line">      <span class="keyword">case</span> TYPE_INT_BOOLEAN:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;TYPE_INT_BOOLEAN&quot;</span>;</span><br><span class="line">      <span class="comment">// case TYPE_FIRST_COLOR_INT: return &quot;TYPE_FIRST_COLOR_INT&quot;;</span></span><br><span class="line">      <span class="keyword">case</span> TYPE_INT_COLOR_ARGB8:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;TYPE_INT_COLOR_ARGB8&quot;</span>;</span><br><span class="line">      <span class="keyword">case</span> TYPE_INT_COLOR_RGB8:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;TYPE_INT_COLOR_RGB8&quot;</span>;</span><br><span class="line">      <span class="keyword">case</span> TYPE_INT_COLOR_ARGB4:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;TYPE_INT_COLOR_ARGB4&quot;</span>;</span><br><span class="line">      <span class="keyword">case</span> TYPE_INT_COLOR_RGB4:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;TYPE_INT_COLOR_RGB4&quot;</span>;</span><br><span class="line">      <span class="comment">// case TYPE_LAST_COLOR_INT: return &quot;TYPE_LAST_COLOR_INT&quot;;</span></span><br><span class="line">      <span class="comment">// case TYPE_LAST_INT: return &quot;TYPE_LAST_INT&quot;;</span></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span> + dataType;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将值翻译为对应类型的</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">dataStr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (dataType) &#123;</span><br><span class="line">      <span class="keyword">case</span> TYPE_NULL:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;null&quot;</span>;</span><br><span class="line">      <span class="keyword">case</span> TYPE_REFERENCE:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;@&quot;</span> + Formatter.toHex(Formatter.fromInt(data, <span class="keyword">true</span>));</span><br><span class="line">      <span class="keyword">case</span> TYPE_ATTRIBUTE:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;@:id/&quot;</span> + Formatter.toHex(Formatter.fromInt(data, <span class="keyword">true</span>));</span><br><span class="line">      <span class="keyword">case</span> TYPE_STRING:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;stringPool[&quot;</span> + data + <span class="string">&#x27;]&#x27;</span>;</span><br><span class="line">      <span class="keyword">case</span> TYPE_FLOAT:</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(data);</span><br><span class="line">      <span class="keyword">case</span> TYPE_DIMENSION:</span><br><span class="line">        <span class="keyword">int</span> complex = data &amp; (COMPLEX_UNIT_MASK &lt;&lt; COMPLEX_UNIT_SHIFT);</span><br><span class="line">        <span class="keyword">switch</span> (complex) &#123;</span><br><span class="line">          <span class="keyword">case</span> COMPLEX_UNIT_PX:</span><br><span class="line">            <span class="keyword">return</span> data + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">          <span class="keyword">case</span> COMPLEX_UNIT_DIP:</span><br><span class="line">            <span class="keyword">return</span> data + <span class="string">&quot;dip&quot;</span>;</span><br><span class="line">          <span class="keyword">case</span> COMPLEX_UNIT_SP:</span><br><span class="line">            <span class="keyword">return</span> data + <span class="string">&quot;sp&quot;</span>;</span><br><span class="line">          <span class="keyword">case</span> COMPLEX_UNIT_PT:</span><br><span class="line">            <span class="keyword">return</span> data + <span class="string">&quot;pt&quot;</span>;</span><br><span class="line">          <span class="keyword">case</span> COMPLEX_UNIT_IN:</span><br><span class="line">            <span class="keyword">return</span> data + <span class="string">&quot;in&quot;</span>;</span><br><span class="line">          <span class="keyword">case</span> COMPLEX_UNIT_MM:</span><br><span class="line">            <span class="keyword">return</span> data + <span class="string">&quot;mm&quot;</span>;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> data + <span class="string">&quot;(dimension)&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">case</span> TYPE_FRACTION:</span><br><span class="line">        <span class="keyword">return</span> data + <span class="string">&quot;(fraction)&quot;</span>;</span><br><span class="line">      <span class="keyword">case</span> TYPE_DYNAMIC_REFERENCE:</span><br><span class="line">        <span class="keyword">return</span> data + <span class="string">&quot;(dynamic_reference)&quot;</span>;</span><br><span class="line">      <span class="comment">// case TYPE_FIRST_INT: return &quot;TYPE_FIRST_INT&quot;;</span></span><br><span class="line">      <span class="keyword">case</span> TYPE_INT_DEC:</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(data);</span><br><span class="line">      <span class="keyword">case</span> TYPE_INT_HEX:</span><br><span class="line">        <span class="keyword">return</span> Formatter.toHex(Formatter.fromInt(data, <span class="keyword">true</span>));</span><br><span class="line">      <span class="keyword">case</span> TYPE_INT_BOOLEAN:</span><br><span class="line">        <span class="keyword">return</span> data == <span class="number">0</span> ? <span class="string">&quot;false&quot;</span> : <span class="string">&quot;true&quot;</span>;</span><br><span class="line">      <span class="comment">// case TYPE_FIRST_COLOR_INT: return &quot;TYPE_FIRST_COLOR_INT&quot;;</span></span><br><span class="line">      <span class="keyword">case</span> TYPE_INT_COLOR_ARGB8:</span><br><span class="line">        <span class="keyword">return</span> data + <span class="string">&quot;(argb8)&quot;</span>;</span><br><span class="line">      <span class="keyword">case</span> TYPE_INT_COLOR_RGB8:</span><br><span class="line">        <span class="keyword">return</span> data + <span class="string">&quot;(rgb8)&quot;</span>;</span><br><span class="line">      <span class="keyword">case</span> TYPE_INT_COLOR_ARGB4:</span><br><span class="line">        <span class="keyword">return</span> data + <span class="string">&quot;(argb4)&quot;</span>;</span><br><span class="line">      <span class="keyword">case</span> TYPE_INT_COLOR_RGB4:</span><br><span class="line">        <span class="keyword">return</span> data + <span class="string">&quot;(rgb4)&quot;</span>;</span><br><span class="line">      <span class="comment">// case TYPE_LAST_COLOR_INT: return &quot;TYPE_LAST_COLOR_INT&quot;;</span></span><br><span class="line">      <span class="comment">// case TYPE_LAST_INT: return &quot;TYPE_LAST_INT&quot;;</span></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> Formatter.toHex(Formatter.fromInt(data, <span class="keyword">true</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解析过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ArscParser.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">(ObjectIO objectIO)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  ResChunkHeader header = objectIO.read(ResChunkHeader.class, mIndex);</span><br><span class="line">  <span class="keyword">switch</span> (header.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> ResourceTypes.RES_TABLE_TYPE_TYPE:</span><br><span class="line">      parseTableTypeType(arsc, header);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ArscParser.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseTableTypeType</span><span class="params">(ObjectIO objectIO)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">long</span> tableTypeIndex = mIndex;</span><br><span class="line">  <span class="keyword">final</span> ResTableType tableType = objectIO.read(ResTableType.class, tableTypeIndex);</span><br><span class="line"></span><br><span class="line">  System.out.println(<span class="string">&quot;table type type:&quot;</span>);</span><br><span class="line">  System.out.println(tableType);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span>[] offsetArray = TableTypeChunkParser.parseTypeOffsetArray(objectIO, tableType, tableTypeIndex);</span><br><span class="line"></span><br><span class="line">  System.out.println();</span><br><span class="line">  System.out.println(<span class="string">&quot;offset array:&quot;</span>);</span><br><span class="line">  System.out.println(Arrays.toString(offsetArray));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">long</span> tableEntryIndex = tableTypeIndex + tableType.entriesStart;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; offsetArray.length; i++) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> entryIndex = offsetArray[i] + tableEntryIndex;</span><br><span class="line">    <span class="keyword">final</span> ResTableEntry tableEntry = objectIO.read(ResTableEntry.class, entryIndex);</span><br><span class="line"></span><br><span class="line">    System.out.println();</span><br><span class="line">    System.out.println(<span class="string">&quot;table type type entry &quot;</span> + i + <span class="string">&quot;:&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;header: &quot;</span> + tableEntry);</span><br><span class="line">    System.out.println(<span class="string">&quot;entry name: &quot;</span> + typeStringPool[tableEntry.key.index]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tableEntry.flags == ResTableEntry.FLAG_COMPLEX) &#123;</span><br><span class="line">      <span class="comment">// parse ResTable_map</span></span><br><span class="line">      <span class="keyword">final</span> ResTableMapEntry tableMapEntry = objectIO.read(ResTableMapEntry.class, entryIndex);</span><br><span class="line"></span><br><span class="line">      System.out.println(tableMapEntry);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; tableMapEntry.count; j++) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> tableMapIndex = index + entryIndex + tableMapEntry.size;</span><br><span class="line"></span><br><span class="line">        ResTableMap tableMap = objectIO.read(ResTableMap.class, tableMapIndex);</span><br><span class="line">        System.out.println(<span class="string">&quot;table map &quot;</span> + j + <span class="string">&quot;:&quot;</span>);</span><br><span class="line">        System.out.println(tableMap);</span><br><span class="line"></span><br><span class="line">        index += ObjectIO.sizeOf(ResTableMap.class);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// parse Res_value</span></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">int</span> entrySize = ObjectIO.sizeOf(ResTableEntry.class);</span><br><span class="line">      <span class="keyword">final</span> ResValue value = objectIO.read(ResValue.class, entryIndex + entrySize);</span><br><span class="line"></span><br><span class="line">      System.out.println(value);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  mIndex = objectIO.size();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TableTypeChunkParser.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span>[] parseTypeOffsetArray(ObjectIO objectIO, ResTableType tableType, <span class="keyword">long</span> typeIndex)</span><br><span class="line">    <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  <span class="keyword">int</span>[] entryArray = <span class="keyword">new</span> <span class="keyword">int</span>[tableType.entryCount];</span><br><span class="line">  <span class="keyword">long</span> index = typeIndex + tableType.header.headerSize;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; entryArray.length; i++) &#123;</span><br><span class="line">    entryArray[i] = objectIO.readInt(index);</span><br><span class="line">    index += Integer.BYTES;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> entryArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例文件 resources_gdt1.arsc 的解析结果为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">table type type:</span><br><span class="line">&#123;header=&#123;type=<span class="number">513</span>(RES_TABLE_TYPE_TYPE), headerSize=<span class="number">68</span>, size=<span class="number">132</span>&#125;, id=<span class="number">0x01</span>, res0=<span class="number">0</span>, res1=<span class="number">0</span>, entryCount=<span class="number">2</span>, entriesStart=<span class="number">76</span>, config=&#123;size=<span class="number">48</span>, localeScript=    , localeVariant=        , mobile=&#123;data=Struct&#123;mcc=<span class="number">0</span>, mnc=<span class="number">0</span>&#125;, imsi=<span class="number">0</span>&#125;, locale=&#123;data=&#123;language=  , country=  &#125;, locale=<span class="number">0</span>&#125;, screenType=&#123;data=&#123;orientation=<span class="number">0</span>, touchscreen=<span class="number">0</span>, density=<span class="number">0</span>&#125;, screenType=<span class="number">0</span>&#125;, input=&#123;data=&#123;keyboard=<span class="number">0</span>, navigation=<span class="number">0</span>, inputFlags=<span class="number">0</span>, inputPad0=<span class="number">0</span>&#125;, input=<span class="number">0</span>&#125;, screenSize=&#123;data=&#123;screenWidth=<span class="number">0</span>, screenHeight=<span class="number">0</span>&#125;, screenSize=<span class="number">0</span>&#125;, version=&#123;data=&#123;sdkVersion=<span class="number">0</span>, minorVersion=<span class="number">0</span>&#125;, screenSize=<span class="number">0</span>&#125;, screenConfig=&#123;data=&#123;screenLayout=<span class="number">0</span>, uiMode=<span class="number">0</span>, screenConfigPad1=<span class="number">0</span>, screenConfigPad2=<span class="number">0</span>&#125;, screenConfig=<span class="number">0</span>&#125;, screenSizeDp=&#123;data=&#123;screenWidth=<span class="number">0</span>, screenHeight=<span class="number">0</span>&#125;, screenSizeDp=<span class="number">0</span>&#125;, screenConfig2=&#123;data=&#123;screenLayout2=<span class="number">0</span>, screenConfigPad1=<span class="number">0</span>, screenConfigPad2=<span class="number">0</span>&#125;, screenConfig2=<span class="number">0</span>&#125;&#125;&#125;</span><br><span class="line"></span><br><span class="line">offset array:</span><br><span class="line">[<span class="number">0</span>, <span class="number">28</span>]</span><br><span class="line"></span><br><span class="line">table type type entry <span class="number">0</span>:</span><br><span class="line">header: &#123;size=<span class="number">16</span>, flags=<span class="number">1</span>, key=&#123;index=<span class="number">0</span>&#125;&#125;</span><br><span class="line">entry name: buttonBarStyle</span><br><span class="line">&#123;parent=&#123;ident=<span class="number">0x00000000</span>&#125;, count=<span class="number">1</span>, size=<span class="number">16</span>, flags=<span class="number">1</span>, key=&#123;index=<span class="number">0</span>&#125;&#125;</span><br><span class="line">table map <span class="number">0</span>:</span><br><span class="line">&#123;name=&#123;ident=<span class="number">0x01000000</span>&#125;, value=&#123;size=<span class="number">8</span>, res0=<span class="number">0</span>, dataType=TYPE_INT_DEC, data=<span class="number">1</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">table type type entry <span class="number">1</span>:</span><br><span class="line">header: &#123;size=<span class="number">16</span>, flags=<span class="number">1</span>, key=&#123;index=<span class="number">1</span>&#125;&#125;</span><br><span class="line">entry name: buttonBarButtonStyle</span><br><span class="line">&#123;parent=&#123;ident=<span class="number">0x00000000</span>&#125;, count=<span class="number">1</span>, size=<span class="number">16</span>, flags=<span class="number">1</span>, key=&#123;index=<span class="number">1</span>&#125;&#125;</span><br><span class="line">table map <span class="number">0</span>:</span><br><span class="line">&#123;name=&#123;ident=<span class="number">0x01000000</span>&#125;, value=&#123;size=<span class="number">8</span>, res0=<span class="number">0</span>, dataType=TYPE_INT_DEC, data=<span class="number">1</span>&#125;&#125;</span><br></pre></td></tr></table></figure>



<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><p><a target="_blank" rel="noopener" href="https://github.com/l0neman/program-notes/tree/master/android-notes-reverse/project/android_arsc_parse">ArscParser</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/luoshengyang/article/details/8744683">Android应用程序资源的编译和打包过程分析</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/fourbrother/parse_androidarsc">https://github.com/fourbrother/parse_androidarsc</a> </p>
</li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>Android arsc 文件解析</p><p><a href="https://l0neman.github.io/2019/02/14/android-arsc-文件解析/">https://l0neman.github.io/2019/02/14/android-arsc-文件解析/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>l0neman</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2019-02-14</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2019-02-14</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/android/">Android</a><a class="link-muted mr-2" rel="tag" href="/tags/aapt/">aapt</a></div><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5f0f12c19a2af379" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/qrcode/alipay.jpg" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/qrcode/wxpay.jpg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2019/04/08/android-binder-%E8%AE%BE%E8%AE%A1%E5%88%86%E6%9E%90/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Android Binder 设计分析</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2019/02/12/android-view-%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E6%9C%BA%E5%88%B6/"><span class="level-item">Android View 事件分发机制</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><script src="https://utteranc.es/client.js" repo="l0neman/l0neman.github.io" issue-term="pathname" label="comment" theme="github-light" crossorigin="anonymous" async></script></div></div></div><!--!--><div class="column column-right  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#apk-文件结构"><span class="level-left"><span class="level-item">1</span><span class="level-item">apk 文件结构</span></span></a></li><li><a class="level is-mobile" href="#资源编译过程"><span class="level-left"><span class="level-item">2</span><span class="level-item">资源编译过程</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-Parse-AndroidManifst-xml"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">1. Parse AndroidManifst.xml</span></span></a></li><li><a class="level is-mobile" href="#2-Add-Included-Resources"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">2. Add Included Resources</span></span></a></li><li><a class="level is-mobile" href="#3-Collection-Resource-Files"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">3. Collection Resource Files</span></span></a></li><li><a class="level is-mobile" href="#4-Add-Resources-to-Resource-Table"><span class="level-left"><span class="level-item">2.4</span><span class="level-item">4. Add Resources to Resource Table</span></span></a></li><li><a class="level is-mobile" href="#5-Compile-Values-Resources"><span class="level-left"><span class="level-item">2.5</span><span class="level-item">5. Compile Values Resources</span></span></a></li><li><a class="level is-mobile" href="#6-Assign-Resource-ID-to-Bag"><span class="level-left"><span class="level-item">2.6</span><span class="level-item">6. Assign Resource ID to Bag</span></span></a></li><li><a class="level is-mobile" href="#7-Compile-Xml-Resources"><span class="level-left"><span class="level-item">2.7</span><span class="level-item">7. Compile Xml Resources</span></span></a></li><li><a class="level is-mobile" href="#8-Add-Resource-Symbols"><span class="level-left"><span class="level-item">2.8</span><span class="level-item">8. Add Resource Symbols</span></span></a></li><li><a class="level is-mobile" href="#9-Write-resource-arsc"><span class="level-left"><span class="level-item">2.9</span><span class="level-item">9. Write resource.arsc</span></span></a></li><li><a class="level is-mobile" href="#10-Compile-AndroidManifest-xml"><span class="level-left"><span class="level-item">2.10</span><span class="level-item">10. Compile AndroidManifest.xml</span></span></a></li><li><a class="level is-mobile" href="#11-Write-R-java"><span class="level-left"><span class="level-item">2.11</span><span class="level-item">11. Write R.java</span></span></a></li><li><a class="level is-mobile" href="#12-Write-APK"><span class="level-left"><span class="level-item">2.12</span><span class="level-item">12. Write APK</span></span></a></li></ul></li><li><a class="level is-mobile" href="#arsc-文件结构"><span class="level-left"><span class="level-item">3</span><span class="level-item">arsc 文件结构</span></span></a></li><li><a class="level is-mobile" href="#arsc-文件解析"><span class="level-left"><span class="level-item">4</span><span class="level-item">arsc 文件解析</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#解析方法"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">解析方法</span></span></a></li><li><a class="level is-mobile" href="#parse-RES-TABLE-TYPE"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">parse RES_TABLE_TYPE</span></span></a></li><li><a class="level is-mobile" href="#parse-RES-STRING-POOL-TYPE"><span class="level-left"><span class="level-item">4.3</span><span class="level-item">parse RES_STRING_POOL_TYPE</span></span></a></li><li><a class="level is-mobile" href="#parse-RES-TABLE-PACKAGE-TYPE"><span class="level-left"><span class="level-item">4.4</span><span class="level-item">parse RES_TABLE_PACKAGE_TYPE</span></span></a></li><li><a class="level is-mobile" href="#parse-RES-TABLE-TYPE-SPEC-TYPE"><span class="level-left"><span class="level-item">4.5</span><span class="level-item">parse RES_TABLE_TYPE_SPEC_TYPE</span></span></a></li><li><a class="level is-mobile" href="#parse-RES-TABLE-TYPE-TYPE"><span class="level-left"><span class="level-item">4.6</span><span class="level-item">parse RES_TABLE_TYPE_TYPE</span></span></a></li></ul></li><li><a class="level is-mobile" href="#源码"><span class="level-left"><span class="level-item">5</span><span class="level-item">源码</span></span></a></li><li><a class="level is-mobile" href="#参考"><span class="level-left"><span class="level-item">6</span><span class="level-item">参考</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/android-%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">Android 实用工具</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/android-%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/"><span class="level-start"><span class="level-item">Android 应用开发</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/categories/android-%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/"><span class="level-start"><span class="level-item">Android 系统原理</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/android-%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/"><span class="level-start"><span class="level-item">Android 逆向工程</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3/"><span class="level-start"><span class="level-item">参考文档</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">实用工具</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/"><span class="level-start"><span class="level-item">编程基础</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-11-14T16:18:50.000Z">2021-11-15</time></p><p class="title"><a href="/2021/11/15/staruml-%E7%A0%B4%E8%A7%A3%E6%96%B9%E6%B3%95/">StarUML 破解方法</a></p><p class="categories"><a href="/categories/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/">实用工具</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-11-14T15:59:06.000Z">2021-11-14</time></p><p class="title"><a href="/2021/11/14/android-filter-%E5%88%86%E6%9E%90/">Android Filter 分析</a></p><p class="categories"><a href="/categories/android-%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/">Android 应用开发</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-06-29T16:45:50.000Z">2021-06-30</time></p><p class="title"><a href="/2021/06/30/%E6%94%AF%E6%8C%81%E8%A7%A6%E6%91%B8%E6%8B%96%E5%8A%A8%E7%9A%84-touchdelegate/">支持触摸拖动的 TouchDelegate</a></p><p class="categories"><a href="/categories/android-%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/">Android 应用开发</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-21T15:08:15.000Z">2021-04-21</time></p><p class="title"><a href="/2021/04/21/gdb-arm-%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">GDB ARM 交叉编译环境搭建</a></p><p class="categories"><a href="/categories/android-%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/">Android 实用工具</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-21T15:04:39.000Z">2021-04-21</time></p><p class="title"><a href="/2021/04/21/dropbear-android-%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4/">Dropbear Android 安装步骤</a></p><p class="categories"><a href="/categories/android-%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/">Android 实用工具</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">十一月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">四月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/02/"><span class="level-start"><span class="level-item">二月 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/arm/"><span class="tag">ARM</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/avd/"><span class="tag">AVD</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/activity/"><span class="tag">Activity</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/android/"><span class="tag">Android</span><span class="tag">24</span></a></div><div class="control"><a class="tags has-addons" href="/tags/assembly/"><span class="tag">Assembly</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/binder/"><span class="tag">Binder</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/classloader/"><span class="tag">ClassLoader</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/computer/"><span class="tag">Computer</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dex/"><span class="tag">Dex</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/elf/"><span class="tag">ELF</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/emulator/"><span class="tag">Emulator</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">Git</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/jni/"><span class="tag">JNI</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/java/"><span class="tag">Java</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/log/"><span class="tag">Log</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/make/"><span class="tag">Make</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/makefile/"><span class="tag">Makefile</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/markdown/"><span class="tag">MarkDown</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/metrial/"><span class="tag">Metrial</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ndk/"><span class="tag">NDK</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/regex/"><span class="tag">Regex</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssh/"><span class="tag">SSH</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/theme/"><span class="tag">Theme</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/touch/"><span class="tag">Touch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/view/"><span class="tag">View</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xposed/"><span class="tag">Xposed</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zygote/"><span class="tag">Zygote</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/aapt/"><span class="tag">aapt</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/uml/"><span class="tag">uml</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%83%AD%E4%BF%AE%E5%A4%8D/"><span class="tag">热修复</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%83%AD%E6%9B%B4%E6%96%B0/"><span class="tag">热更新</span><span class="tag">1</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="l0neman 的博客" height="28"></a><p class="is-size-7"><span>&copy; 2021 l0neman</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/l0neman"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>